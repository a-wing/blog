<?xml version="1.0" encoding="utf-8"?><feed xmlns="http://www.w3.org/2005/Atom" xml:lang="zh_CN"><generator uri="https://jekyllrb.com/" version="3.7.4">Jekyll</generator><link href="https://a-wing.top/feed.xml" rel="self" type="application/atom+xml" /><link href="https://a-wing.top/" rel="alternate" type="text/html" hreflang="zh_CN" /><updated>2020-06-08T05:46:44+00:00</updated><id>https://a-wing.top/feed.xml</id><title type="html">Hi! 上天不?</title><subtitle>新一的个人博客</subtitle><entry><title type="html">modbus 协议初体验</title><link href="https://a-wing.top/mcu/2020/05/23/modbus.html" rel="alternate" type="text/html" title="modbus 协议初体验" /><published>2020-05-23T09:00:00+00:00</published><updated>2020-05-23T09:00:00+00:00</updated><id>https://a-wing.top/mcu/2020/05/23/modbus</id><content type="html" xml:base="https://a-wing.top/mcu/2020/05/23/modbus.html">&lt;p&gt;最近被拉去支援硬件部分，又写了几天对接嵌入式的上位机程序 &lt;code class=&quot;highlighter-rouge&quot;&gt;_(ˊཀˋ」∠)_&lt;/code&gt;&lt;/p&gt;

&lt;p&gt;和下位机通信是用 modbus 协议的。趁机学习了一下这个上古协议。（奇怪的知识又增加了&lt;/p&gt;

&lt;p&gt;modbus 是用 &lt;code class=&quot;highlighter-rouge&quot;&gt;req/res&lt;/code&gt; 的模式来通信的。和 http 是一样的，如果要拿传感器信息只能轮询&lt;/p&gt;

&lt;p&gt;关于 modbus 协议的一大特点，就是支持设备并连，可以通过一个串口控制最多 256 个设备（每次发送请求时要发送目标地址）&lt;/p&gt;

&lt;p&gt;由于 &lt;code class=&quot;highlighter-rouge&quot;&gt;modbus.org&lt;/code&gt; 不支持 https 。所以就不放标准文档的连接了（迫真，上古协议）&lt;/p&gt;

&lt;p&gt;以这个读取状态的请求为例 &lt;code class=&quot;highlighter-rouge&quot;&gt;03 (0x03) Read Holding Registers&lt;/code&gt;&lt;/p&gt;

&lt;table&gt;
  &lt;thead&gt;
    &lt;tr&gt;
      &lt;th&gt;Name&lt;/th&gt;
      &lt;th&gt;Length&lt;/th&gt;
      &lt;th&gt;Value&lt;/th&gt;
    &lt;/tr&gt;
  &lt;/thead&gt;
  &lt;tbody&gt;
    &lt;tr&gt;
      &lt;td&gt;Function code&lt;/td&gt;
      &lt;td&gt;1 Byte&lt;/td&gt;
      &lt;td&gt;0x03&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;Starting Address&lt;/td&gt;
      &lt;td&gt;2 Bytes&lt;/td&gt;
      &lt;td&gt;0x0000 to 0xFFFF&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;Quantity of Registers&lt;/td&gt;
      &lt;td&gt;2 Bytes&lt;/td&gt;
      &lt;td&gt;1 to 125 (0x7D)&lt;/td&gt;
    &lt;/tr&gt;
  &lt;/tbody&gt;
&lt;/table&gt;

&lt;p&gt;每个请求要有 &lt;code class=&quot;highlighter-rouge&quot;&gt;Function code&lt;/code&gt; 字段。用到的 &lt;code class=&quot;highlighter-rouge&quot;&gt;Function code&lt;/code&gt; 是有标准的定义的。（当然是可以不按照标准实现）&lt;/p&gt;

&lt;p&gt;当然不同的 &lt;code class=&quot;highlighter-rouge&quot;&gt;Function code&lt;/code&gt; 对应的参数也不同。&lt;/p&gt;

&lt;p&gt;这个协议的读写是直接写到对应地址里的。&lt;/p&gt;

&lt;p&gt;比如有一个地址为 &lt;code class=&quot;highlighter-rouge&quot;&gt;0x01&lt;/code&gt; 的存温度，地址为 &lt;code class=&quot;highlighter-rouge&quot;&gt;0x02&lt;/code&gt; 存湿度&lt;/p&gt;

&lt;p&gt;由于这两个地址是连续的。可以一口气全部读出来&lt;/p&gt;

&lt;h2 id=&quot;我们先来发送一个-0x03-的请求&quot;&gt;我们先来发送一个 &lt;code class=&quot;highlighter-rouge&quot;&gt;0x03&lt;/code&gt; 的请求&lt;/h2&gt;

&lt;p&gt;当然 &lt;code class=&quot;highlighter-rouge&quot;&gt;Starting Address&lt;/code&gt; 是 &lt;code class=&quot;highlighter-rouge&quot;&gt;0x01&lt;/code&gt;，&lt;code class=&quot;highlighter-rouge&quot;&gt;Quantity of Registers&lt;/code&gt; 是 &lt;code class=&quot;highlighter-rouge&quot;&gt;0x02&lt;/code&gt;（一共读两个: &lt;code class=&quot;highlighter-rouge&quot;&gt;0x01&lt;/code&gt; 和 &lt;code class=&quot;highlighter-rouge&quot;&gt;0x02&lt;/code&gt;）&lt;/p&gt;

&lt;p&gt;然后请求转换成这样一段东西：&lt;code class=&quot;highlighter-rouge&quot;&gt;['0x03', '0x00', '0x01', '0x00', '0x02']&lt;/code&gt; （我应该不用解释这一串是怎么生成的吧。。。）&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;这个叫 &lt;code class=&quot;highlighter-rouge&quot;&gt;pdu&lt;/code&gt; （Protocol Data Unit）也就是 &lt;code class=&quot;highlighter-rouge&quot;&gt;Function code&lt;/code&gt; 加上 &lt;code class=&quot;highlighter-rouge&quot;&gt;Function code&lt;/code&gt; 对应的 &lt;code class=&quot;highlighter-rouge&quot;&gt;Data&lt;/code&gt;&lt;/strong&gt;&lt;/p&gt;

&lt;p&gt;之后把 &lt;code class=&quot;highlighter-rouge&quot;&gt;pdu&lt;/code&gt; emmmmm 。之后分成多种情况。这个和你的传输方式有关。modbus 可以使用&lt;code class=&quot;highlighter-rouge&quot;&gt;RTU&lt;/code&gt;（串口传输）也可以使用 &lt;code class=&quot;highlighter-rouge&quot;&gt;TCP&lt;/code&gt; 来传输。&lt;/p&gt;

&lt;p&gt;如果是 &lt;code class=&quot;highlighter-rouge&quot;&gt;RTU&lt;/code&gt; 传输，加入目标地址，加入 crc 校验字段，然后就可以直接发送出去了&lt;/p&gt;

&lt;table&gt;
  &lt;thead&gt;
    &lt;tr&gt;
      &lt;th&gt;Name&lt;/th&gt;
      &lt;th&gt;Value&lt;/th&gt;
    &lt;/tr&gt;
  &lt;/thead&gt;
  &lt;tbody&gt;
    &lt;tr&gt;
      &lt;td&gt;Slave Address&lt;/td&gt;
      &lt;td&gt;1 byte&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;Function&lt;/td&gt;
      &lt;td&gt;1 byte&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;Data&lt;/td&gt;
      &lt;td&gt;0 up to 252 bytes&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;CRC&lt;/td&gt;
      &lt;td&gt;2 byte&lt;/td&gt;
    &lt;/tr&gt;
  &lt;/tbody&gt;
&lt;/table&gt;

&lt;p&gt;如果使用 &lt;code class=&quot;highlighter-rouge&quot;&gt;TCP&lt;/code&gt; 就多出了很多字段&lt;/p&gt;

&lt;table&gt;
  &lt;thead&gt;
    &lt;tr&gt;
      &lt;th&gt;Name&lt;/th&gt;
      &lt;th&gt;Value&lt;/th&gt;
    &lt;/tr&gt;
  &lt;/thead&gt;
  &lt;tbody&gt;
    &lt;tr&gt;
      &lt;td&gt;Transaction identifier&lt;/td&gt;
      &lt;td&gt;2 bytes&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;Protocol identifier&lt;/td&gt;
      &lt;td&gt;2 bytes&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;Length&lt;/td&gt;
      &lt;td&gt;2 bytes&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;Unit identifier&lt;/td&gt;
      &lt;td&gt;1 byte&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;Function code&lt;/td&gt;
      &lt;td&gt;1 byte&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;Data&lt;/td&gt;
      &lt;td&gt;n bytes&lt;/td&gt;
    &lt;/tr&gt;
  &lt;/tbody&gt;
&lt;/table&gt;

&lt;p&gt;modbus 也就这点东西了，其实没什么。&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/goburrow/modbus&quot;&gt;我使用 golang 的库来使用 modbus&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;modbus 还可以的。就是，如果个厂商能按照 modbus 标准来实现就好了（我写的时候，坑人的硬件厂商没有按照 modbus 标准实现）&lt;/p&gt;

&lt;p&gt;这协议要是支持订阅某个地址的值，然后当数值变化的时候自动推送消息就好了（设置个最小推送时间间隔，这样就可以不用轮询了）&lt;/p&gt;</content><author><name>metal A-wing</name></author><summary type="html">最近被拉去支援硬件部分，又写了几天对接嵌入式的上位机程序 _(ˊཀˋ」∠)_</summary><media:thumbnail xmlns:media="http://search.yahoo.com/mrss/" url="https://a-wing.top/assets/avatar.png" /><media:content medium="image" url="https://a-wing.top/assets/avatar.png" xmlns:media="http://search.yahoo.com/mrss/" /></entry><entry><title type="html">自制旁路网关（三） ——nftables 来做透明代理</title><link href="https://a-wing.top/network/2020/03/07/bypass_gateway-3_nftables.html" rel="alternate" type="text/html" title="自制旁路网关（三） ——nftables 来做透明代理" /><published>2020-03-07T04:00:00+00:00</published><updated>2020-03-07T04:00:00+00:00</updated><id>https://a-wing.top/network/2020/03/07/bypass_gateway-3_nftables</id><content type="html" xml:base="https://a-wing.top/network/2020/03/07/bypass_gateway-3_nftables.html">&lt;p&gt;本以为这篇文章会写的很长，因为笔记上还有好多内容。不过博客不能是笔记，把最核心的地方用最简单的话提炼出来，尽可能让所有人能看懂才算是一篇好文章&lt;/p&gt;

&lt;p&gt;今天或许是个好日子，&lt;a href=&quot;https://zh.wikipedia.org/wiki/%E5%A5%B3%E7%94%9F%E8%8A%82&quot;&gt;三月七号女生节&lt;/a&gt;。我决定今天把这个系列的坑填上，就当作给所有女孩子的礼物了（大雾）&lt;/p&gt;

&lt;p&gt;为什要使用 nftables 来分流而不用，clash 的分流。如果你了解零拷贝实现，你就会了解为什么这样做。不了解也没关系，记住结论 &lt;code class=&quot;highlighter-rouge&quot;&gt;nftables&lt;/code&gt; 分流性能更高一些&lt;/p&gt;

&lt;p&gt;不过那个&lt;code class=&quot;highlighter-rouge&quot;&gt;nftables&lt;/code&gt; 性能高只是理论上的。实际上我并没有做过 &lt;code class=&quot;highlighter-rouge&quot;&gt;benchmarks&lt;/code&gt; 。可能实际情况也刚好相反。（也欢迎那个较真的杠精来做下 &lt;code class=&quot;highlighter-rouge&quot;&gt;benchmarks&lt;/code&gt; 来证明一下）&lt;/p&gt;

&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c&quot;&gt;# 挂上socks 代理下的大概快一点&lt;/span&gt;
curl &lt;span class=&quot;nt&quot;&gt;--socks5&lt;/span&gt; localhost:7891 &lt;span class=&quot;s1&quot;&gt;'http://ftp.apnic.net/apnic/stats/apnic/delegated-apnic-latest'&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; raw


&lt;span class=&quot;c&quot;&gt;# 制作 nftables 的配置文件，先生成个第一行&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;define chnroute_list = {&quot;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; chnroute.nft

&lt;span class=&quot;c&quot;&gt;# 提取国内的地址追加写入配置&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;cat &lt;/span&gt;raw | &lt;span class=&quot;nb&quot;&gt;grep &lt;/span&gt;ipv4 | &lt;span class=&quot;nb&quot;&gt;grep &lt;/span&gt;CN | &lt;span class=&quot;nb&quot;&gt;awk&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-F&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\|&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'{ printf(&quot;%s/%d\n&quot;, $4, 32-log($5)/log(2)) }'&lt;/span&gt; | &lt;span class=&quot;nb&quot;&gt;sed &lt;/span&gt;s/&lt;span class=&quot;nv&quot;&gt;$/&lt;/span&gt;,/g &lt;span class=&quot;o&quot;&gt;&amp;gt;&amp;gt;&lt;/span&gt; chnroute.nft

&lt;span class=&quot;c&quot;&gt;# 写个尾部&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;}&quot;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;&amp;gt;&lt;/span&gt; chnroute.nft

&lt;span class=&quot;c&quot;&gt;# 放到该放的位置&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;cp &lt;/span&gt;chnroute.nft /etc/nftables/chnroute.nft
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;再来修改配置文件 &lt;code class=&quot;highlighter-rouge&quot;&gt;/etc/nftables.conf&lt;/code&gt;&lt;/p&gt;

&lt;p&gt;这个地方接上一篇 &lt;a href=&quot;/network/2020/02/22/bypass_gateway-1_clash.html&quot;&gt;自制旁路网关（一） ——使用clash做代理&lt;/a&gt; 的 nftables 部分&lt;/p&gt;

&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c&quot;&gt;#!/usr/sbin/nft -f&lt;/span&gt;
flush ruleset

include &lt;span class=&quot;s2&quot;&gt;&quot;/etc/nftables/private.nft&quot;&lt;/span&gt;
include &lt;span class=&quot;s2&quot;&gt;&quot;/etc/nftables/chnroute.nft&quot;&lt;/span&gt;

table ip nat &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
  chain proxy &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
    ip daddr &lt;span class=&quot;nv&quot;&gt;$private_list&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;return
    &lt;/span&gt;ip daddr &lt;span class=&quot;nv&quot;&gt;$chnroute_list&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;return
    &lt;/span&gt;ip protocol tcp redirect to :7892
  &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
  chain prerouting &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;nb&quot;&gt;type &lt;/span&gt;nat hook prerouting priority 0&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; policy accept&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    goto proxy
  &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;nft flush ruleset&lt;/code&gt; 可以写在文件里，不用担心语法错误会把规则清空（这个我实际测试过）。nftables 的配置是 “事务型规则更新” （了解关系型数据库的人应该知道我在说什么）&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;细心的朋友可能会发现我在上一篇文章中用的是 &lt;code class=&quot;highlighter-rouge&quot;&gt;jump&lt;/code&gt;&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;关于 &lt;code class=&quot;highlighter-rouge&quot;&gt;goto&lt;/code&gt; 和 &lt;code class=&quot;highlighter-rouge&quot;&gt;jump&lt;/code&gt; 指令是有区别的。我觉得这里用 &lt;code class=&quot;highlighter-rouge&quot;&gt;goto&lt;/code&gt; 更好一些 &lt;a href=&quot;https://wiki.nftables.org/wiki-nftables/index.php/Jumping_to_chain&quot;&gt;官方文档讲的很清楚应该不用我再翻译一遍 jump vs goto&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;然后重新载入配置文件 &lt;code class=&quot;highlighter-rouge&quot;&gt;nft -f /etc/nftables.conf&lt;/code&gt;&lt;/p&gt;

&lt;h4 id=&quot;做完这些如果你发现国内网站全上不去了&quot;&gt;做完这些如果你发现国内网站全上不去了&lt;/h4&gt;
&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c&quot;&gt;# 看看这些个显示的是 0 还是 1&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# 默认是 0 不启用 ip_forward&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;cat&lt;/span&gt; /proc/sys/net/ipv4/ip_forward

&lt;span class=&quot;c&quot;&gt;# 手动打开&lt;/span&gt;
sysctl &lt;span class=&quot;nt&quot;&gt;-w&lt;/span&gt; net.ipv4.ip_forward&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;1

&lt;span class=&quot;c&quot;&gt;# 你也可以这样来打开&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;echo &lt;/span&gt;1 &lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; /proc/sys/net/ipv4/ip_forward
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;不过长期的稳定的办法是修改 &lt;code class=&quot;highlighter-rouge&quot;&gt;/etc/sysctl.conf&lt;/code&gt; 的 &lt;code class=&quot;highlighter-rouge&quot;&gt;net.ipv4.ip_forward=1&lt;/code&gt;&lt;/p&gt;

&lt;p&gt;然后 &lt;code class=&quot;highlighter-rouge&quot;&gt;sysctl -p&lt;/code&gt; 载入&lt;/p&gt;

&lt;h3 id=&quot;后记&quot;&gt;后记&lt;/h3&gt;
&lt;p&gt;如果国外走 udp 。也是同理，只是要用 tproxy，或者 tun 设备（虚线一个网卡）&lt;/p&gt;

&lt;p&gt;真是没想到，我竟然更完了这个系列&lt;/p&gt;

&lt;h3 id=&quot;本系列文章&quot;&gt;本系列文章：&lt;/h3&gt;
&lt;ol&gt;
  &lt;li&gt;这应该算是第零篇，建议先看这篇 &lt;a href=&quot;/linux/2019/04/01/debian_network.html&quot;&gt;细说 Debian 的网络管理 network/interfaces&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;/network/2020/02/22/bypass_gateway-1_clash.html&quot;&gt;自制旁路网关（一） ——使用clash做代理&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;/network/2020/02/28/bypass_gateway-1-1_subscription.html&quot;&gt;自制旁路网关（一点一） ——增加clash订阅功能&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;/network/2020/03/01/bypass_gateway-2_improve_dns.html&quot;&gt;自制旁路网关（二） ——用unbound和smartdns来优化dns服务&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;自制旁路网关（三） ——nftables 来做透明代理 (本篇)&lt;/li&gt;
&lt;/ol&gt;

&lt;h2 id=&quot;参考文章&quot;&gt;参考文章&lt;/h2&gt;

&lt;p&gt;&lt;a href=&quot;https://typeblog.net/10650/archlinux-shadowsocks-iptables-ipset&quot;&gt;在 ArchLinux 上配置 shadowsocks + iptables + ipset 实现自动分流&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://64mb.org/2018/12/24/linux-on-m8-01/&quot;&gt; Linux on m8 第一篇、网络配置&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://omicron3069.com/post/nftablesfornode/&quot;&gt;nftables 上手小记&lt;/a&gt;&lt;/p&gt;</content><author><name>metal A-wing</name></author><summary type="html">本以为这篇文章会写的很长，因为笔记上还有好多内容。不过博客不能是笔记，把最核心的地方用最简单的话提炼出来，尽可能让所有人能看懂才算是一篇好文章</summary><media:thumbnail xmlns:media="http://search.yahoo.com/mrss/" url="https://a-wing.top/assets/avatar.png" /><media:content medium="image" url="https://a-wing.top/assets/avatar.png" xmlns:media="http://search.yahoo.com/mrss/" /></entry><entry><title type="html">自制旁路网关（二） ——用unbound和smartdns来优化dns服务</title><link href="https://a-wing.top/network/2020/03/01/bypass_gateway-2_improve_dns.html" rel="alternate" type="text/html" title="自制旁路网关（二） ——用unbound和smartdns来优化dns服务" /><published>2020-03-01T14:00:00+00:00</published><updated>2020-03-01T14:00:00+00:00</updated><id>https://a-wing.top/network/2020/03/01/bypass_gateway-2_improve_dns</id><content type="html" xml:base="https://a-wing.top/network/2020/03/01/bypass_gateway-2_improve_dns.html">&lt;p&gt;今天是三月一日，我应该昨天更新，因为昨天是四年一度的二月二十九日。错过了了个好日子 T_T 。不过没关系，今天还是一年一次的三月一号那（&lt;/p&gt;

&lt;p&gt;先来回顾一下 dns 查询会遇到那些问题&lt;/p&gt;

&lt;ol&gt;
  &lt;li&gt;运营商 dns 基本上是最快的，但可能有污染&lt;/li&gt;
  &lt;li&gt;国内公共 dns ，国内地址准确，但未必最快，国外有污染&lt;/li&gt;
  &lt;li&gt;出口节点运营商 dns ，国外地址准确，速度基本最快&lt;/li&gt;
  &lt;li&gt;国外公共 dns ，国外地址准确，但未必快&lt;/li&gt;
  &lt;li&gt;国外网站可能有国内地址的 cdn ，cdn 最快&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;我们先把国内外分开查询，然后再汇总&lt;/p&gt;

&lt;p&gt;使用 smartdns 来查询国内，只用公共 dns ，（smartdns 可以测速并返回你的位置最快的地址）&lt;/p&gt;

&lt;p&gt;国内外 dns 该如何进行分流？有一个很重要的问题是国外网站有国内 cdn&lt;/p&gt;

&lt;p&gt;基于 geo-ip 来分流查询，查到固定国家或特色网段的地址时，不使用这个结果（大陆白名单就是这种）&lt;/p&gt;

&lt;p&gt;基于域名 GFWlist 是把被墙掉的域名收集起来做成一个数据库&lt;/p&gt;

&lt;h3 id=&quot;究极方案-icplist&quot;&gt;究极方案 ICPlist:&lt;/h3&gt;

&lt;p&gt;我还没见过有这么干的，不过这才是一劳永逸的办法，用于大陆法律的问题 ICP 你懂的，不过这个数据库可以反过来利用（只要在 icp 清单可以认为在大陆一定有服务器）&lt;/p&gt;

&lt;p&gt;不过最大的问题是这个库过于庞大。。。绝大部分你都是永远都不会用的地址&lt;/p&gt;

&lt;p&gt;国外的可以分成两种情况&lt;/p&gt;
&lt;ol&gt;
  &lt;li&gt;出口固定（比如你自建的服务）&lt;/li&gt;
  &lt;li&gt;出口不确定（比如使用机场）&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;出口固定的情况很好解决，这里不做考虑（你自己在出口节点上建一个 dns 服务，然后加密传回来就行了）&lt;/p&gt;

&lt;p&gt;出口不确定，你不知道运营商 dns 只能把查询请求给代理，保佑能给你返回个快的地址&lt;/p&gt;

&lt;h1 id=&quot;目前我用的方案&quot;&gt;目前我用的方案&lt;/h1&gt;

&lt;p&gt;使用 &lt;code class=&quot;highlighter-rouge&quot;&gt;unbound&lt;/code&gt; 来做主 dns 服务（其实用什么都无所谓 coredns 也可以）&lt;/p&gt;

&lt;p&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;smartdns&lt;/code&gt; 来查询国内的 dns （我设成 5351 端口）&lt;/p&gt;

&lt;p&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;clash&lt;/code&gt; 来查询国外的 dns （我设成 5352 端口）&lt;/p&gt;

&lt;p&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;dnsmasq-china-list&lt;/code&gt; 的规则来分流国内外&lt;/p&gt;

&lt;h3 id=&quot;smartdns&quot;&gt;smartdns&lt;/h3&gt;
&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;wget https://github.com/pymumu/smartdns/releases/download/Release28/smartdns.1.2019.12.15-1028.arm-debian-all.deb
dpkg &lt;span class=&quot;nt&quot;&gt;-i&lt;/span&gt; smartdns.1.2019.12.15-1028.arm-debian-all.deb

systemctl start smartdns.service
systemctl &lt;span class=&quot;nb&quot;&gt;enable &lt;/span&gt;smartdns.service
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;这个没啥说的，按官方文档的说法，就多些几个上游 dns 地址 &lt;a href=&quot;https://dns.iui.im/&quot;&gt;从这里挑几个看着顺眼的写上就行&lt;/a&gt;&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;smartdns有测速机制，在配置上游服务器时，建议配置多个上游DNS服务器，包含多个不同区域的服务器，但总数建议在10个左右&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h3 id=&quot;unbound&quot;&gt;unbound&lt;/h3&gt;
&lt;p&gt;这个直接从源里安装就行 &lt;code class=&quot;highlighter-rouge&quot;&gt;apt install unbound&lt;/code&gt;&lt;/p&gt;

&lt;p&gt;不过这个源里的 &lt;code class=&quot;highlighter-rouge&quot;&gt;unbound&lt;/code&gt;， DD (Debian Developer) 定制了一点东西&lt;/p&gt;
&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nb&quot;&gt;sudo &lt;/span&gt;systemctl &lt;span class=&quot;nb&quot;&gt;cat &lt;/span&gt;unbound
&lt;span class=&quot;c&quot;&gt;# /lib/systemd/system/unbound.service&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;Unit]
&lt;span class=&quot;nv&quot;&gt;Description&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;Unbound DNS server
&lt;span class=&quot;nv&quot;&gt;Documentation&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;man:unbound&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;8&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;After&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;network.target
&lt;span class=&quot;nv&quot;&gt;Before&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;nss-lookup.target
&lt;span class=&quot;nv&quot;&gt;Wants&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;nss-lookup.target

&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;Service]
&lt;span class=&quot;nv&quot;&gt;Type&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;notify
&lt;span class=&quot;nv&quot;&gt;Restart&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;on-failure
&lt;span class=&quot;nv&quot;&gt;EnvironmentFile&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;-/etc/default/unbound
&lt;span class=&quot;nv&quot;&gt;ExecStartPre&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;-/usr/lib/unbound/package-helper chroot_setup
&lt;span class=&quot;nv&quot;&gt;ExecStartPre&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;-/usr/lib/unbound/package-helper root_trust_anchor_update
&lt;span class=&quot;nv&quot;&gt;ExecStart&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;/usr/sbin/unbound &lt;span class=&quot;nt&quot;&gt;-d&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$DAEMON_OPTS&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;ExecReload&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;/usr/sbin/unbound-control reload
&lt;span class=&quot;nv&quot;&gt;PIDFile&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;/run/unbound.pid

&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;Install]
&lt;span class=&quot;nv&quot;&gt;WantedBy&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;multi-user.target
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;这里有两个 hook 的脚本。Debian Developer 对这个定制了点东西，先把他禁用掉&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;&lt;strong&gt;凡是DD (Debian Developer) 打包时自己定制的功能一律禁用掉&lt;/strong&gt;&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;顺着那个 hook 去这个文件里 &lt;code class=&quot;highlighter-rouge&quot;&gt;/usr/lib/unbound/package-helper&lt;/code&gt;&lt;/p&gt;

&lt;p&gt;可以找到这样一段&lt;/p&gt;
&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c&quot;&gt;# Override these variables by editing or creating /etc/default/unbound.&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;RESOLVCONF&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;true&quot;&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;ROOT_TRUST_ANCHOR_UPDATE&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;true&quot;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;之后自己建个 &lt;code class=&quot;highlighter-rouge&quot;&gt;/etc/default/unbound&lt;/code&gt; 把那个功能关掉&lt;/p&gt;
&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nb&quot;&gt;cat&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; /etc/default/unbound &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;EOF&lt;/span&gt;&lt;span class=&quot;sh&quot;&gt;
# 这个默认会修改 /etc/resolv.conf 文件，设成 false 禁用掉
RESOLVCONF=&quot;false&quot;

# 这个我也不知道具体是干什么的，反正是 DD (Debian Developer) 自己搞出来东西，直接禁用就行 ╮(￣▽￣)╭
ROOT_TRUST_ANCHOR_UPDATE=&quot;false&quot;
&lt;/span&gt;&lt;span class=&quot;no&quot;&gt;EOF
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;然后去修改 &lt;code class=&quot;highlighter-rouge&quot;&gt;/etc/unbound/unbound.conf&lt;/code&gt;&lt;/p&gt;
&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;server:
    verbosity: 1
    num-threads: 2
    interface: 0.0.0.0@53
    &lt;span class=&quot;k&quot;&gt;do&lt;/span&gt;&lt;span class=&quot;nt&quot;&gt;-ip4&lt;/span&gt;: &lt;span class=&quot;nb&quot;&gt;yes
    &lt;/span&gt;&lt;span class=&quot;k&quot;&gt;do&lt;/span&gt;&lt;span class=&quot;nt&quot;&gt;-udp&lt;/span&gt;: &lt;span class=&quot;nb&quot;&gt;yes
    &lt;/span&gt;&lt;span class=&quot;k&quot;&gt;do&lt;/span&gt;&lt;span class=&quot;nt&quot;&gt;-tcp&lt;/span&gt;: no
    &lt;span class=&quot;k&quot;&gt;do&lt;/span&gt;&lt;span class=&quot;nt&quot;&gt;-not-query-localhost&lt;/span&gt;: no &lt;span class=&quot;c&quot;&gt;# 这句很关键，不把这个关掉上游 dns 不能用本地的 dns 服务&lt;/span&gt;
    access-control: 0.0.0.0/0 allow
    local-data: &lt;span class=&quot;s2&quot;&gt;&quot;test.com. A 192.168.1.1&quot;&lt;/span&gt;
    include: &lt;span class=&quot;s2&quot;&gt;&quot;/etc/unbound/unbound.conf.d/accelerated-domains.china.unbound.conf&quot;&lt;/span&gt;
    include: &lt;span class=&quot;s2&quot;&gt;&quot;/etc/unbound/unbound.conf.d/apple.china.unbound.conf&quot;&lt;/span&gt;
    include: &lt;span class=&quot;s2&quot;&gt;&quot;/etc/unbound/unbound.conf.d/google.china.unbound.conf&quot;&lt;/span&gt;
    forward-zone:
    	name: &lt;span class=&quot;s2&quot;&gt;&quot;.&quot;&lt;/span&gt;
    	forward-addr: 127.0.0.1@5352
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;之后把 &lt;code class=&quot;highlighter-rouge&quot;&gt;include&lt;/code&gt; 的文件放进去&lt;/p&gt;

&lt;h3 id=&quot;dnsmasq-china-list&quot;&gt;dnsmasq-china-list&lt;/h3&gt;
&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;git clone https://github.com/felixonmars/dnsmasq-china-list.git &lt;span class=&quot;nt&quot;&gt;--depth&lt;/span&gt; 1
&lt;span class=&quot;nb&quot;&gt;cd &lt;/span&gt;dnsmasq-china-list
make &lt;span class=&quot;nv&quot;&gt;SERVER&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;127.0.0.1@5351 unbound
&lt;span class=&quot;nb&quot;&gt;cp&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;*&lt;/span&gt;unbound.conf /etc/unbound/unbound.conf.d/
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;最后&quot;&gt;最后&lt;/h2&gt;
&lt;p&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;clash&lt;/code&gt; 的配置去看我前几篇文章&lt;/p&gt;

&lt;p&gt;最好别忘了 &lt;code class=&quot;highlighter-rouge&quot;&gt;systemctl restart unbound&lt;/code&gt;&lt;/p&gt;

&lt;p&gt;排查文件直接用 &lt;code class=&quot;highlighter-rouge&quot;&gt;dig&lt;/code&gt;, &lt;code class=&quot;highlighter-rouge&quot;&gt;nslookup&lt;/code&gt; 这个软件 debian 是在 &lt;code class=&quot;highlighter-rouge&quot;&gt;dnsutils&lt;/code&gt; 这个包里&lt;/p&gt;

&lt;h2 id=&quot;参考文章&quot;&gt;参考文章&lt;/h2&gt;

&lt;p&gt;&lt;a href=&quot;https://blog.phoenixlzx.com/2016/04/27/better-dns-with-unbound/&quot;&gt;使用 Unbound 搭建更好用的 DNS 服务器&lt;/a&gt;&lt;/p&gt;</content><author><name>metal A-wing</name></author><summary type="html">今天是三月一日，我应该昨天更新，因为昨天是四年一度的二月二十九日。错过了了个好日子 T_T 。不过没关系，今天还是一年一次的三月一号那（</summary><media:thumbnail xmlns:media="http://search.yahoo.com/mrss/" url="https://a-wing.top/assets/avatar.png" /><media:content medium="image" url="https://a-wing.top/assets/avatar.png" xmlns:media="http://search.yahoo.com/mrss/" /></entry><entry><title type="html">自制旁路网关（一点一） ——增加clash订阅功能</title><link href="https://a-wing.top/network/2020/02/28/bypass_gateway-1-1_subscription.html" rel="alternate" type="text/html" title="自制旁路网关（一点一） ——增加clash订阅功能" /><published>2020-02-28T14:00:00+00:00</published><updated>2020-02-28T14:00:00+00:00</updated><id>https://a-wing.top/network/2020/02/28/bypass_gateway-1-1_subscription</id><content type="html" xml:base="https://a-wing.top/network/2020/02/28/bypass_gateway-1-1_subscription.html">&lt;p&gt;说起来也惭愧，因为觉得自己维护线路太麻烦，所以买了机场的服务，不过要使用机场，肯定要配合订阅来一起食用&lt;/p&gt;

&lt;p&gt;订阅功能原理：本质上就是访问一个带 token 的 url。所以直接去 &lt;code class=&quot;highlighter-rouge&quot;&gt;curl&lt;/code&gt; 那个地址就可以拿到配置文件&lt;/p&gt;

&lt;p&gt;本文是接上一篇文章&lt;a href=&quot;/network/2020/02/22/bypass_gateway-1_clash.html&quot;&gt;自制旁路网关（一） ——使用clash做代理&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;其实就是定时去获取最新配置，从配置文件中取出自己需要的内容，然后重新加载配置文件（订阅到的配置可能不是你都需要的，只需要提取你需要的字段）&lt;/p&gt;

&lt;p&gt;我用的是 n3ro.host（我并没有收广告费，n3ro 请打钱） 。。是基于 SSPanel 的机场，使用的是 clash 的订阅&lt;/p&gt;

&lt;p&gt;先写一个核心文件用于处理配置文件，去更新关键性的字段。（这一步请自行判断自家使用的机场，订阅的配置文件内容）&lt;/p&gt;

&lt;p&gt;你可以用这种方式来更新配置&lt;/p&gt;
&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nb&quot;&gt;cat &lt;/span&gt;config.yaml | &lt;span class=&quot;nb&quot;&gt;head&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-32&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; result.yaml &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; curl &lt;span class=&quot;s1&quot;&gt;'&amp;lt;Your Subscription Address&amp;gt;'&lt;/span&gt; | &lt;span class=&quot;nb&quot;&gt;grep &lt;/span&gt;Proxy: &lt;span class=&quot;nt&quot;&gt;-A&lt;/span&gt; 1000 &lt;span class=&quot;o&quot;&gt;&amp;gt;&amp;gt;&lt;/span&gt; result.yaml &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;cp &lt;/span&gt;result.yaml config.yaml
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;不过这种方法极为不靠谱，不去理解配置文件语义，只靠行和关键字匹配，自己用好像没什么问题&lt;/p&gt;

&lt;p&gt;我还是觉得理解配置文件并从中提取关键字段来更新的方法更好&lt;/p&gt;

&lt;p&gt;先把这个服务命名为 subladder（不要吐槽命名）&lt;/p&gt;

&lt;p&gt;创建文件&lt;code class=&quot;highlighter-rouge&quot;&gt;/etc/clash/subladder.rb&lt;/code&gt;&lt;/p&gt;
&lt;div class=&quot;language-ruby highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c1&quot;&gt;#!/usr/bin/env ruby&lt;/span&gt;
&lt;span class=&quot;c1&quot;&gt;# Author: Metal A-wing&lt;/span&gt;
&lt;span class=&quot;c1&quot;&gt;# E-mail: 1@233.email&lt;/span&gt;
&lt;span class=&quot;c1&quot;&gt;# Create: 2020.02.22&lt;/span&gt;
&lt;span class=&quot;c1&quot;&gt;# Update: 2020.02.22&lt;/span&gt;

&lt;span class=&quot;nb&quot;&gt;require&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'yaml'&lt;/span&gt;

&lt;span class=&quot;n&quot;&gt;raw&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;YAML&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;load_file&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;no&quot;&gt;ENV&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'SOURCE_REMOTE'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;||&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'remote.yaml'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;config&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;YAML&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;load_file&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;no&quot;&gt;ENV&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'SOURCE_CONFIG'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;||&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'config.yaml'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;

&lt;span class=&quot;n&quot;&gt;update_whitelist&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;Proxy&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;Proxy Group&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;Rule&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;

&lt;span class=&quot;n&quot;&gt;update_whitelist&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;each&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;do&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;white&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;|&lt;/span&gt;
	&lt;span class=&quot;n&quot;&gt;config&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;white&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;raw&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;white&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;

&lt;span class=&quot;no&quot;&gt;File&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;open&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;no&quot;&gt;ENV&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'RESULT_CONFIG'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;||&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'result.yaml'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'w'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;|&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;f&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;f&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;write&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;config&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;to_yaml&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;预留里一下可配置的项。&lt;/p&gt;

&lt;h4 id=&quot;肯定会有人有些这样的疑问&quot;&gt;&lt;strong&gt;肯定会有人有些这样的疑问&lt;/strong&gt;&lt;/h4&gt;

&lt;ol&gt;
  &lt;li&gt;为什么要用 ruby 去实现这个功能？
    &lt;blockquote&gt;
      &lt;p&gt;&lt;strong&gt;老子想用什么语言就用什么语言，不服自己来写，我尽可能把这个处理脚本写的简单易懂&lt;/strong&gt;&lt;/p&gt;

      &lt;p&gt;很多语言 yaml 处理是使用第三方库来处理&lt;/p&gt;
    &lt;/blockquote&gt;
  &lt;/li&gt;
  &lt;li&gt;为什么不用 ruby 获取配置文件？
    &lt;blockquote&gt;
      &lt;p&gt;单独的文件处理应该是对整体无害的。只负责处理并生成的新的配置文件就够了&lt;/p&gt;
    &lt;/blockquote&gt;
  &lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;这里我们把配置用的字段统一提取放到一个新文件里 &lt;code class=&quot;highlighter-rouge&quot;&gt;/etc/clash/subladder.conf&lt;/code&gt;&lt;/p&gt;
&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c&quot;&gt;# 订阅地址&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;ADDRESS&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;https://nnn3ro.link/link/&amp;lt;Your Token&amp;gt;&quot;&lt;/span&gt;

&lt;span class=&quot;c&quot;&gt;# 订阅的源文件缓存的文件名。被更新的字段来源的文件&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;SOURCE_REMOTE&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;remote.yaml&quot;&lt;/span&gt;

&lt;span class=&quot;c&quot;&gt;# clash 实际加载的配置文件。（以这个文件为基本配置文件，去更新关键的字段）&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;SOURCE_CONFIG&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;config.yaml&quot;&lt;/span&gt;

&lt;span class=&quot;c&quot;&gt;# 处理后的文件，更新了关键字段的结果文件&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;RESULT_CONFIG&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;result.yaml&quot;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;然后添加一个 systemd 单元的配置文件
&lt;code class=&quot;highlighter-rouge&quot;&gt;/etc/systemd/system/subladder.service&lt;/code&gt;&lt;/p&gt;

&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;Unit]
&lt;span class=&quot;nv&quot;&gt;Description&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;Subscription Remote Configuration
&lt;span class=&quot;nv&quot;&gt;After&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;network.target

&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;Service]
&lt;span class=&quot;nv&quot;&gt;Type&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;oneshot
&lt;span class=&quot;nv&quot;&gt;WorkingDirectory&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;/etc/clash/
&lt;span class=&quot;nv&quot;&gt;EnvironmentFile&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;/etc/clash/subladder.conf
&lt;span class=&quot;nv&quot;&gt;ExecStartPre&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;/usr/bin/curl &lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;ADDRESS&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-o&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;SOURCE_REMOTE&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;ExecStart&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;/usr/bin/ruby subladder.rb
&lt;span class=&quot;nv&quot;&gt;ExecStartPost&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;/bin/sh &lt;span class=&quot;nt&quot;&gt;-c&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;cp &lt;/span&gt;&lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;SOURCE_REMOTE&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt; backup &amp;amp;&amp;amp; cp &lt;/span&gt;&lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;RESULT_CONFIG&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt; &lt;/span&gt;&lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;SOURCE_CONFIG&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt; &amp;amp;&amp;amp; systemctl restart clash.service&quot;&lt;/span&gt;

&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;Install]
&lt;span class=&quot;nv&quot;&gt;WantedBy&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;multi-user.target
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;这个文件我不想解释了。应该都能读懂&lt;/p&gt;

&lt;p&gt;简单的说就是用 curl 去获取订阅到的配置文件，然后生成自己需要的配置文件，备份原来的配置，更新并重启&lt;/p&gt;

&lt;p&gt;最后使用使用 systemd.timer 来定时执行任务 &lt;code class=&quot;highlighter-rouge&quot;&gt;/etc/systemd/system/subladder.timer&lt;/code&gt;&lt;/p&gt;
&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;Unit]
&lt;span class=&quot;nv&quot;&gt;Description&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;Run Subladder Daily

&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;Timer]
&lt;span class=&quot;c&quot;&gt;#OnCalendar=daily&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;OnCalendar&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;*&lt;/span&gt;-&lt;span class=&quot;k&quot;&gt;*&lt;/span&gt;-&lt;span class=&quot;k&quot;&gt;*&lt;/span&gt; 04:00:00
&lt;span class=&quot;nv&quot;&gt;RandomizedDelaySec&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;60m

&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;Install]
&lt;span class=&quot;nv&quot;&gt;WantedBy&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;timers.target
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;为什么不使用 &lt;code class=&quot;highlighter-rouge&quot;&gt;OnCalendar=daily&lt;/code&gt; 。。。这个会在每天零点更新，实际测试的结果是：零点更新会失败，可能机场本身会在零点定时跑什么服务&lt;/p&gt;

&lt;p&gt;然后启用这个定时器 &lt;code class=&quot;highlighter-rouge&quot;&gt;systemctl enable subladder.timer&lt;/code&gt;&lt;/p&gt;

&lt;p&gt;可以用这个来查看定时执行状态 &lt;code class=&quot;highlighter-rouge&quot;&gt;systemctl list-timers&lt;/code&gt;&lt;/p&gt;</content><author><name>metal A-wing</name></author><summary type="html">说起来也惭愧，因为觉得自己维护线路太麻烦，所以买了机场的服务，不过要使用机场，肯定要配合订阅来一起食用</summary><media:thumbnail xmlns:media="http://search.yahoo.com/mrss/" url="https://a-wing.top/assets/avatar.png" /><media:content medium="image" url="https://a-wing.top/assets/avatar.png" xmlns:media="http://search.yahoo.com/mrss/" /></entry><entry><title type="html">自制旁路网关（一） ——使用clash做代理</title><link href="https://a-wing.top/network/2020/02/22/bypass_gateway-1_clash.html" rel="alternate" type="text/html" title="自制旁路网关（一） ——使用clash做代理" /><published>2020-02-22T14:00:00+00:00</published><updated>2020-02-22T14:00:00+00:00</updated><id>https://a-wing.top/network/2020/02/22/bypass_gateway-1_clash</id><content type="html" xml:base="https://a-wing.top/network/2020/02/22/bypass_gateway-1_clash.html">&lt;p&gt;由于武汉新冠肺炎（&lt;a href=&quot;https://zh.wikipedia.org/wiki/2019%E5%86%A0%E7%8A%B6%E7%97%85%E6%AF%92%E7%97%85&quot;&gt;COVID-19&lt;/a&gt;）的关系，我被困在老家，自从我买了 ac68u 之后基本上就再也没折腾过网。由于长期在家办公，需要好的网络，还好手里有树莓派，还有 nas。只能使用传统技能（时代变化还真实快，一觉醒来工具链全变了）&lt;/p&gt;

&lt;p&gt;这次优化网路的经历我准备写一个系列（预计三篇文章：代理，dns，分流增强）。我也不知道能不能写完，也说不定后面两篇文章会咕掉&lt;/p&gt;

&lt;h4 id=&quot;实际上并没有咕掉而且还多写了一篇本系列文章&quot;&gt;&lt;strong&gt;实际上并没有咕掉，而且还多写了一篇。本系列文章：&lt;/strong&gt;&lt;/h4&gt;
&lt;ol&gt;
  &lt;li&gt;这应该算是第零篇，建议先看这篇 &lt;a href=&quot;/linux/2019/04/01/debian_network.html&quot;&gt;细说 Debian 的网络管理 network/interfaces&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;自制旁路网关（一） ——使用clash做代理 (本篇)&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;/network/2020/02/28/bypass_gateway-1-1_subscription.html&quot;&gt;自制旁路网关（一点一） ——增加clash订阅功能&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;/network/2020/03/01/bypass_gateway-2_improve_dns.html&quot;&gt;自制旁路网关（二） ——用unbound和smartdns来优化dns服务&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;/network/2020/03/07/bypass_gateway-3_nftables.html&quot;&gt;自制旁路网关（三） ——nftables 来做透明代理&lt;/a&gt;&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;&lt;strong&gt;不可否认，我省略了一些过于基础的细节，但本文的确是从我的笔记上摘录的&lt;/strong&gt;&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;本系列用到的代码都在 Raspbian GNU/Linux 10 (buster) 上验证过，请放心食用&lt;/strong&gt;&lt;/p&gt;

&lt;p&gt;代理软件使用 clash ，这个软件的特色就是他的分流功能和自动选择节点&lt;/p&gt;

&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c&quot;&gt;# 我是树莓 pi3b 请根据cpu架构选择合适的二进制包&lt;/span&gt;
wget https://github.com/Dreamacro/clash/releases/download/v0.17.1/clash-linux-armv7-v0.17.1.gz
&lt;span class=&quot;nb&quot;&gt;gzip&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-d&lt;/span&gt; clash-linux-armv7-v0.17.1.gz
&lt;span class=&quot;nb&quot;&gt;install&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-Dm755&lt;/span&gt; clash-linux-armv7-v0.17.1 /usr/local/bin/clash

&lt;span class=&quot;c&quot;&gt;# 把 clash 配置目录放在 /etc 目录下&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;mkdir&lt;/span&gt; /etc/clash/
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;创建一个本地的 systemd 配置&lt;code class=&quot;highlighter-rouge&quot;&gt;/etc/systemd/system/clash.service&lt;/code&gt;&lt;/p&gt;

&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;Unit]
&lt;span class=&quot;nv&quot;&gt;Description&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;clash service
&lt;span class=&quot;nv&quot;&gt;After&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;network.target

&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;Service]
&lt;span class=&quot;nv&quot;&gt;Type&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;simple
&lt;span class=&quot;nv&quot;&gt;ExecStart&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;/usr/local/bin/clash &lt;span class=&quot;nt&quot;&gt;-d&lt;/span&gt; /etc/clash/
&lt;span class=&quot;nv&quot;&gt;Restart&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;on-failure

&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;Install]
&lt;span class=&quot;nv&quot;&gt;WantedBy&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;multi-user.target
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;systemctl start clash.service
systemctl &lt;span class=&quot;nb&quot;&gt;enable &lt;/span&gt;clash.service

&lt;span class=&quot;c&quot;&gt;# 然后测试下 socks 代理是否可用&lt;/span&gt;
curl &lt;span class=&quot;nt&quot;&gt;--socks5&lt;/span&gt; localhost:7891 google.com
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;clash 里面其实内置了 dns 服务器的，这个默认是关闭的（clash 配置文件的官方文档写的够细了，只是藏的比较隐蔽）&lt;/p&gt;

&lt;div class=&quot;language-yaml highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;na&quot;&gt;dns&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
  &lt;span class=&quot;na&quot;&gt;enable&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;true&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;# set true to enable dns (default is false)&lt;/span&gt;
  &lt;span class=&quot;na&quot;&gt;ipv6&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;false&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;# default is false&lt;/span&gt;
  &lt;span class=&quot;na&quot;&gt;listen&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;0.0.0.0:53&lt;/span&gt;
  &lt;span class=&quot;c1&quot;&gt;# default-nameserver: # resolve dns nameserver host, should fill pure IP&lt;/span&gt;
  &lt;span class=&quot;c1&quot;&gt;#   - 114.114.114.114&lt;/span&gt;
  &lt;span class=&quot;c1&quot;&gt;#   - 8.8.8.8&lt;/span&gt;
  &lt;span class=&quot;na&quot;&gt;enhanced-mode&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;redir-host&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;# or fake-ip&lt;/span&gt;
  &lt;span class=&quot;c1&quot;&gt;# fake-ip-range: 198.18.0.1/16 # if you don't know what it is, don't change it&lt;/span&gt;
  &lt;span class=&quot;na&quot;&gt;fake-ip-filter&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;*.lan'&lt;/span&gt;
    &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;localhost.ptlogin2.qq.com&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;关于 fake-ip 功能，请出门左转去 &lt;a href=&quot;https://blog.skk.moe/post/alternate-surge-koolclash-as-gateway/&quot;&gt;苏卡卡的 使用 KoolClash 作为代理网关&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;然后我们再给 clash 加个 UI，这个 webUI 没有提供预编译版本，要自行编译&lt;/p&gt;

&lt;p&gt;其实我觉得这个 UI 没啥用&lt;/p&gt;
&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;wget https://github.com/Dreamacro/clash-dashboard/archive/v0.3.0.tar.gz
&lt;span class=&quot;nb&quot;&gt;tar&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-xzf&lt;/span&gt; v0.3.0.tar.gz
&lt;span class=&quot;nb&quot;&gt;cd &lt;/span&gt;clash-dashboard-0.3.0/
npm &lt;span class=&quot;nb&quot;&gt;install
&lt;/span&gt;npm run build

&lt;span class=&quot;c&quot;&gt;# 把编译结果上传到你的 clash 服务端。。。。因为我是在自己电脑上编译的&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;tar&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-cJf&lt;/span&gt; - dist/ | ssh &amp;lt;username&amp;gt;@&amp;lt;&lt;span class=&quot;nb&quot;&gt;hostname&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'tar -xJf -'&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;cp&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-r&lt;/span&gt; dist /etc/clash/dashboard
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;然后来修改 clash 配置，webUI 相关的有这几项&lt;/p&gt;
&lt;div class=&quot;language-yaml highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c1&quot;&gt;# RESTful API for clash&lt;/span&gt;
&lt;span class=&quot;na&quot;&gt;external-controller&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;127.0.0.1:9090&lt;/span&gt;

&lt;span class=&quot;c1&quot;&gt;# 这个地方写编译成静态资源的路径，可以是相对路径或绝对路径 然后用扩展配置的地址 (`external-controller`) + /ui 访问&lt;/span&gt;
&lt;span class=&quot;c1&quot;&gt;# 例如：http://127.0.0.1:9090/ui&lt;/span&gt;
&lt;span class=&quot;na&quot;&gt;external-ui&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;dashboard&lt;/span&gt;

&lt;span class=&quot;c1&quot;&gt;# Secret for RESTful API (Optional)&lt;/span&gt;
&lt;span class=&quot;c1&quot;&gt;# secret: &quot;&quot;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h3 id=&quot;我个人是不推荐旁路网关自身流量也走透明代理&quot;&gt;我个人是不推荐旁路网关自身流量也走透明代理&lt;/h3&gt;

&lt;p&gt;使用 iptable 来转发流量&lt;/p&gt;
&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;iptables &lt;span class=&quot;nt&quot;&gt;-t&lt;/span&gt; nat &lt;span class=&quot;nt&quot;&gt;-N&lt;/span&gt; CLASH

&lt;span class=&quot;c&quot;&gt;# 私有 ip 流量不转发，完整的在下面&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# 设置的 fake-ip 请注意检查这里&lt;/span&gt;
iptables &lt;span class=&quot;nt&quot;&gt;-t&lt;/span&gt; nat &lt;span class=&quot;nt&quot;&gt;-A&lt;/span&gt; CLASH &lt;span class=&quot;nt&quot;&gt;-d&lt;/span&gt; 192.168.0.0/16 &lt;span class=&quot;nt&quot;&gt;-j&lt;/span&gt; RETURN

iptables &lt;span class=&quot;nt&quot;&gt;-t&lt;/span&gt; nat &lt;span class=&quot;nt&quot;&gt;-A&lt;/span&gt; CLASH &lt;span class=&quot;nt&quot;&gt;-p&lt;/span&gt; tcp &lt;span class=&quot;nt&quot;&gt;-j&lt;/span&gt; REDIRECT &lt;span class=&quot;nt&quot;&gt;--to-ports&lt;/span&gt; 7892
iptables &lt;span class=&quot;nt&quot;&gt;-t&lt;/span&gt; nat &lt;span class=&quot;nt&quot;&gt;-A&lt;/span&gt; PREROUTING &lt;span class=&quot;nt&quot;&gt;-p&lt;/span&gt; tcp &lt;span class=&quot;nt&quot;&gt;-j&lt;/span&gt; CLASH
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c&quot;&gt;# 内部流量不转发给 CLASH 直通&lt;/span&gt;
iptables &lt;span class=&quot;nt&quot;&gt;-t&lt;/span&gt; nat &lt;span class=&quot;nt&quot;&gt;-A&lt;/span&gt; CLASH &lt;span class=&quot;nt&quot;&gt;-d&lt;/span&gt; 0.0.0.0/8 &lt;span class=&quot;nt&quot;&gt;-j&lt;/span&gt; RETURN
iptables &lt;span class=&quot;nt&quot;&gt;-t&lt;/span&gt; nat &lt;span class=&quot;nt&quot;&gt;-A&lt;/span&gt; CLASH &lt;span class=&quot;nt&quot;&gt;-d&lt;/span&gt; 10.0.0.0/8 &lt;span class=&quot;nt&quot;&gt;-j&lt;/span&gt; RETURN
iptables &lt;span class=&quot;nt&quot;&gt;-t&lt;/span&gt; nat &lt;span class=&quot;nt&quot;&gt;-A&lt;/span&gt; CLASH &lt;span class=&quot;nt&quot;&gt;-d&lt;/span&gt; 127.0.0.0/8 &lt;span class=&quot;nt&quot;&gt;-j&lt;/span&gt; RETURN
iptables &lt;span class=&quot;nt&quot;&gt;-t&lt;/span&gt; nat &lt;span class=&quot;nt&quot;&gt;-A&lt;/span&gt; CLASH &lt;span class=&quot;nt&quot;&gt;-d&lt;/span&gt; 169.254.0.0/16 &lt;span class=&quot;nt&quot;&gt;-j&lt;/span&gt; RETURN
iptables &lt;span class=&quot;nt&quot;&gt;-t&lt;/span&gt; nat &lt;span class=&quot;nt&quot;&gt;-A&lt;/span&gt; CLASH &lt;span class=&quot;nt&quot;&gt;-d&lt;/span&gt; 172.16.0.0/12 &lt;span class=&quot;nt&quot;&gt;-j&lt;/span&gt; RETURN
iptables &lt;span class=&quot;nt&quot;&gt;-t&lt;/span&gt; nat &lt;span class=&quot;nt&quot;&gt;-A&lt;/span&gt; CLASH &lt;span class=&quot;nt&quot;&gt;-d&lt;/span&gt; 192.168.0.0/16 &lt;span class=&quot;nt&quot;&gt;-j&lt;/span&gt; RETURN
iptables &lt;span class=&quot;nt&quot;&gt;-t&lt;/span&gt; nat &lt;span class=&quot;nt&quot;&gt;-A&lt;/span&gt; CLASH &lt;span class=&quot;nt&quot;&gt;-d&lt;/span&gt; 224.0.0.0/4 &lt;span class=&quot;nt&quot;&gt;-j&lt;/span&gt; RETURN
iptables &lt;span class=&quot;nt&quot;&gt;-t&lt;/span&gt; nat &lt;span class=&quot;nt&quot;&gt;-A&lt;/span&gt; CLASH &lt;span class=&quot;nt&quot;&gt;-d&lt;/span&gt; 240.0.0.0/4 &lt;span class=&quot;nt&quot;&gt;-j&lt;/span&gt; RETURN
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;我觉得只写 iptables 版，我会被人耻笑（这和网上随手一搜的垃圾教程有什么两样。对，其实我写的也是垃圾）&lt;/p&gt;

&lt;p&gt;来个 &lt;code class=&quot;highlighter-rouge&quot;&gt;nftables&lt;/code&gt; 版的 （Raspbian buster 要先安装个 nft 的前端 &lt;code class=&quot;highlighter-rouge&quot;&gt;apt install nftables&lt;/code&gt;）&lt;/p&gt;

&lt;p&gt;先创建一个私有地址的定义文件 &lt;code class=&quot;highlighter-rouge&quot;&gt;/etc/nftables/private.nft&lt;/code&gt;&lt;/p&gt;
&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;define private_list &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
	0.0.0.0/8,
	10.0.0.0/8,
	127.0.0.0/8,
	169.254.0.0/16,
	172.16.0.0/12,
	192.168.0.0/16,
	224.0.0.0/4,
	240.0.0.0/4
&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;再来修改主配置文件 &lt;code class=&quot;highlighter-rouge&quot;&gt;/etc/nftables.conf&lt;/code&gt;&lt;/p&gt;
&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c&quot;&gt;#!/usr/sbin/nft -f&lt;/span&gt;

include &lt;span class=&quot;s2&quot;&gt;&quot;/etc/nftables/private.nft&quot;&lt;/span&gt;

table ip nat &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
	chain proxy &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
		ip daddr &lt;span class=&quot;nv&quot;&gt;$private_list&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;return
			&lt;/span&gt;ip protocol tcp redirect to :7892
	&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
	chain prerouting &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
		&lt;span class=&quot;nb&quot;&gt;type &lt;/span&gt;nat hook prerouting priority 0&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; policy accept&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
		jump proxy
	&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;然后执行清空设置 &lt;code class=&quot;highlighter-rouge&quot;&gt;nft flush ruleset&lt;/code&gt;，让新的设置生效 &lt;code class=&quot;highlighter-rouge&quot;&gt;nft -f /etc/nftables.conf&lt;/code&gt;&lt;/p&gt;

&lt;p&gt;或者直接这样 &lt;code class=&quot;highlighter-rouge&quot;&gt;sudo sh -c &quot;nft flush ruleset &amp;amp;&amp;amp; nft -f /etc/nftables.conf&quot;&lt;/code&gt;&lt;/p&gt;

&lt;p&gt;然后通过这条命令来看当前 nftables 的状态 &lt;code class=&quot;highlighter-rouge&quot;&gt;sudo nft list ruleset&lt;/code&gt;&lt;/p&gt;

&lt;p&gt;最后再设置一下开机启动&lt;/p&gt;
&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;systemctl &lt;span class=&quot;nb&quot;&gt;enable &lt;/span&gt;nftables.service
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;参考文章&quot;&gt;参考文章&lt;/h2&gt;
&lt;p&gt;&lt;a href=&quot;https://blog.skk.moe/post/alternate-surge-koolclash-as-gateway/&quot;&gt;使用 KoolClash 作为代理网关&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://breakertt.moe/2019/08/20/clash_gateway/index.html&quot;&gt;在 Ubuntu18.04 上使用 clash 部署旁路代理网关（透明代理）&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://toutyrater.github.io/app/transparent_proxy.html&quot;&gt;V2Ray 做透明代理&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://ghost.qinan.co/debian10_iptables_to_nftables/&quot;&gt;debian10 使用 nftables 替换 iptables&lt;/a&gt;&lt;/p&gt;</content><author><name>metal A-wing</name></author><summary type="html">由于武汉新冠肺炎（COVID-19）的关系，我被困在老家，自从我买了 ac68u 之后基本上就再也没折腾过网。由于长期在家办公，需要好的网络，还好手里有树莓派，还有 nas。只能使用传统技能（时代变化还真实快，一觉醒来工具链全变了）</summary><media:thumbnail xmlns:media="http://search.yahoo.com/mrss/" url="https://a-wing.top/assets/avatar.png" /><media:content medium="image" url="https://a-wing.top/assets/avatar.png" xmlns:media="http://search.yahoo.com/mrss/" /></entry><entry><title type="html">使用 OpenCV 来做单元测试</title><link href="https://a-wing.top/program/2019/11/05/use_opencv_for_unittest.html" rel="alternate" type="text/html" title="使用 OpenCV 来做单元测试" /><published>2019-11-05T09:00:00+00:00</published><updated>2019-11-05T09:00:00+00:00</updated><id>https://a-wing.top/program/2019/11/05/use_opencv_for_unittest</id><content type="html" xml:base="https://a-wing.top/program/2019/11/05/use_opencv_for_unittest.html">&lt;p&gt;最近一直都在搞图像传输，webrtc 可以检测网络状况来调整码率。为了探究图像传输中损失了多少数据，用 opencv 来计算输入视频流和输出视频流的相似性&lt;/p&gt;

&lt;p&gt;不过本人作为一个不懂算法，不懂C++， 不懂openCV 的菜鸡。（我还真把这个东西给做出来了&lt;/p&gt;

&lt;h3 id=&quot;如何检测视频视频的相似性&quot;&gt;如何检测视频视频的相似性&lt;/h3&gt;
&lt;p&gt;先来科普两个概念：&lt;/p&gt;
&lt;ol&gt;
  &lt;li&gt;
    &lt;p&gt;峰值信噪比 PSNR (Peak signal-to-noise ratio)
https://en.wikipedia.org/wiki/Peak_signal-to-noise_ratio&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;结构相似性 SSIM (Structural similarity)
https://en.wikipedia.org/wiki/Structural_similarity&lt;/p&gt;
  &lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;这个处理本身是把视频拆成图像帧，然回分成 RGB 分辨对比&lt;/p&gt;

&lt;p&gt;然回把这个代码直接拿过来用就行（好敷衍。。。&lt;/p&gt;

&lt;p&gt;代码来源：https://docs.opencv.org/master/d5/dc4/tutorial_video_input_psnr_ssim.html&lt;/p&gt;
&lt;div class=&quot;language-cpp highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;cp&quot;&gt;#include &amp;lt;iostream&amp;gt; // for standard I/O
#include &amp;lt;string&amp;gt;   // for strings
#include &amp;lt;iomanip&amp;gt;  // for controlling float print precision
#include &amp;lt;sstream&amp;gt;  // string to number conversion
#include &amp;lt;opencv2/core.hpp&amp;gt;     // Basic OpenCV structures (cv::Mat, Scalar)
#include &amp;lt;opencv2/imgproc.hpp&amp;gt;  // Gaussian Blur
#include &amp;lt;opencv2/videoio.hpp&amp;gt;
#include &amp;lt;opencv2/highgui.hpp&amp;gt;  // OpenCV window I/O
&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;using&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;namespace&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;std&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;using&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;namespace&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;cv&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;kt&quot;&gt;double&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;getPSNR&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Mat&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;I1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Mat&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;I2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;Scalar&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;getMSSIM&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Mat&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;I1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Mat&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;I2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;help&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;cout&lt;/span&gt;
        &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;------------------------------------------------------------------------------&quot;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;endl&lt;/span&gt;
        &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;This program shows how to read a video file with OpenCV. In addition, it &quot;&lt;/span&gt;
        &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;tests the similarity of two input videos first with PSNR, and for the frames &quot;&lt;/span&gt;
        &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;below a PSNR trigger value, also with MSSIM.&quot;&lt;/span&gt;                                   &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;endl&lt;/span&gt;
        &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;Usage:&quot;&lt;/span&gt;                                                                         &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;endl&lt;/span&gt;
        &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;./video-input-psnr-ssim &amp;lt;referenceVideo&amp;gt; &amp;lt;useCaseTestVideo&amp;gt; &amp;lt;PSNR_Trigger_Value&amp;gt; &amp;lt;Wait_Between_Frames&amp;gt; &quot;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;endl&lt;/span&gt;
        &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;--------------------------------------------------------------------------&quot;&lt;/span&gt;     &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;endl&lt;/span&gt;
        &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;endl&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;main&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;argc&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;char&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;argv&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[])&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;help&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;();&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;argc&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;5&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;cout&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;Not enough parameters&quot;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;endl&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;stringstream&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;conv&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;string&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;sourceReference&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;argv&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;sourceCompareWith&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;argv&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;];&lt;/span&gt;
    &lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;psnrTriggerValue&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;delay&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;conv&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;argv&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;endl&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;argv&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;];&lt;/span&gt;       &lt;span class=&quot;c1&quot;&gt;// put in the strings&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;conv&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;psnrTriggerValue&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;delay&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;        &lt;span class=&quot;c1&quot;&gt;// take out the numbers&lt;/span&gt;
    &lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;frameNum&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;          &lt;span class=&quot;c1&quot;&gt;// Frame counter&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;VideoCapture&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;captRefrnc&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;sourceReference&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;captUndTst&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;sourceCompareWith&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;!&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;captRefrnc&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;isOpened&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;())&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;cout&lt;/span&gt;  &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;Could not open reference &quot;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;sourceReference&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;endl&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;!&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;captUndTst&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;isOpened&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;())&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;cout&lt;/span&gt;  &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;Could not open case test &quot;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;sourceCompareWith&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;endl&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;Size&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;refS&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Size&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;((&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;captRefrnc&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;get&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;CAP_PROP_FRAME_WIDTH&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;
                     &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;captRefrnc&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;get&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;CAP_PROP_FRAME_HEIGHT&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)),&lt;/span&gt;
         &lt;span class=&quot;n&quot;&gt;uTSi&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Size&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;((&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;captUndTst&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;get&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;CAP_PROP_FRAME_WIDTH&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;
                     &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;captUndTst&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;get&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;CAP_PROP_FRAME_HEIGHT&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;));&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;refS&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;uTSi&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;cout&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;Inputs have different size!!! Closing.&quot;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;endl&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;char&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;WIN_UT&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;Under Test&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;char&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;WIN_RF&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;Reference&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;// Windows&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;namedWindow&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;WIN_RF&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;WINDOW_AUTOSIZE&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;namedWindow&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;WIN_UT&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;WINDOW_AUTOSIZE&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;moveWindow&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;WIN_RF&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;400&lt;/span&gt;       &lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;         &lt;span class=&quot;c1&quot;&gt;//750,  2 (bernat =0)&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;moveWindow&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;WIN_UT&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;refS&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;width&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;         &lt;span class=&quot;c1&quot;&gt;//1500, 2&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;cout&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;Reference frame resolution: Width=&quot;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;refS&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;width&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;  Height=&quot;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;refS&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;height&lt;/span&gt;
         &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot; of nr#: &quot;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;captRefrnc&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;get&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;CAP_PROP_FRAME_COUNT&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;endl&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;cout&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;PSNR trigger value &quot;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;setiosflags&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ios&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;fixed&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;setprecision&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
         &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;psnrTriggerValue&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;endl&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;Mat&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;frameReference&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;frameUnderTest&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;kt&quot;&gt;double&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;psnrV&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;Scalar&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;mssimV&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;for&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(;;)&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;//Show the image captured in the window and repeat&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;captRefrnc&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;frameReference&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;captUndTst&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;frameUnderTest&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;frameReference&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;empty&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;||&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;frameUnderTest&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;empty&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;())&lt;/span&gt;
        &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
            &lt;span class=&quot;n&quot;&gt;cout&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot; &amp;lt; &amp;lt; &amp;lt;  Game over!  &amp;gt; &amp;gt; &amp;gt; &quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
            &lt;span class=&quot;k&quot;&gt;break&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
        &lt;span class=&quot;o&quot;&gt;++&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;frameNum&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;cout&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;Frame: &quot;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;frameNum&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;# &quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;psnrV&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;getPSNR&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;frameReference&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;frameUnderTest&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;cout&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;setiosflags&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ios&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;fixed&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;setprecision&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;psnrV&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;dB&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;psnrV&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;psnrTriggerValue&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;psnrV&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
        &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
            &lt;span class=&quot;n&quot;&gt;mssimV&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;getMSSIM&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;frameReference&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;frameUnderTest&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
            &lt;span class=&quot;n&quot;&gt;cout&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot; MSSIM: &quot;&lt;/span&gt;
                &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot; R &quot;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;setiosflags&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ios&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;fixed&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;setprecision&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;mssimV&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;val&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;100&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;%&quot;&lt;/span&gt;
                &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot; G &quot;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;setiosflags&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ios&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;fixed&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;setprecision&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;mssimV&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;val&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;100&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;%&quot;&lt;/span&gt;
                &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot; B &quot;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;setiosflags&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ios&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;fixed&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;setprecision&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;mssimV&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;val&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;100&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;%&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;cout&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;endl&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;imshow&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;WIN_RF&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;frameReference&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;imshow&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;WIN_UT&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;frameUnderTest&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
        &lt;span class=&quot;kt&quot;&gt;char&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;c&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;char&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;waitKey&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;delay&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;c&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;27&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;break&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;kt&quot;&gt;double&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;getPSNR&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Mat&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;I1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Mat&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;I2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;Mat&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;s1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;absdiff&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;I1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;I2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;s1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;       &lt;span class=&quot;c1&quot;&gt;// |I1 - I2|&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;s1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;convertTo&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;s1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;CV_32F&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;  &lt;span class=&quot;c1&quot;&gt;// cannot make a square on 8 bits&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;s1&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;s1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;mul&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;s1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;           &lt;span class=&quot;c1&quot;&gt;// |I1 - I2|^2&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;Scalar&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;s&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;sum&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;s1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;        &lt;span class=&quot;c1&quot;&gt;// sum elements per channel&lt;/span&gt;
    &lt;span class=&quot;kt&quot;&gt;double&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;sse&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;s&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;val&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;s&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;val&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;s&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;val&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;];&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;// sum channels&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;sse&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;=&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;1e-10&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;// for small values return zero&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;else&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;kt&quot;&gt;double&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;mse&lt;/span&gt;  &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;sse&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;/&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;double&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;I1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;channels&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;I1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;total&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;());&lt;/span&gt;
        &lt;span class=&quot;kt&quot;&gt;double&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;psnr&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;10.0&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;log10&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;((&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;255&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;255&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;/&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;mse&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;psnr&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;Scalar&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;getMSSIM&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Mat&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;i1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Mat&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;i2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;double&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;C1&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;6.5025&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;C2&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;58.5225&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;cm&quot;&gt;/***************************** INITS **********************************/&lt;/span&gt;
    &lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;d&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;CV_32F&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;Mat&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;I1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;I2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;i1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;convertTo&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;I1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;d&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;            &lt;span class=&quot;c1&quot;&gt;// cannot calculate on one byte large values&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;i2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;convertTo&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;I2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;d&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;Mat&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;I2_2&lt;/span&gt;   &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;I2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;mul&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;I2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;        &lt;span class=&quot;c1&quot;&gt;// I2^2&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;Mat&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;I1_2&lt;/span&gt;   &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;I1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;mul&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;I1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;        &lt;span class=&quot;c1&quot;&gt;// I1^2&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;Mat&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;I1_I2&lt;/span&gt;  &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;I1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;mul&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;I2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;        &lt;span class=&quot;c1&quot;&gt;// I1 * I2&lt;/span&gt;
    &lt;span class=&quot;cm&quot;&gt;/*************************** END INITS **********************************/&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;Mat&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;mu1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;mu2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;                   &lt;span class=&quot;c1&quot;&gt;// PRELIMINARY COMPUTING&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;GaussianBlur&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;I1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;mu1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Size&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;11&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;11&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;1.5&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;GaussianBlur&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;I2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;mu2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Size&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;11&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;11&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;1.5&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;Mat&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;mu1_2&lt;/span&gt;   &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;   &lt;span class=&quot;n&quot;&gt;mu1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;mul&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;mu1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;Mat&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;mu2_2&lt;/span&gt;   &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;   &lt;span class=&quot;n&quot;&gt;mu2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;mul&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;mu2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;Mat&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;mu1_mu2&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;   &lt;span class=&quot;n&quot;&gt;mu1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;mul&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;mu2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;Mat&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;sigma1_2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;sigma2_2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;sigma12&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;GaussianBlur&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;I1_2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;sigma1_2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Size&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;11&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;11&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;1.5&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;sigma1_2&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;mu1_2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;GaussianBlur&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;I2_2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;sigma2_2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Size&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;11&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;11&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;1.5&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;sigma2_2&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;mu2_2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;GaussianBlur&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;I1_I2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;sigma12&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Size&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;11&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;11&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;1.5&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;sigma12&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;mu1_mu2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;Mat&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;t1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;t2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;t3&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;t1&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;mu1_mu2&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;C1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;t2&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;sigma12&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;C2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;t3&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;t1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;mul&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;t2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;                 &lt;span class=&quot;c1&quot;&gt;// t3 = ((2*mu1_mu2 + C1).*(2*sigma12 + C2))&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;t1&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;mu1_2&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;mu2_2&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;C1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;t2&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;sigma1_2&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;sigma2_2&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;C2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;t1&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;t1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;mul&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;t2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;                 &lt;span class=&quot;c1&quot;&gt;// t1 =((mu1_2 + mu2_2 + C1).*(sigma1_2 + sigma2_2 + C2))&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;Mat&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ssim_map&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;divide&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;t3&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;t1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ssim_map&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;        &lt;span class=&quot;c1&quot;&gt;// ssim_map =  t3./t1;&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;Scalar&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;mssim&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;mean&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ssim_map&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;   &lt;span class=&quot;c1&quot;&gt;// mssim = average of ssim map&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;mssim&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;嗯？ 不想看英文。这里有个中文版（不过不建议看这个中文版）https://www.w3cschool.cn/opencv/opencv-v4na2dr6.html&lt;/p&gt;

&lt;p&gt;之后编译源码&lt;/p&gt;
&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c&quot;&gt;# 安装依赖 我在 debian:buster 上测试运行的&lt;/span&gt;
apt-get update &lt;span class=&quot;nt&quot;&gt;-y&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; apt-get &lt;span class=&quot;nb&quot;&gt;install&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-y&lt;/span&gt; libopencv-dev g++ wget

g++ video-input-psnr-ssim.cpp &lt;span class=&quot;nt&quot;&gt;-o&lt;/span&gt; video-input-psnr-ssim &lt;span class=&quot;nt&quot;&gt;-I&lt;/span&gt; /usr/include/opencv4 &lt;span class=&quot;nt&quot;&gt;-L&lt;/span&gt; /usr/lib &lt;span class=&quot;nt&quot;&gt;-lopencv_core&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-lopencv_highgui&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-lopencv_imgproc&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-lopencv_videoio&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;这样来运行：&lt;/p&gt;
&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;wget https://github.com/opencv/opencv/raw/master/samples/data/Megamind.avi
wget https://github.com/opencv/opencv/raw/master/samples/data/Megamind_bugy.avi
./video-input-psnr-ssim Megamind.avi Megamind_bugy.avi 35 10
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h3 id=&quot;之后就是把这个流程自动化&quot;&gt;之后就是把这个流程自动化&lt;/h3&gt;

&lt;p&gt;这个要跑在 ci 里自动输出结果的。显示窗口可不行，还要改造一下。直接去掉窗口。很容易，C++ 的基础&lt;/p&gt;

&lt;p&gt;把结果算平均值已经有人写好了 https://github.com/yeokm1/ssim&lt;/p&gt;

&lt;p&gt;直接把那段代码拿过来就能用&lt;/p&gt;

&lt;p&gt;我们用 gstreamer videotestsrc 来做视频源&lt;/p&gt;

&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;gst-launch-1.0 videotestsrc &lt;span class=&quot;o&quot;&gt;!&lt;/span&gt; videoconvert &lt;span class=&quot;o&quot;&gt;!&lt;/span&gt; autovideosink
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;然回用 webrtc 去发送这段视频&lt;/p&gt;

&lt;p&gt;可以用这个项目来发送视频 https://github.com/pion/webrtc/tree/master/examples/play-from-disk&lt;/p&gt;

&lt;p&gt;当然是可以使用 cgo 的。用go 去调用 gstreamer 。这样可以少一步图像转换
https://github.com/pion/example-webrtc-applications/tree/master/gstreamer-send&lt;/p&gt;

&lt;p&gt;然回另一端接收图像。保存成文件
https://github.com/pion/webrtc/tree/master/examples/save-to-disk&lt;/p&gt;

&lt;p&gt;之后把这个坨都放在 gitlab ci 里&lt;/p&gt;

&lt;p&gt;我最终输出的结果长这样：&lt;/p&gt;
&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&amp;lt; &amp;lt; &amp;lt; === END === &amp;gt; &amp;gt; &amp;gt;
Final Results
R 96.10% G 95.99% B 92.14%
Similarity = 94.74%
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;然回在 &lt;code class=&quot;highlighter-rouge&quot;&gt;Setting&lt;/code&gt; &amp;gt; &lt;code class=&quot;highlighter-rouge&quot;&gt;CI / CD&lt;/code&gt; &amp;gt; &lt;code class=&quot;highlighter-rouge&quot;&gt;General pipelines&lt;/code&gt; &amp;gt; &lt;code class=&quot;highlighter-rouge&quot;&gt;Test coverage parsing&lt;/code&gt; 里这样写：&lt;/p&gt;
&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;Similarity = \d+.\d+%
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;这样就把视频相识度结果输出到代码覆盖率上了（对于这种图像传输算相似度才有意义 （（（大雾&lt;/p&gt;</content><author><name>metal A-wing</name></author><summary type="html">最近一直都在搞图像传输，webrtc 可以检测网络状况来调整码率。为了探究图像传输中损失了多少数据，用 opencv 来计算输入视频流和输出视频流的相似性</summary><media:thumbnail xmlns:media="http://search.yahoo.com/mrss/" url="https://a-wing.top/assets/avatar.png" /><media:content medium="image" url="https://a-wing.top/assets/avatar.png" xmlns:media="http://search.yahoo.com/mrss/" /></entry><entry><title type="html">MacBook Pro 初体验感想</title><link href="https://a-wing.top/linux/2019/10/01/macbookpro.html" rel="alternate" type="text/html" title="MacBook Pro 初体验感想" /><published>2019-10-01T08:00:00+00:00</published><updated>2019-10-01T08:00:00+00:00</updated><id>https://a-wing.top/linux/2019/10/01/macbookpro</id><content type="html" xml:base="https://a-wing.top/linux/2019/10/01/macbookpro.html">&lt;p&gt;&lt;img src=&quot;/assets/img/macbookpro/mbp.jpg&quot; alt=&quot;mbp&quot; /&gt;&lt;/p&gt;

&lt;p&gt;刚买了一台 2015 款的 macbook pro 。嗯，就是 MF839 的那款。正好来谈谈使用感想&lt;/p&gt;

&lt;h2 id=&quot;入手前准备&quot;&gt;入手前准备&lt;/h2&gt;
&lt;p&gt;最有效的资料是苹果官网的 &lt;a href=&quot;https://support.apple.com/zh-cn/HT201300&quot;&gt;macbook pro 机型&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;我当然是要买二手的机器了，干嘛要买新的（&lt;/p&gt;

&lt;p&gt;先选择买哪一款，然后去某宝的二手苹果商家卖家那里查价钱，多查几家，基本可以得出要买机型的市场价格。没问题的机器价格波动基本上在 5%&lt;/p&gt;

&lt;p&gt;不着急的话，去咸鱼上慢慢找。。。不够我实际观测，咸鱼上的二手苹果水极深&lt;/p&gt;

&lt;p&gt;要注意几点：&lt;/p&gt;
&lt;ol&gt;
  &lt;li&gt;价格波动基本上在 5% 以下，价钱过低都是有问题的&lt;/li&gt;
  &lt;li&gt;Macbook 整体造假成本很高，基本上没有假的。。。最多是防外观，基本上一眼就能看出&lt;/li&gt;
  &lt;li&gt;15 款以前的，硬盘可以更换，要注意机器上是否是原装硬盘&lt;/li&gt;
  &lt;li&gt;如果有条件最好拆后壳验机&lt;/li&gt;
  &lt;li&gt;华强北这方面很强，电池循环次数，序列号都是可以随便改的，电池循环一般都会改成一百多次，要注意测试实际的使用时间&lt;/li&gt;
  &lt;li&gt;如果对个人卖家面交，一定要当场联网测试。确认这个电脑是否是被偷来的&lt;/li&gt;
  &lt;li&gt;市场价格的职业卖家其实还是靠谱的&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;还有买二手电脑的基本操作我还是再啰嗦一遍吧：&lt;/p&gt;
&lt;ol&gt;
  &lt;li&gt;外观，这个不用说&lt;/li&gt;
  &lt;li&gt;检测键盘，每个键都要检查&lt;/li&gt;
  &lt;li&gt;检查屏幕是否有坏点，换壁纸或放图片，RGB 都要测&lt;/li&gt;
  &lt;li&gt;外设接口，USB，HDMI 都要测&lt;/li&gt;
  &lt;li&gt;拆后壳。。。保险起见&lt;/li&gt;
&lt;/ol&gt;

&lt;h2 id=&quot;工业设计&quot;&gt;工业设计&lt;/h2&gt;
&lt;p&gt;外观是无可挑剔的，配重刚刚好，一只手刚好完成开电脑的动作（我的 xps 需要两只手去把他掰开，这点我可以黑几年&lt;/p&gt;

&lt;p&gt;信仰的 apple logo 灯，前后相同的厚度。 我其实比较喜欢等厚度的设计&lt;/p&gt;

&lt;p&gt;首先苹果电脑里有个内置的 2G 的存储，里面装的是苹果的基本系统，用来联网安装 macos 的，其他的地方就和一般的 PC 一样了&lt;/p&gt;

&lt;p&gt;硬件上还有苹果的网卡比较特殊，毕竟要支持一些特殊的功能嘛，airdrop 之类的&lt;/p&gt;

&lt;p&gt;对了，还有这个机器漏电！！！充电的时候用会被电到&lt;/p&gt;

&lt;p&gt;内存是不可拆卸的，硬盘接口特殊，第三方硬盘要转接卡&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;还有就是那块 Retina 屏，看起来真的爽&lt;/strong&gt;&lt;/p&gt;

&lt;h2 id=&quot;macos&quot;&gt;MacOS&lt;/h2&gt;
&lt;p&gt;说到 mbp 最好用的地方，就是那块神奇的触摸板了。这个也太爽了，这块触摸板配合 macos 简直吊打一切其他笔记本的触摸板&lt;/p&gt;

&lt;p&gt;这块触摸板大概就是苹果笔记本的灵魂了&lt;/p&gt;

&lt;p&gt;icloud 联系人，日历的同步，默认做到很好&lt;/p&gt;

&lt;p&gt;还有用电脑直接就可以打 facetime ，这个简直超爽&lt;/p&gt;

&lt;p&gt;我最喜欢的是那个用 &lt;a href=&quot;https://support.apple.com/en-us/HT206995&quot;&gt;apple watch 来解锁的功能&lt;/a&gt;，我吹爆这个功能&lt;/p&gt;

&lt;p&gt;Finder 也很不错，当然最强大的要属 Spotlight 。。类似 kde 下的 krunner&lt;/p&gt;

&lt;p&gt;还想问一下苹果用 mbp 的各位，&lt;code class=&quot;highlighter-rouge&quot;&gt;command + c&lt;/code&gt; 和 &lt;code class=&quot;highlighter-rouge&quot;&gt;command + v&lt;/code&gt; 里那么近，平时应该用那个手指按比较好啊&lt;/p&gt;

&lt;p&gt;官方那个用 iPad 作为扩展屏的功能要 16 款之后的 MBP 才能支持&lt;/p&gt;

&lt;p&gt;MacOS 的 app store 里一堆软件都没有，安装其他来源软件的操作有点令人迷惑&lt;/p&gt;

&lt;p&gt;日常使用 MacOS 的时候内存占用大概为 4G 这里指一些基本应用，开个听歌的，开几个网页，不包括工作用的 。。。说好的优化那（&lt;/p&gt;

&lt;p&gt;iTerm2 还是很强大的，透明、模糊、连字。。。 都支持&lt;/p&gt;

&lt;p&gt;MacOS 的全屏，这个有点接受不了，最糟糕的地方是全屏没有壁纸，如果要全屏的应用设置了透明。。。全屏后背景是黑的。。&lt;/p&gt;

&lt;p&gt;那个邮件应用的图标很反人类。。。&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/img/macbookpro/desktop.jpg&quot; alt=&quot;mbp&quot; /&gt;
你能看出哪个是邮件程序吗？&lt;/p&gt;

&lt;h2 id=&quot;homebrew&quot;&gt;Homebrew&lt;/h2&gt;
&lt;p&gt;Homebrew 我没感觉这个哪里好用，同为包管理，Linux 下的包管理更好用&lt;/p&gt;

&lt;p&gt;我们来看一下 homebrew 的构建脚本 https://github.com/Homebrew/homebrew-core/blob/master/Formula/bat.rb&lt;/p&gt;

&lt;div class=&quot;language-ruby highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c1&quot;&gt;# https://github.com/Homebrew/homebrew-core/blob/master/Formula/bat.rb#L20&lt;/span&gt;

&lt;span class=&quot;nb&quot;&gt;system&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;cargo&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;install&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;--root&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;prefix&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;--path&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;.&quot;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;这里调用了外置命令 cargo 但并没有 makedepend 。。。抱歉不是很懂 homebrew ，也可能是吧 system 的第一个参数作为了 makedepend。。那问题来了。如果这个软件复杂，有拆包，如果有第二个参数控制是哪个扩展包，这个要怎么处理。。。&lt;/p&gt;

&lt;p&gt;homebrew bottle 是预编译分发软件仓库&lt;/p&gt;

&lt;p&gt;我对 Homebrew 包还是有些迷惑，好像所有的包都是静态编译的（&lt;/p&gt;

&lt;p&gt;更新都是绑定 MacOS 的版本进行更新的&lt;/p&gt;

&lt;p&gt;然后所有的版本都放一起，我还是觉得 debian 的 deb 仓库比这个优秀的多&lt;/p&gt;

&lt;h2 id=&quot;总结&quot;&gt;总结&lt;/h2&gt;
&lt;p&gt;&lt;strong&gt;最终总结就是：细节很完美，然而并没有什么卵用&lt;/strong&gt;&lt;/p&gt;

&lt;p&gt;8G 内存真的不够。。。作为主力机，建议直接上 16G&lt;/p&gt;

&lt;p&gt;默认配置很完美，可定制性差一些。。。也就是可以开箱即用&lt;/p&gt;

&lt;p&gt;如果你平时用 iphone , ipad 之类的苹果全家桶，那加上 mbp 还是很不错的。如果只有一个 mbp 就很没必要了。。。如果你正常用 Linux 无压力，Linux 也许是更好的选择&lt;/p&gt;</content><author><name>metal A-wing</name></author><summary type="html"></summary><media:thumbnail xmlns:media="http://search.yahoo.com/mrss/" url="https://a-wing.top/assets/avatar.png" /><media:content medium="image" url="https://a-wing.top/assets/avatar.png" xmlns:media="http://search.yahoo.com/mrss/" /></entry><entry><title type="html">关于中秋节发月饼这件事</title><link href="https://a-wing.top/think/2019/09/15/moon_cake.html" rel="alternate" type="text/html" title="关于中秋节发月饼这件事" /><published>2019-09-15T08:00:00+00:00</published><updated>2019-09-15T08:00:00+00:00</updated><id>https://a-wing.top/think/2019/09/15/moon_cake</id><content type="html" xml:base="https://a-wing.top/think/2019/09/15/moon_cake.html">&lt;p&gt;这篇本来不想发出来，不过想了想还是发出来吧，毕竟我的想法也不一定是对的。&lt;/p&gt;

&lt;p&gt;事情是这样的，我司本来是小公司，没有专门的 HR 行政之类的人。到中秋节了吗。。。因为我们有远程工作的，还有常年不来公司露面的销售&lt;/p&gt;

&lt;p&gt;我司这个是第一次过节全员发福利，主要是今年员工快翻了两倍了&lt;/p&gt;

&lt;p&gt;本来我是本着发点月饼增加以下感情。。。毕竟发100块的月饼和发100块的红包给人的感觉是不一样的&lt;/p&gt;
&lt;ul&gt;
  &lt;li&gt;100块的月饼：哇，还有月饼吃，好开心&lt;/li&gt;
  &lt;li&gt;100块的红包：抠死了。才100块，这公司要倒闭了，散了吧散了吧&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;嗯，发月饼这件事是我向领导提出来的。。。（我TM 就是嘴欠&lt;/p&gt;

&lt;p&gt;本来我想先去找销售去商量一下的，然而销售那几天都没来。。。&lt;/p&gt;

&lt;p&gt;然而最糟糕的事情出现了。。。我找领导一商量，好，月饼买了。。。。销售也每个人都买了一份月饼，最大的问题是那个销售根本不知道有多少远程的。。。所有只买了平时在办公室里的。。。&lt;/p&gt;

&lt;p&gt;好了现在月饼泛滥了，没人可以拿两份了。。。那怎么行啊，把月饼都送出去，剩下的拆开大家分着吃&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;然而令我最不爽的是有人提出给客户送月饼&lt;/strong&gt;，理由是：原来用财务公司记账的时候，财务公司给客户送月饼。嗯，好像很有道理的样子。。（不对啊，这个分行业吧&lt;/p&gt;

&lt;p&gt;不过我怎么都感觉不对：&lt;/p&gt;
&lt;ul&gt;
  &lt;li&gt;像那种财务公司，可替代性极强，维护客情关系就显得尤为重要。&lt;/li&gt;
  &lt;li&gt;但我们的客户，今天把它骂了，明天它还会乐呵呵的买你的产品。。毕竟没得选&lt;/li&gt;
  &lt;li&gt;最终结论就是，月饼等于丢了。没有产生任何价值&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;保险，财务，专利代理之类的逢年过节，完全销售主导型的送点礼品维护一下客情很重要&lt;/p&gt;

&lt;p&gt;你一个做产品的，干嘛给客户送礼啊。。。就因为客单价很高？（送经销商礼品还差不多。不对经销商是从你这赚钱的，经销商应该给你送礼&lt;/p&gt;

&lt;p&gt;这中间还有一下涉及公司的项目的合作公司的人送月饼。。。这个更有意思：对接的本来有两个人。。一个很熟，一个不熟悉的新加入的。。。然后和对方的大领导很熟。&lt;/p&gt;

&lt;p&gt;只送给很熟的人，那另一个不熟的人知道了感觉不太好，那就都送吧。。。然后那个不熟的就把月饼推了回来，理由是：不敢收&lt;/p&gt;

&lt;p&gt;站在他的角度想想，收了才是心大。。。我和你们不熟啊，你们和我大领导那么熟，到底是有什么关系？是在试探我吗？还是在贿赂我？&lt;/p&gt;

&lt;p&gt;到最后所有人都发完了，还剩下一些月饼，刚准备拆开大家分开吃掉。。。要不要在确认一下，不常来的是不是都收到了。。。一查，还真有没收到的。&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;最后总结一下就是，还真不能小瞧发月饼这件事，这里面学问还挺多&lt;/strong&gt;&lt;/p&gt;

&lt;p&gt;以上想法纯属个人YY，如有不同见解，请务必指出&lt;/p&gt;</content><author><name>metal A-wing</name></author><summary type="html">这篇本来不想发出来，不过想了想还是发出来吧，毕竟我的想法也不一定是对的。</summary><media:thumbnail xmlns:media="http://search.yahoo.com/mrss/" url="https://a-wing.top/assets/avatar.png" /><media:content medium="image" url="https://a-wing.top/assets/avatar.png" xmlns:media="http://search.yahoo.com/mrss/" /></entry><entry><title type="html">浅谈浏览器实时流媒体</title><link href="https://a-wing.top/web/2019/09/14/browser_live.html" rel="alternate" type="text/html" title="浅谈浏览器实时流媒体" /><published>2019-09-14T12:00:00+00:00</published><updated>2019-09-14T12:00:00+00:00</updated><id>https://a-wing.top/web/2019/09/14/browser_live</id><content type="html" xml:base="https://a-wing.top/web/2019/09/14/browser_live.html">&lt;p&gt;我觉得应改把浏览器实时流媒体分成三层（传输，容器，编解码），这样更容易理解，不过他们并不能任意组合&lt;/p&gt;

&lt;h2 id=&quot;分层结构&quot;&gt;分层结构&lt;/h2&gt;
&lt;h4 id=&quot;数据传输层底层传输层浏览器原生支持&quot;&gt;数据传输层（底层传输层，浏览器原生支持）&lt;/h4&gt;
&lt;ul&gt;
  &lt;li&gt;http&lt;/li&gt;
  &lt;li&gt;websocket&lt;/li&gt;
  &lt;li&gt;webrtc&lt;/li&gt;
  &lt;li&gt;rtmp (这个浏览器本身不支持，要靠外置插件)&lt;/li&gt;
&lt;/ul&gt;

&lt;h4 id=&quot;实时流传输层中间传输层&quot;&gt;实时流传输层（中间传输层）&lt;/h4&gt;
&lt;ul&gt;
  &lt;li&gt;rtp&lt;/li&gt;
  &lt;li&gt;rtsp&lt;/li&gt;
&lt;/ul&gt;

&lt;h4 id=&quot;容器层&quot;&gt;容器层&lt;/h4&gt;
&lt;ul&gt;
  &lt;li&gt;浏览器原生支持&lt;/li&gt;
  &lt;li&gt;Media Source Extensions
    &lt;ul&gt;
      &lt;li&gt;flv&lt;/li&gt;
      &lt;li&gt;ts&lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
&lt;/ul&gt;

&lt;h4 id=&quot;编解-码&quot;&gt;编/解 码&lt;/h4&gt;
&lt;ul&gt;
  &lt;li&gt;vp8&lt;/li&gt;
  &lt;li&gt;vp9&lt;/li&gt;
  &lt;li&gt;h264&lt;/li&gt;
  &lt;li&gt;h265&lt;/li&gt;
&lt;/ul&gt;

&lt;h4 id=&quot;编解码-信息交换&quot;&gt;编解码 信息交换&lt;/h4&gt;
&lt;ul&gt;
  &lt;li&gt;sdp&lt;/li&gt;
  &lt;li&gt;m3u8&lt;/li&gt;
  &lt;li&gt;mpd&lt;/li&gt;
  &lt;li&gt;webrtc sdp&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;我这里分了四层（&lt;code class=&quot;highlighter-rouge&quot;&gt;编解码 信息交换&lt;/code&gt; 和 &lt;code class=&quot;highlighter-rouge&quot;&gt;编/解 码&lt;/code&gt; 不会同时运行，先信息交换再编解码）。。因为浏览器容器层是由原生支持的，只有播放原本浏览器不支持的容器是才需要 MSE&lt;/p&gt;

&lt;p&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;实时流传输层（中间传输层）&lt;/code&gt; 这个其实是可有可无的，大部分情况都是没有的&lt;/p&gt;

&lt;p&gt;由于浏览器实现的编解码都不同，一般都要交换一下支持的&lt;code class=&quot;highlighter-rouge&quot;&gt;编解码&lt;/code&gt;的信息 一般都用 sdp&lt;/p&gt;

&lt;h2 id=&quot;实时流方案&quot;&gt;实时流方案&lt;/h2&gt;
&lt;h3 id=&quot;hls&quot;&gt;HLS&lt;/h3&gt;
&lt;blockquote&gt;
  &lt;p&gt;HTTP Live Streaming（缩写是HLS）是一个由苹果公司提出的基于HTTP的流媒体网络传输协议。是苹果公司QuickTime X和iPhone软件系统的一部分。它的工作原理是把整个流分成一个个小的基于HTTP的文件来下载，每次只下载一些。当媒体流正在播放时，客户端可以选择从许多不同的备用源中以不同的速率下载同样的资源，允许流媒体会话适应不同的数据速率。在开始一个流媒体会话时，客户端会下载一个包含元数据的extended M3U (m3u8) playlist文件，用于寻找可用的媒体流。&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;将视频分成5-10秒的视频小分片，然后用m3u8索引表进行管理，由于客户端下载到的视频都是5-10秒的完整数据，故视频的流畅性很好，但也同样引入了很大的延迟(HLS的一般延迟在10-30s左右)。实际上还是纯“文本协议”相比于FLV，HLS在iPhone和大部分android手机浏览器上的支持非常给力。HLS协议客户端支持简单, 只需要支持 HTTP 请求即可, HTTP 协议无状态, 只需要按顺序下载媒体片段即可，而且网络兼容性好, HTTP 数据包也可以方便地通过防火墙或者代理服务器。但是相比RTMP 这类长连接协议, 用到互动直播场景延时较高。 对于点播服务来说, 由于 TS 切片通常较小, 海量碎片在文件分发, 一致性缓存, 存储等方面都有较大挑战，小文件碎片化严重&lt;/p&gt;

&lt;p&gt;这东西是苹果设备上独有的。但浏览器的兼容可以用 hls.js&lt;/p&gt;

&lt;h3 id=&quot;mpeg-dash&quot;&gt;MPEG-DASH&lt;/h3&gt;
&lt;blockquote&gt;
  &lt;p&gt;MEPG 推出 MEPG-DASH 标准，旨在为动态自适应流媒体技术创造一种同一的协议标准。DASH 也得到了许多公司的支持，Apple、Adobe、Microsoft、Netflix、Qualcomm 表示只要 DASH 完成，就会支持这个标准。&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;这个和 HLS 类似。只是把 m3u8 换成了 mpd，加了动态自适应&lt;/p&gt;

&lt;h3 id=&quot;flash&quot;&gt;Flash&lt;/h3&gt;
&lt;p&gt;这东西用的是 rtmp 。浏览器本身不支持。要靠外置插件来实现（chrome 有一段很长的时间内置了 flash 插件）&lt;/p&gt;

&lt;h3 id=&quot;http-flv--websocket-flv&quot;&gt;HTTP-FLV &amp;amp;&amp;amp; WebSocket-FLV&lt;/h3&gt;
&lt;p&gt;只是把 flv 容器用 http 或 webSocket 形式传输过来。但要播放 flv 容器的数据还是要用 flash ，或者用基于 MSE 的方案。典型就是使用 &lt;code class=&quot;highlighter-rouge&quot;&gt;flv.js&lt;/code&gt;&lt;/p&gt;

&lt;h3 id=&quot;rtsp&quot;&gt;rtsp&lt;/h3&gt;
&lt;p&gt;rtsp 底层是 rtp 或 tcp 。rtp 底层是 udp&lt;/p&gt;

&lt;p&gt;是可以把 rtsp 以 websocket 的形式传输过来。再使用 MSE 扩展&lt;/p&gt;

&lt;p&gt;https://github.com/Streamedian/html5_rtsp_player&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;注：这个方案我没试过，rtsp 实现也很复杂&lt;/strong&gt;&lt;/p&gt;

&lt;h3 id=&quot;webrtc&quot;&gt;webrtc&lt;/h3&gt;
&lt;p&gt;webrtc 里有一堆黑科技。原理很复杂，展开来说实在东西太多，其实只记在几件事就可以了&lt;/p&gt;

&lt;ol&gt;
  &lt;li&gt;webrtc 是 p2p 传的是 udp&lt;/li&gt;
  &lt;li&gt;stun 和 turn 只是为了实现 p2p 连接，直连模式和中继模式&lt;/li&gt;
  &lt;li&gt;webrtc 是使用 rtp 来传流媒体的，也有 rtcp 的数据，这点和 rtsp 类似。可以当成一种特殊的 rtsp 实现&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;一般用于视频会议，占资源很高，可以一对多，但不适合一对很多用户来直播&lt;/p&gt;

&lt;h2 id=&quot;一个简单对比&quot;&gt;一个简单对比&lt;/h2&gt;

&lt;table&gt;
  &lt;thead&gt;
    &lt;tr&gt;
      &lt;th&gt;方案&lt;/th&gt;
      &lt;th&gt;传输方式&lt;/th&gt;
      &lt;th&gt;视频封装格式&lt;/th&gt;
      &lt;th&gt;延时&lt;/th&gt;
      &lt;th&gt;浏览器支持&lt;/th&gt;
      &lt;th&gt;应用场景&lt;/th&gt;
    &lt;/tr&gt;
  &lt;/thead&gt;
  &lt;tbody&gt;
    &lt;tr&gt;
      &lt;td&gt;HLS&lt;/td&gt;
      &lt;td&gt;http&lt;/td&gt;
      &lt;td&gt;ts&lt;/td&gt;
      &lt;td&gt;10~30s&lt;/td&gt;
      &lt;td&gt;apple 原生支持，其他的要用 MSE 扩展&lt;/td&gt;
      &lt;td&gt;直播&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;DASH&lt;/td&gt;
      &lt;td&gt;http&lt;/td&gt;
      &lt;td&gt;mp4 ts&lt;/td&gt;
      &lt;td&gt;10~30s&lt;/td&gt;
      &lt;td&gt;未来的标准，MSE dash.js&lt;/td&gt;
      &lt;td&gt;直播&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;Flash&lt;/td&gt;
      &lt;td&gt;tcp流&lt;/td&gt;
      &lt;td&gt;flv&lt;/td&gt;
      &lt;td&gt;2s~5s&lt;/td&gt;
      &lt;td&gt;Flash插件&lt;/td&gt;
      &lt;td&gt;直播&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;http-flv&lt;/td&gt;
      &lt;td&gt;HTTP&lt;/td&gt;
      &lt;td&gt;flv&lt;/td&gt;
      &lt;td&gt;2s~5s&lt;/td&gt;
      &lt;td&gt;通过 flv.js&lt;/td&gt;
      &lt;td&gt;直播&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;websocket-flv&lt;/td&gt;
      &lt;td&gt;websocket&lt;/td&gt;
      &lt;td&gt;flv&lt;/td&gt;
      &lt;td&gt;1s~3s&lt;/td&gt;
      &lt;td&gt;通过 flv.js&lt;/td&gt;
      &lt;td&gt;直播&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;rtsp&lt;/td&gt;
      &lt;td&gt;websocket&lt;/td&gt;
      &lt;td&gt;mp4 flv&lt;/td&gt;
      &lt;td&gt;500ms&lt;/td&gt;
      &lt;td&gt;不支持，通过 MSE&lt;/td&gt;
      &lt;td&gt;低延时直播，视频会议&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;webrtc&lt;/td&gt;
      &lt;td&gt;rtp&lt;/td&gt;
      &lt;td&gt;mp4&lt;/td&gt;
      &lt;td&gt;200ms&lt;/td&gt;
      &lt;td&gt;支持，未来浏览器标准&lt;/td&gt;
      &lt;td&gt;视频会议&lt;/td&gt;
    &lt;/tr&gt;
  &lt;/tbody&gt;
&lt;/table&gt;

&lt;h3 id=&quot;参考文章&quot;&gt;参考文章&lt;/h3&gt;
&lt;p&gt;直播协议对比：
https://www.jianshu.com/p/cf02eb8080ec&lt;/p&gt;

&lt;p&gt;HLS，RTSP，RTMP的区别：
https://www.jianshu.com/p/70c9a2fd918b&lt;/p&gt;

&lt;p&gt;HLS与DASH流媒体协议对比：
https://wiki.zohead.com/%E6%8A%80%E6%9C%AF/%E9%9F%B3%E8%A7%86%E9%A2%91/HLS%E4%B8%8EDASH%E6%B5%81%E5%AA%92%E4%BD%93%E5%8D%8F%E8%AE%AE%E5%AF%B9%E6%AF%94.md&lt;/p&gt;

&lt;p&gt;使用flv.js做直播：
https://wuhaolin.cn/2017/05/17/%E4%BD%BF%E7%94%A8flv.js%E5%81%9A%E7%9B%B4%E6%92%AD/&lt;/p&gt;</content><author><name>metal A-wing</name></author><summary type="html">我觉得应改把浏览器实时流媒体分成三层（传输，容器，编解码），这样更容易理解，不过他们并不能任意组合</summary><media:thumbnail xmlns:media="http://search.yahoo.com/mrss/" url="https://a-wing.top/assets/avatar.png" /><media:content medium="image" url="https://a-wing.top/assets/avatar.png" xmlns:media="http://search.yahoo.com/mrss/" /></entry><entry><title type="html">细说 Debian 的网络管理 network/interfaces</title><link href="https://a-wing.top/linux/2019/04/01/debian_network.html" rel="alternate" type="text/html" title="细说 Debian 的网络管理 network/interfaces" /><published>2019-04-01T08:00:00+00:00</published><updated>2019-04-01T08:00:00+00:00</updated><id>https://a-wing.top/linux/2019/04/01/debian_network</id><content type="html" xml:base="https://a-wing.top/linux/2019/04/01/debian_network.html">&lt;p&gt;最近在修一个复杂的多网卡问题，产生的玄学问题，趁机把 interfaces 文档都读了一边&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;注：本文内容是在 &lt;code class=&quot;highlighter-rouge&quot;&gt;raspbian&lt;/code&gt; 系统上验证的&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;Debian 自带的网络管理的名字叫 &lt;code class=&quot;highlighter-rouge&quot;&gt;ifupdown&lt;/code&gt;&lt;/p&gt;

&lt;p&gt;权威的文档是 &lt;code class=&quot;highlighter-rouge&quot;&gt;man interfaces&lt;/code&gt;&lt;/p&gt;

&lt;p&gt;这个文件可以分成两部分，&lt;code class=&quot;highlighter-rouge&quot;&gt;INTERFACE SELECTION&lt;/code&gt; 和 &lt;code class=&quot;highlighter-rouge&quot;&gt;ADDRESS FAMILY&lt;/code&gt;&lt;/p&gt;

&lt;p&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;INTERFACE SELECTION&lt;/code&gt; 是 这个物理设备（可能是虚拟的）怎么样怎么样，指： 自动启动，允许热拔插啊之类的…&lt;/p&gt;

&lt;p&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;ADDRESS FAMILY&lt;/code&gt; 是上层的网络，设置 ip 地址啊，子网掩码，网关之类的…&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;Lines starting with `#’ are ignored. Note that end-of-line comments are NOT supported, comments must be on a line of their own.&lt;/strong&gt;&lt;/p&gt;
&lt;blockquote&gt;
  &lt;p&gt;注：network/interfaces 这个文件不支持行尾注释&lt;/p&gt;
&lt;/blockquote&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;# 自动使用 eth0, 相当于自动执行 ifup eth0
auto eth0

# 允许热拔插
allow-hotplug eth0

# ADDRESS FAMILY 配置
iface eth0 inet static
  address 192.168.1.2/24
  gateway 192.168.1.1
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;有四个 hook 函数，根据启动关闭的运行顺序是：&lt;/p&gt;
&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;pre-up
post-up &amp;amp;&amp;amp; up

pre-down &amp;amp;&amp;amp; down
post-down
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;调用 hook 时会传递一些变量：
比如 echo $IFACE 之类的&lt;/p&gt;

&lt;p&gt;这几个是全局的 hook 配置&lt;/p&gt;
&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;/etc/network/
if-down.d  if-post-down.d  if-pre-up.d  if-up.d
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;dhcpcd (Dynamic Host Configuration Protocol Clinet Daemon)&lt;/p&gt;
&lt;ul&gt;
  &lt;li&gt;isc-dhcp-client (这个包是默认就有的，也是一个dhcp 的客户端，这个是命令行接口 &lt;code class=&quot;highlighter-rouge&quot;&gt;ifupdown&lt;/code&gt; 是调用的这个)&lt;/li&gt;
  &lt;li&gt;dhcpcd5 (这个只在树莓上才是默认的) 也是默认运行的(至于为什么要叫dhcpcd5，大概是从 v5 之后开始支持 ipv6 的，虽然现在的版本是 6.x)&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;&lt;strong&gt;只有 raspbian 这个地方很不清真，他同时是有两个网络管理 之后人如果你直接使用 &lt;code class=&quot;highlighter-rouge&quot;&gt;network/interfaces&lt;/code&gt; 里面改，你就会发现 dhcp 是关不掉的！！！&lt;/strong&gt;&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;这个地方仅限于默认的 raspbian 系统，默认的 debian 是没有的&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;关掉 dhcp 就是 &lt;code class=&quot;highlighter-rouge&quot;&gt;systemctl disable dhcpcd.service&lt;/code&gt;&lt;/p&gt;

&lt;div class=&quot;language-shell highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;dpkg &lt;span class=&quot;nt&quot;&gt;-L&lt;/span&gt; dhcpcd5
/.
/etc
/etc/dhcpcd.conf
/etc/init.d
/etc/init.d/dhcpcd
/lib
/lib/arm-linux-gnueabihf
/lib/arm-linux-gnueabihf/dhcpcd
/lib/arm-linux-gnueabihf/dhcpcd/dev
/lib/arm-linux-gnueabihf/dhcpcd/dev/udev.so
/lib/dhcpcd
/lib/dhcpcd/dhcpcd-hooks
/lib/dhcpcd/dhcpcd-hooks/01-test
/lib/dhcpcd/dhcpcd-hooks/02-dump
/lib/dhcpcd/dhcpcd-hooks/10-wpa_supplicant
/lib/dhcpcd/dhcpcd-hooks/20-resolv.conf
/lib/dhcpcd/dhcpcd-hooks/30-hostname
/lib/dhcpcd/dhcpcd-hooks/50-ntp.conf
/lib/dhcpcd/dhcpcd-run-hooks
/lib/systemd
/lib/systemd/system
/lib/systemd/system/dhcpcd.service
/sbin
/sbin/dhcpcd5
/usr
/usr/lib
/usr/lib/dhcpcd5
/usr/lib/dhcpcd5/dhcpcd
/usr/share
/usr/share/dhcpcd
/usr/share/dhcpcd/hooks
/usr/share/dhcpcd/hooks/10-wpa_supplicant
/usr/share/dhcpcd/hooks/15-timezone
/usr/share/dhcpcd/hooks/29-lookup-hostname
/usr/share/doc
/usr/share/doc/dhcpcd5
/usr/share/doc/dhcpcd5/changelog.Debian.gz
/usr/share/doc/dhcpcd5/copyright
/usr/share/lintian
/usr/share/lintian/overrides
/usr/share/lintian/overrides/dhcpcd5
/usr/share/man
/usr/share/man/man5
/usr/share/man/man5/dhcpcd.conf.5.gz
/usr/share/man/man8
/usr/share/man/man8/dhcpcd-run-hooks.8.gz
/usr/share/man/man8/dhcpcd5.8.gz
/var
/var/lib
/var/lib/dhcpcd5

&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;h3 id=&quot;我们熟知的etcwpa_supplicantwpa_supplicantconf是什么时候运行的&quot;&gt;我们熟知的&lt;code class=&quot;highlighter-rouge&quot;&gt;/etc/wpa_supplicant/wpa_supplicant.conf&lt;/code&gt;是什么时候运行的？&lt;/h3&gt;

&lt;p&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;/lib/dhcpcd/dhcpcd-hooks/10-wpa_supplicant&lt;/code&gt; 是这里，只要启动了 dhcpcd 服务就会运行&lt;/p&gt;

&lt;p&gt;wpa_supplicant 的用法&lt;/p&gt;

&lt;div class=&quot;language-shell highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nb&quot;&gt;cat&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; /etc/wpa_supplicant/wpa_supplicant.conf &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;EOF&lt;/span&gt;&lt;span class=&quot;sh&quot;&gt;
country=CN
ctrl_interface=DIR=/var/run/wpa_supplicant GROUP=netdev
update_config=1

network={
  ssid=&quot;&amp;lt;You SSID&amp;gt;&quot;

  # hide ssid
  scan_ssid=1

  psk=&quot;&amp;lt;You Pass&amp;gt;&quot;
}
&lt;/span&gt;&lt;span class=&quot;no&quot;&gt;
EOF


&lt;/span&gt;&lt;span class=&quot;c&quot;&gt;# 启动&lt;/span&gt;
systemctl start wpa_supplicant.service

&lt;span class=&quot;c&quot;&gt;# 开机自启动&lt;/span&gt;
systemctl &lt;span class=&quot;nb&quot;&gt;enable &lt;/span&gt;wpa_supplicant.service
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;man wpa_supplicant.conf&lt;/code&gt; 其实已经讲的很清楚了&lt;/p&gt;

&lt;h1 id=&quot;现在你们已经看到了那一堆稀奇古怪的shell实现简直不能再糟糕了&quot;&gt;&lt;strong&gt;现在你们已经看到了那一堆稀奇古怪的shell实现，简直不能再糟糕了&lt;/strong&gt;&lt;/h1&gt;

&lt;blockquote&gt;
  &lt;p&gt;对的，这是两套网络管理器，搅在一起了。然后同时使用。。。&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h1 id=&quot;以下内容为-20200213-更新&quot;&gt;以下内容为 2020.02.13 更新&lt;/h1&gt;

&lt;p&gt;我们来看个好点的实现：&lt;code class=&quot;highlighter-rouge&quot;&gt;systemd 大法好&lt;/code&gt;。。。聊聊 &lt;code class=&quot;highlighter-rouge&quot;&gt;systemd-networkd&lt;/code&gt;&lt;/p&gt;

&lt;p&gt;本来想新开一篇文章，后来想想还是算了，还是在这片上接着写吧&lt;/p&gt;

&lt;p&gt;以下内容在 &lt;code class=&quot;highlighter-rouge&quot;&gt;Raspbian 10 (buster)&lt;/code&gt; 上验证&lt;/p&gt;

&lt;p&gt;最简单的 dhcp eth0 文件放这里 &lt;code class=&quot;highlighter-rouge&quot;&gt;/etc/systemd/network/eth0.network&lt;/code&gt; 这样写&lt;/p&gt;
&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;[Match]
Name=eth0

[Network]
DHCP=ipv4
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;静态 IP 的话，这样写&lt;/p&gt;
&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;[Match]
Name=eth0

[Network]
Address=192.168.123.10/24
Gateway=192.168.123.1
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;systemd-networkd&quot;&gt;systemd-networkd&lt;/h2&gt;
&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c&quot;&gt;# 禁用掉 `ifupdown`&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;mv&lt;/span&gt; /etc/network/interfaces /etc/network/interfaces.save

&lt;span class=&quot;c&quot;&gt;# 关闭 dhcpcd 客户端。这个好像只有树莓需要，原版 debian 我没测试&lt;/span&gt;
systemctl disable dhcpcd.service

&lt;span class=&quot;c&quot;&gt;# 启用 systemd-networkd&lt;/span&gt;
systemctl &lt;span class=&quot;nb&quot;&gt;enable &lt;/span&gt;systemd-networkd
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h3 id=&quot;wpa_supplicant-的-debian-systemd-这里有个坑&quot;&gt;&lt;strong&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;wpa_supplicant&lt;/code&gt; 的 debian systemd 这里有个坑&lt;/strong&gt;&lt;/h3&gt;

&lt;p&gt;先来看一下这个：&lt;code class=&quot;highlighter-rouge&quot;&gt;systemctl cat wpa_supplicant&lt;/code&gt;&lt;/p&gt;
&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c&quot;&gt;# /lib/systemd/system/wpa_supplicant.service&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;Unit]
&lt;span class=&quot;nv&quot;&gt;Description&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;WPA supplicant
&lt;span class=&quot;nv&quot;&gt;Before&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;network.target
&lt;span class=&quot;nv&quot;&gt;After&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;dbus.service
&lt;span class=&quot;nv&quot;&gt;Wants&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;network.target

&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;Service]
&lt;span class=&quot;nv&quot;&gt;Type&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;dbus
&lt;span class=&quot;nv&quot;&gt;BusName&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;fi&lt;/span&gt;.w1.wpa_supplicant1
&lt;span class=&quot;nv&quot;&gt;ExecStart&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;/sbin/wpa_supplicant &lt;span class=&quot;nt&quot;&gt;-u&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-s&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-O&lt;/span&gt; /run/wpa_supplicant

&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;Install]
&lt;span class=&quot;nv&quot;&gt;WantedBy&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;multi-user.target
&lt;span class=&quot;nv&quot;&gt;Alias&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;dbus-fi.w1.wpa_supplicant1.service
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;再看一下这个：&lt;code class=&quot;highlighter-rouge&quot;&gt;systemctl cat wpa_supplicant@&lt;/code&gt;&lt;/p&gt;
&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c&quot;&gt;# /lib/systemd/system/wpa_supplicant@.service&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;Unit]
&lt;span class=&quot;nv&quot;&gt;Description&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;WPA supplicant daemon &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;interface-specific version&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;Requires&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;sys-subsystem-net-devices-%i.device
&lt;span class=&quot;nv&quot;&gt;After&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;sys-subsystem-net-devices-%i.device
&lt;span class=&quot;nv&quot;&gt;Before&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;network.target
&lt;span class=&quot;nv&quot;&gt;Wants&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;network.target

&lt;span class=&quot;c&quot;&gt;# NetworkManager users will probably want the dbus version instead.&lt;/span&gt;

&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;Service]
&lt;span class=&quot;nv&quot;&gt;Type&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;simple
&lt;span class=&quot;nv&quot;&gt;ExecStart&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;/sbin/wpa_supplicant &lt;span class=&quot;nt&quot;&gt;-c&lt;/span&gt;/etc/wpa_supplicant/wpa_supplicant-%I.conf &lt;span class=&quot;nt&quot;&gt;-Dnl80211&lt;/span&gt;,wext &lt;span class=&quot;nt&quot;&gt;-i&lt;/span&gt;%I

&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;Install]
&lt;span class=&quot;nv&quot;&gt;Alias&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;multi-user.target.wants/wpa_supplicant@%i.service
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;我们看到那两个文件是不一样的，不仅仅是一个加个模版变量&lt;/p&gt;

&lt;p&gt;如果你使用 &lt;code class=&quot;highlighter-rouge&quot;&gt;systemd-networkd&lt;/code&gt;，&lt;code class=&quot;highlighter-rouge&quot;&gt;wpa_supplicant&lt;/code&gt; 服务请使用带模版变量那个（别问我为什么）&lt;/p&gt;

&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c&quot;&gt;# 新建个无线连接的配置文件&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;cat&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; /etc/wpa_supplicant/wpa_supplicant-wlan0.conf &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;EOF&lt;/span&gt;&lt;span class=&quot;sh&quot;&gt;
country=CN
ctrl_interface=DIR=/var/run/wpa_supplicant GROUP=netdev
update_config=1

network={
  ssid=&quot;&amp;lt;You SSID&amp;gt;&quot;
  psk=&quot;&amp;lt;You Pass&amp;gt;&quot;
}
&lt;/span&gt;&lt;span class=&quot;no&quot;&gt;
EOF

&lt;/span&gt;&lt;span class=&quot;c&quot;&gt;# 禁用掉 wpa_supplicant 服务&lt;/span&gt;
systemctl disable wpa_supplicant.service

&lt;span class=&quot;c&quot;&gt;# 用这个服务运行&lt;/span&gt;
systemctl &lt;span class=&quot;nb&quot;&gt;enable &lt;/span&gt;wpa_supplicant@wlan0.service
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;这个地方 Debian 的官方文档讲的很清楚： &lt;a href=&quot;https://wiki.debian.org/SystemdNetworkd&quot;&gt;SystemdNetworkd&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;详细参数可以用&lt;code class=&quot;highlighter-rouge&quot;&gt;man systemd.network&lt;/code&gt; 来看，也可以看这里：&lt;a href=&quot;https://manpages.debian.org/buster/systemd/systemd.network.5.en.html&quot;&gt;man systemd.network&lt;/a&gt;&lt;/p&gt;</content><author><name>metal A-wing</name></author><summary type="html">最近在修一个复杂的多网卡问题，产生的玄学问题，趁机把 interfaces 文档都读了一边</summary><media:thumbnail xmlns:media="http://search.yahoo.com/mrss/" url="https://a-wing.top/assets/avatar.png" /><media:content medium="image" url="https://a-wing.top/assets/avatar.png" xmlns:media="http://search.yahoo.com/mrss/" /></entry></feed>