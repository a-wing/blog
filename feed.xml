<?xml version="1.0" encoding="utf-8"?><feed xmlns="http://www.w3.org/2005/Atom" xml:lang="zh-CN"><generator uri="https://jekyllrb.com/" version="4.2.0">Jekyll</generator><link href="https://a-wing.top/feed.xml" rel="self" type="application/atom+xml" /><link href="https://a-wing.top/" rel="alternate" type="text/html" hreflang="zh-CN" /><updated>2021-02-04T09:32:22+00:00</updated><id>https://a-wing.top/feed.xml</id><title type="html">Hi! 上天不?</title><subtitle>新一的个人博客</subtitle><author><name>Metal A-wing</name><email>1 at 233 dot email</email></author><entry><title type="html">PingCAP 面试：Jenkins 和 Kubernetes</title><link href="https://a-wing.top/kubernetes/2021/01/27/jenkins_and_kubernetes.html" rel="alternate" type="text/html" title="PingCAP 面试：Jenkins 和 Kubernetes" /><published>2021-01-27T09:00:00+00:00</published><updated>2021-01-27T09:00:00+00:00</updated><id>https://a-wing.top/kubernetes/2021/01/27/jenkins_and_kubernetes</id><content type="html" xml:base="https://a-wing.top/kubernetes/2021/01/27/jenkins_and_kubernetes.html">&lt;p&gt;看我给你表演一个绝活，12 个小时之内完成&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;题目：给定三台香港的机器（4C8G），搭建一个单 master 节点的 k8s 集群，并搭建 Jenkins ，
并且使用 k8s 作为 Jenkins 的 Work Node 自动调度，完成 Nginx/TiDB 的自动化发布（通过一个 Job）&lt;/p&gt;

  &lt;p&gt;时间是一周，机器我们可以提供，你什么时候开始小作业可以提前跟我说，我让同事把机器给你开了&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h2 id=&quot;本篇是以面试者的第一视角来纪录可以当小说看本文超长建议闲着无聊时看&quot;&gt;本篇是以面试者的第一视角来纪录，可以当小说看，本文超长，建议闲着无聊时看～&lt;/h2&gt;

&lt;p&gt;作为一个开发码农，kubernetes 我是一点也不了解，看到题目一堆未知都东西。
jenkins 倒是玩过一点，jenkins  可以调 shell，写个脚本检测一下进城和 cpu 使用率，把 docker 塞给固定的机器。
ok，完美。先看一下 kubernetes 文档，看看 kubernetes 都能干啥&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://pingcap.com/meetup/meetup-84-20181220/&quot;&gt;找到了这篇&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;哦，kubernetes 可以实现自动调度，连脚本都不用写了，然后发现还有这个插件&lt;a href=&quot;https://plugins.jenkins.io/kubernetes/&quot;&gt;Kubernetes plugin for Jenkins&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;这不一会就搞定！然后我就去和 HR 小姐姐说：&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;看我给你表演一个绝活，12 个小时之内完成&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;然后她竟然要我表演一个 2h 的&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/img/jenkins_and_kubernetes/sticker_cao.jpg&quot; alt=&quot;草&quot; /&gt;&lt;/p&gt;

&lt;p&gt;看到这里你肯定想问我面的是那个职位，管他那，干就完了（其实我也不知道我面的是啥）&lt;/p&gt;

&lt;p&gt;之后我就在第二天提前下了个班，开始了我的地狱 12 小时之旅（&lt;/p&gt;

&lt;p&gt;解释一下：我为什么不在当天就开始，原因是，我昨天晚上去打包 iredis 了，一晚上没睡&lt;/p&gt;

&lt;div class=&quot;jekyll-twitter-plugin&quot;&gt;&lt;blockquote class=&quot;twitter-tweet&quot;&gt;&lt;p lang=&quot;zh&quot; dir=&quot;ltr&quot;&gt;为了学习 redis 我把 iredis 打包到 archlinuxcn 仓库。然后看到原来 aur 上的是 bin 包。研究了一晚上 iredis 的构建流程。顺便也把用的打包工具 pyoxidizer 也打包了。。最后把体积减少了一半多，让它走了系统库&lt;br /&gt;&lt;br /&gt;好了，我现在可以愉快的使用 redis 的命令行了。。折腾一晚上，redis 还一点没学（ &lt;a href=&quot;https://t.co/VTkjd47t6N&quot;&gt;pic.twitter.com/VTkjd47t6N&lt;/a&gt;&lt;/p&gt;&amp;mdash; 新一 (@_a_wing) &lt;a href=&quot;https://twitter.com/_a_wing/status/1350937185957113857?ref_src=twsrc%5Etfw&quot;&gt;January 17, 2021&lt;/a&gt;&lt;/blockquote&gt;
&lt;script async=&quot;&quot; src=&quot;https://platform.twitter.com/widgets.js&quot; charset=&quot;utf-8&quot;&gt;&lt;/script&gt;
&lt;/div&gt;

&lt;hr /&gt;

&lt;h2 id=&quot;奥利给真正的全栈可以解决任何问题&quot;&gt;奥利给：真正的全栈可以解决任何问题&lt;/h2&gt;

&lt;h3 id=&quot;准备工作&quot;&gt;准备工作&lt;/h3&gt;

&lt;p&gt;&lt;img src=&quot;/assets/img/jenkins_and_kubernetes/screenshot_2021-01-19_19-59-38.png&quot; alt=&quot;Start time&quot; /&gt;&lt;/p&gt;

&lt;p&gt;养成习惯，第一件事，看一下是哪个版本系统&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nb&quot;&gt;cat&lt;/span&gt; /etc/os-release
&lt;span class=&quot;nv&quot;&gt;NAME&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;CentOS Linux&quot;&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;VERSION&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;7 (Core)&quot;&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;ID&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;centos&quot;&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;ID_LIKE&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;rhel fedora&quot;&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;VERSION_ID&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;7&quot;&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;PRETTY_NAME&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;CentOS Linux 7 (Core)&quot;&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;ANSI_COLOR&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;0;31&quot;&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;CPE_NAME&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;cpe:/o:centos:centos:7&quot;&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;HOME_URL&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;https://www.centos.org/&quot;&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;BUG_REPORT_URL&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;https://bugs.centos.org/&quot;&lt;/span&gt;

&lt;span class=&quot;nv&quot;&gt;CENTOS_MANTISBT_PROJECT&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;CentOS-7&quot;&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;CENTOS_MANTISBT_PROJECT_VERSION&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;7&quot;&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;REDHAT_SUPPORT_PRODUCT&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;centos&quot;&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;REDHAT_SUPPORT_PRODUCT_VERSION&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;7&quot;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;完蛋了，我没用过 CentOS 系统，不过问题不大，记住这三个字母就行了 &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;yum&lt;/code&gt;&lt;/p&gt;

&lt;p&gt;查看基本信息备忘:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;版本 &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;cat /etc/os-release&lt;/code&gt;&lt;/li&gt;
  &lt;li&gt;时间 时区 &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;timedatectl status&lt;/code&gt; （这个不同发行版可能不同）&lt;/li&gt;
  &lt;li&gt;语言 &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;echo $LANG&lt;/code&gt;&lt;/li&gt;
  &lt;li&gt;网络 &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;ip addr&lt;/code&gt;&lt;/li&gt;
  &lt;li&gt;镜像站 &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;cat /etc/yum.repos.d/CentOS-Base.repo&lt;/code&gt;&lt;/li&gt;
  &lt;li&gt;cpu &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;cat /proc/cpuinfo&lt;/code&gt;&lt;/li&gt;
  &lt;li&gt;内存 &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;cat /proc/meminfo &amp;amp;&amp;amp; free -h&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;然后在 &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/etc/motd&lt;/code&gt; 留下笔记的链接（我就默认你们知道 &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;motd&lt;/code&gt;（message of the day） 是干啥用的了）&lt;/p&gt;

&lt;p&gt;更新：&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;yum upgrade&lt;/code&gt;&lt;/p&gt;

&lt;hr /&gt;

&lt;p&gt;&lt;a href=&quot;https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/install-kubeadm/&quot;&gt;首选看 kubernetes 文档，这篇是最关键的&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;了解了这三个模块&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;kubeadm&lt;/code&gt;: 这是一个启动器&lt;/li&gt;
  &lt;li&gt;&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;kubelet&lt;/code&gt;: 这玩意就是 kubernetes 的本体&lt;/li&gt;
  &lt;li&gt;&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;kubectl&lt;/code&gt;: 命令行控制程序&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;kubelet&lt;/code&gt; 每个都要有，但是 kubernetes 是个集群，启动的过程有些复杂，所以需要 &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;kubeadm&lt;/code&gt; 来帮助我们来启动的集群&lt;/p&gt;

&lt;p&gt;&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;kubectl&lt;/code&gt; 就是仅仅只是一个命令行客户端，在不在服务器上无所谓&lt;/p&gt;

&lt;p&gt;kubernetes 的运行时 CRI （Container Runtimes Interface）&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://kubernetes.io/docs/setup/production-environment/container-runtimes/&quot;&gt;官方文档指定了三个&lt;/a&gt;&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;containerd&lt;/li&gt;
  &lt;li&gt;CRI-O&lt;/li&gt;
  &lt;li&gt;Docker&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;鉴于 &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;containerd&lt;/code&gt; 和 &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;CRI-O&lt;/code&gt; 完全没听说过，我们直接从 &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;Docker&lt;/code&gt; 开始&lt;/p&gt;

&lt;h3 id=&quot;设置网桥&quot;&gt;设置网桥&lt;/h3&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nb&quot;&gt;cat&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;no&quot;&gt;EOF&lt;/span&gt;&lt;span class=&quot;sh&quot;&gt; | sudo tee /etc/modules-load.d/k8s.conf
br_netfilter
&lt;/span&gt;&lt;span class=&quot;no&quot;&gt;EOF

&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;cat&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;no&quot;&gt;EOF&lt;/span&gt;&lt;span class=&quot;sh&quot;&gt; | sudo tee /etc/sysctl.d/k8s.conf
net.bridge.bridge-nf-call-ip6tables = 1
net.bridge.bridge-nf-call-iptables = 1
&lt;/span&gt;&lt;span class=&quot;no&quot;&gt;EOF
&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;sudo &lt;/span&gt;sysctl &lt;span class=&quot;nt&quot;&gt;--system&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h3 id=&quot;docker&quot;&gt;Docker&lt;/h3&gt;

&lt;p&gt;安装 Docker ，没什么值得注意的，直接照着官方文档复制粘贴就行&lt;/p&gt;

&lt;p&gt;唯一值得注意的是&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-base&quot;&gt;mkdir -p /etc/systemd/system/docker.service.d
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;不设置 Docker 参数，这个是没用的。可以参照这两篇：&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://docs.docker.com/config/daemon/systemd/&quot;&gt;Docker daemon/systemd&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://wiki.archlinux.org/index.php/Systemd#Drop-in_files&quot;&gt;wiki.archlinux Systemd&lt;/a&gt;&lt;/p&gt;

&lt;h3 id=&quot;准备工作都做完了安装-kubernetes&quot;&gt;准备工作都做完了：安装 kubernetes&lt;/h3&gt;

&lt;p&gt;直接照着官方文档来：&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nb&quot;&gt;cat&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;no&quot;&gt;EOF&lt;/span&gt;&lt;span class=&quot;sh&quot;&gt; | sudo tee /etc/yum.repos.d/kubernetes.repo
[kubernetes]
name=Kubernetes
baseurl=https://packages.cloud.google.com/yum/repos/kubernetes-el7-&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\$&lt;/span&gt;&lt;span class=&quot;sh&quot;&gt;basearch
enabled=1
gpgcheck=1
repo_gpgcheck=1
gpgkey=https://packages.cloud.google.com/yum/doc/yum-key.gpg https://packages.cloud.google.com/yum/doc/rpm-package-key.gpg
exclude=kubelet kubeadm kubectl
&lt;/span&gt;&lt;span class=&quot;no&quot;&gt;EOF

&lt;/span&gt;&lt;span class=&quot;c&quot;&gt;# Set SELinux in permissive mode (effectively disabling it)&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;sudo &lt;/span&gt;setenforce 0
&lt;span class=&quot;nb&quot;&gt;sudo sed&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-i&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'s/^SELINUX=enforcing$/SELINUX=permissive/'&lt;/span&gt; /etc/selinux/config

&lt;span class=&quot;nb&quot;&gt;sudo &lt;/span&gt;yum &lt;span class=&quot;nb&quot;&gt;install&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-y&lt;/span&gt; kubelet kubeadm kubectl &lt;span class=&quot;nt&quot;&gt;--disableexcludes&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;kubernetes

&lt;span class=&quot;nb&quot;&gt;sudo &lt;/span&gt;systemctl &lt;span class=&quot;nb&quot;&gt;enable&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;--now&lt;/span&gt; kubelet
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;由于对版本有要求，所以那个软件源禁用了那三个包（防止 &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;upgrade&lt;/code&gt; 时挂掉）&lt;/p&gt;

&lt;p&gt;不要在意 &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;systemctl status kubelet&lt;/code&gt; 的错误，因为：&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;root@10-8-19-173 ~]# systemctl &lt;span class=&quot;nb&quot;&gt;cat &lt;/span&gt;kubelet
&lt;span class=&quot;c&quot;&gt;# /usr/lib/systemd/system/kubelet.service&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;Unit]
&lt;span class=&quot;nv&quot;&gt;Description&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;kubelet: The Kubernetes Node Agent
&lt;span class=&quot;nv&quot;&gt;Documentation&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;https://kubernetes.io/docs/
&lt;span class=&quot;nv&quot;&gt;Wants&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;network-online.target
&lt;span class=&quot;nv&quot;&gt;After&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;network-online.target

&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;Service]
&lt;span class=&quot;nv&quot;&gt;ExecStart&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;/usr/bin/kubelet
&lt;span class=&quot;nv&quot;&gt;Restart&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;always
&lt;span class=&quot;nv&quot;&gt;StartLimitInterval&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;0
&lt;span class=&quot;nv&quot;&gt;RestartSec&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;10

&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;Install]
&lt;span class=&quot;nv&quot;&gt;WantedBy&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;multi-user.target

&lt;span class=&quot;c&quot;&gt;# /usr/lib/systemd/system/kubelet.service.d/10-kubeadm.conf&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# Note: This dropin only works with kubeadm and kubelet v1.11+&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;Service]
&lt;span class=&quot;nv&quot;&gt;Environment&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;KUBELET_KUBECONFIG_ARGS=--bootstrap-kubeconfig=/etc/kubernetes/bootstrap-kubelet.conf --kubeconfig=/etc/kubernetes/kubelet.conf&quot;&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;Environment&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;KUBELET_CONFIG_ARGS=--config=/var/lib/kubelet/config.yaml&quot;&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# This is a file that &quot;kubeadm init&quot; and &quot;kubeadm join&quot; generates at runtime, populating the KUBELET_KUBEADM_ARGS variable dynamically&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;EnvironmentFile&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;-/var/lib/kubelet/kubeadm-flags.env
&lt;span class=&quot;c&quot;&gt;# This is a file that the user can use for overrides of the kubelet args as a last resort. Preferably, the user should use&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# the .NodeRegistration.KubeletExtraArgs object in the configuration files instead. KUBELET_EXTRA_ARGS should be sourced from this file.&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;EnvironmentFile&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;-/etc/sysconfig/kubelet
&lt;span class=&quot;nv&quot;&gt;ExecStart&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;ExecStart&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;/usr/bin/kubelet &lt;span class=&quot;nv&quot;&gt;$KUBELET_KUBECONFIG_ARGS&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$KUBELET_CONFIG_ARGS&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$KUBELET_KUBEADM_ARGS&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$KUBELET_EXTRA_ARGS&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;在 master 上执行&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;kubeadm init
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;根据提示在两个 slave 上都执行&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;kubeadm &lt;span class=&quot;nb&quot;&gt;join &lt;/span&gt;10.8.19.173:6443 &lt;span class=&quot;nt&quot;&gt;--token&lt;/span&gt; yv1ecz.8g7j4d1hztx3cnf6 &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
    &lt;span class=&quot;nt&quot;&gt;--discovery-token-ca-cert-hash&lt;/span&gt; sha256:dc1778180a75dbf321463dd17897d2357fde5c69756342671cef5048eaf01249
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;然后按照提示在 master 配置 &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;kubectl&lt;/code&gt; 都配置文件&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nb&quot;&gt;mkdir&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-p&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$HOME&lt;/span&gt;/.kube
&lt;span class=&quot;nb&quot;&gt;cp&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-i&lt;/span&gt; /etc/kubernetes/admin.conf &lt;span class=&quot;nv&quot;&gt;$HOME&lt;/span&gt;/.kube/config
&lt;span class=&quot;nb&quot;&gt;chown&lt;/span&gt; &lt;span class=&quot;si&quot;&gt;$(&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;id&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-u&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;)&lt;/span&gt;:&lt;span class=&quot;si&quot;&gt;$(&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;id&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-g&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$HOME&lt;/span&gt;/.kube/config
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;img src=&quot;/assets/img/jenkins_and_kubernetes/screenshot_2021-01-20_00-07-57.png&quot; alt=&quot;Uptime&quot; /&gt;&lt;/p&gt;

&lt;h4 id=&quot;跑起来了跑起来了此时已经是到了凌晨了&quot;&gt;&lt;strong&gt;跑起来了，跑起来了！！！此时已经是到了凌晨了&lt;/strong&gt;&lt;/h4&gt;

&lt;p&gt;现在可以看到状态是 &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;NotReady&lt;/code&gt;&lt;/p&gt;

&lt;p&gt;是因为缺少 CNI （Container Network Interface）&lt;/p&gt;

&lt;p&gt;网络使用这个，因为可以不用设置&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;kubectl apply &lt;span class=&quot;nt&quot;&gt;-f&lt;/span&gt; https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;虽然官方使用 &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;Calico&lt;/code&gt; 来测试的&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://docs.projectcalico.org/getting-started/kubernetes/flannel/migration-from-flannel&quot;&gt;有迁移办法方法问题不大&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;kubeadm init&lt;/code&gt; 设置参数有问题，忘记设置网络了&lt;/p&gt;

&lt;p&gt;在全部的机器上执行 &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;kubeadm reset&lt;/code&gt;，关闭集群&lt;/p&gt;

&lt;p&gt;人生重来，重新开始&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;kubeadm init &lt;span class=&quot;nt&quot;&gt;--pod-network-cidr&lt;/span&gt; 192.168.0.0/16
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;每次生成的 &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/etc/kubernetes/admin.conf&lt;/code&gt; 里面的内容都是不同的，reset 之后要重新设置&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c&quot;&gt;# To start using your cluster, you need to run the following as a regular user:&lt;/span&gt;

&lt;span class=&quot;nb&quot;&gt;mkdir&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-p&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$HOME&lt;/span&gt;/.kube
&lt;span class=&quot;nb&quot;&gt;sudo cp&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-i&lt;/span&gt; /etc/kubernetes/admin.conf &lt;span class=&quot;nv&quot;&gt;$HOME&lt;/span&gt;/.kube/config
&lt;span class=&quot;nb&quot;&gt;sudo chown&lt;/span&gt; &lt;span class=&quot;si&quot;&gt;$(&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;id&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-u&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;)&lt;/span&gt;:&lt;span class=&quot;si&quot;&gt;$(&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;id&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-g&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$HOME&lt;/span&gt;/.kube/config
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;img src=&quot;/assets/img/jenkins_and_kubernetes/screenshot_2021-01-20_02-06-02.png&quot; alt=&quot;Ready&quot; /&gt;&lt;/p&gt;

&lt;p&gt;看集群状态：&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;kubectl get pods &lt;span class=&quot;nt&quot;&gt;--all-namespaces&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;jenkins&quot;&gt;Jenkins&lt;/h2&gt;

&lt;p&gt;&lt;a href=&quot;https://www.jenkins.io/doc/book/installing/linux/#red-hat-centos&quot;&gt;安装 Jenkins，直接照着官方文档&lt;/a&gt;&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nb&quot;&gt;sudo &lt;/span&gt;wget &lt;span class=&quot;nt&quot;&gt;-O&lt;/span&gt; /etc/yum.repos.d/jenkins.repo &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
    https://pkg.jenkins.io/redhat-stable/jenkins.repo
&lt;span class=&quot;nb&quot;&gt;sudo &lt;/span&gt;rpm &lt;span class=&quot;nt&quot;&gt;--import&lt;/span&gt; https://pkg.jenkins.io/redhat-stable/jenkins.io.key
&lt;span class=&quot;nb&quot;&gt;sudo &lt;/span&gt;yum upgrade
&lt;span class=&quot;nb&quot;&gt;sudo &lt;/span&gt;yum &lt;span class=&quot;nb&quot;&gt;install &lt;/span&gt;jenkins java-1.8.0-openjdk-devel
&lt;span class=&quot;nb&quot;&gt;sudo &lt;/span&gt;systemctl daemon-reload
&lt;span class=&quot;nb&quot;&gt;sudo &lt;/span&gt;systemctl start jenkins
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;之后初始化 Jenkins，填入初始密码，然后一路下一步&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nb&quot;&gt;cat&lt;/span&gt; /var/lib/jenkins/secrets/initialAdminPassword
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;新建的管理员用户的密码可以使用随机生成的密码&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;hexdump &lt;span class=&quot;nt&quot;&gt;-v&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-n&lt;/span&gt; 16 &lt;span class=&quot;nt&quot;&gt;-e&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'1/1 &quot;%02x&quot;'&lt;/span&gt; /dev/urandom
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h3 id=&quot;kubernetes-plugin-for-jenkins&quot;&gt;Kubernetes plugin for Jenkins&lt;/h3&gt;

&lt;p&gt;安装 Jenkins 的插件&lt;/p&gt;

&lt;p&gt;使用 Secret File (kubeconfig file)&lt;/p&gt;

&lt;p&gt;配置 Kubernetes 地址 &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;localhost:6443&lt;/code&gt;&lt;/p&gt;

&lt;h2 id=&quot;好build-开始&quot;&gt;好，build 开始&lt;/h2&gt;

&lt;p&gt;发现问题：&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;root@10-8-19-173 ~]# kubectl logs &lt;span class=&quot;nt&quot;&gt;-f&lt;/span&gt; pods/tidb2-6-0132h-p44wx-86k7l jnlp
Jan 19, 2021 9:06:17 PM hudson.remoting.jnlp.Main createEngine
INFO: Setting up agent: tidb2-6-0132h-p44wx-86k7l
Jan 19, 2021 9:06:17 PM hudson.remoting.jnlp.Main&lt;span class=&quot;nv&quot;&gt;$CuiListener&lt;/span&gt; &amp;lt;init&amp;gt;
INFO: Jenkins agent is running &lt;span class=&quot;k&quot;&gt;in &lt;/span&gt;headless mode.
Jan 19, 2021 9:06:17 PM hudson.remoting.Engine startEngine
INFO: Using Remoting version: 4.3
Jan 19, 2021 9:06:17 PM org.jenkinsci.remoting.engine.WorkDirManager initializeWorkDir
INFO: Using /home/jenkins/agent/remoting as a remoting work directory
Jan 19, 2021 9:06:17 PM org.jenkinsci.remoting.engine.WorkDirManager setupLogging
INFO: Both error and output logs will be printed to /home/jenkins/agent/remoting
Jan 19, 2021 9:06:17 PM hudson.remoting.jnlp.Main&lt;span class=&quot;nv&quot;&gt;$CuiListener&lt;/span&gt; status
INFO: Locating server among &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;http://152.32.240.177:8080/]
Jan 19, 2021 9:06:47 PM hudson.remoting.jnlp.Main&lt;span class=&quot;nv&quot;&gt;$CuiListener&lt;/span&gt; error
SEVERE: Failed to connect to http://152.32.240.177:8080/tcpSlaveAgentListener/: connect timed out
java.io.IOException: Failed to connect to http://152.32.240.177:8080/tcpSlaveAgentListener/: connect timed out
        at org.jenkinsci.remoting.engine.JnlpAgentEndpointResolver.resolve&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;JnlpAgentEndpointResolver.java:217&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
        at hudson.remoting.Engine.innerRun&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;Engine.java:693&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
        at hudson.remoting.Engine.run&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;Engine.java:518&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
Caused by: java.net.SocketTimeoutException: connect timed out
        at java.net.PlainSocketImpl.socketConnect&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;Native Method&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
        at java.net.AbstractPlainSocketImpl.doConnect&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;AbstractPlainSocketImpl.java:350&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
        at java.net.AbstractPlainSocketImpl.connectToAddress&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;AbstractPlainSocketImpl.java:206&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
        at java.net.AbstractPlainSocketImpl.connect&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;AbstractPlainSocketImpl.java:188&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
        at java.net.SocksSocketImpl.connect&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;SocksSocketImpl.java:392&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
        at java.net.Socket.connect&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;Socket.java:607&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
        at sun.net.NetworkClient.doConnect&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;NetworkClient.java:175&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
        at sun.net.www.http.HttpClient.openServer&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;HttpClient.java:463&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
        at sun.net.www.http.HttpClient.openServer&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;HttpClient.java:558&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
        at sun.net.www.http.HttpClient.&amp;lt;init&amp;gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;HttpClient.java:242&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
        at sun.net.www.http.HttpClient.New&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;HttpClient.java:339&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
        at sun.net.www.http.HttpClient.New&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;HttpClient.java:357&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
        at sun.net.www.protocol.http.HttpURLConnection.getNewHttpClient&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;HttpURLConnection.java:1226&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
        at sun.net.www.protocol.http.HttpURLConnection.plainConnect0&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;HttpURLConnection.java:1162&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
        at sun.net.www.protocol.http.HttpURLConnection.plainConnect&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;HttpURLConnection.java:1056&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
        at sun.net.www.protocol.http.HttpURLConnection.connect&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;HttpURLConnection.java:990&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
        at org.jenkinsci.remoting.engine.JnlpAgentEndpointResolver.resolve&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;JnlpAgentEndpointResolver.java:214&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
        ... 2 more
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;目前产生了一个问题：&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;Jenkins → Kubernetes （正常）&lt;/li&gt;
  &lt;li&gt;Kubernetes → Jenkins（迷之 connect timed out）&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;改变 Jenkins 设置&lt;/p&gt;

&lt;p&gt;这个插件的工作原理是这样的：&lt;/p&gt;

&lt;p&gt;在 Kubernetes 创建一个 pods，这个 pods 里面有两个容器。
一个是构建用的，另一个是负责收集构建容器输出的日志传回 Jenkins 主程序&lt;/p&gt;

&lt;p&gt;收集日志的容器会主动链接主程序，可以使用 &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;http&lt;/code&gt;, &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;websocket&lt;/code&gt;, &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;tcp&lt;/code&gt; 来通信&lt;/p&gt;

&lt;p&gt;这几种方式我都测试过了，然后也把 Jenkins 都权限一路开到最大，仍然无法通信&lt;/p&gt;

&lt;p&gt;一路把权限开到最大还是不行。。。我真的怀疑这个容器的网有问题&lt;/p&gt;

&lt;h2 id=&quot;验证-kubernetes-的内部网络&quot;&gt;验证 Kubernetes 的内部网络&lt;/h2&gt;

&lt;p&gt;先在宿主机上安装 nc 工具。（&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;netcat&lt;/code&gt;）&lt;/p&gt;

&lt;p&gt;随便起一个 Tcp server&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;nc &lt;span class=&quot;nt&quot;&gt;-l&lt;/span&gt; 8877
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;把 jenkins kubernetes 的插件设置改到刚开到那个端口（ 8877 那个 ），要用 http 的方式（当然 websocket 也可以）&lt;/p&gt;

&lt;p&gt;根据 http 1.x 的原理，http 是明文传输，是可以在 nc 起的 server 里面看到 http 头的
&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;websocket&lt;/code&gt; 也是先发个 http 包，之后 Upgrade&lt;/p&gt;

&lt;p&gt;你可以用这两条来验证我说的：&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;nc &lt;span class=&quot;nt&quot;&gt;-l&lt;/span&gt; 8877
curl localhost:8877
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;测试结果&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/img/jenkins_and_kubernetes/screenshot_2021-01-20_06-27-35.png&quot; alt=&quot;netcat&quot; /&gt;&lt;/p&gt;

&lt;p&gt;收集日志的容器网不通&lt;/p&gt;

&lt;p&gt;根据这个插件原理：&lt;/p&gt;

&lt;p&gt;这个是日志收集容器 &lt;a href=&quot;https://hub.docker.com/r/jenkins/inbound-agent&quot;&gt;Docker Hub&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;照着这个文件画瓢 &lt;a href=&quot;https://k8s.io/examples/application/shell-demo.yaml&quot;&gt;&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;https://k8s.io/examples/application/shell-demo.yaml&lt;/code&gt;&lt;/a&gt;&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nb&quot;&gt;cat&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; jenkins.yaml &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;EOF&lt;/span&gt;&lt;span class=&quot;sh&quot;&gt;
apiVersion: v1
kind: Pod
metadata:
  name: jenkins-demo
spec:
  volumes:
  - name: shared-data
    emptyDir: {}
  containers:
  - name: agent
    image: jenkins/inbound-agent
  hostNetwork: true
  dnsPolicy: Default
&lt;/span&gt;&lt;span class=&quot;no&quot;&gt;EOF
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;起个容器&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;kubectl create &lt;span class=&quot;nt&quot;&gt;-f&lt;/span&gt; jenkins.yaml

&lt;span class=&quot;c&quot;&gt;# 然后就挂了&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;root@10-8-19-173 ~]# kubectl get pods
NAME                         READY   STATUS             RESTARTS   AGE
jenkins-demo                 0/1     CrashLoopBackOff   7          13m
shell-demo                   1/1     Running            0          98m
tidb2-13-dn3zw-tsdqp-6l0z6   1/2     Terminating        0          43s
tidb2-13-dn3zw-tsdqp-qmrjn   2/2     Running            0          3s
tidb2-13-dn3zw-tsdqp-vtmxg   0/2     Terminating        0          2m3s
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;root@10-8-19-173 ~]#
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;这个东西有四个变量。。。啊，不知道该怎么传变量啊。。。&lt;/p&gt;

&lt;p&gt;找到这篇文档&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.20/&quot;&gt;https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.20/&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://kubernetes.io/docs/tasks/inject-data-application/define-environment-variable-container/&quot;&gt;Define Environment Variables for a Container&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;看日志。。。这该死的容器好像不听我的。。。&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;kubectl logs &lt;span class=&quot;nt&quot;&gt;-f&lt;/span&gt; pods/jenkins-demo agent
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;查看 Jenkins 起动的 pods 的环境变量&lt;/p&gt;

&lt;p&gt;&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;kubectl describe pods/tidb2-13-dn3zw-tsdqp-ms1l&lt;/code&gt;&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;    Environment:
      JENKINS_SECRET:         fe2e12708ad3b3daa74f5c7e253ab1e8620901255927238ad7444aba650a3e3e
      JENKINS_AGENT_NAME:     tidb2-13-dn3zw-tsdqp-ms1ls
      JENKINS_NAME:           tidb2-13-dn3zw-tsdqp-ms1ls
      JENKINS_AGENT_WORKDIR:  /home/jenkins/agent
      JENKINS_URL:            http://152.32.240.177:8877/
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;加上变量，故技重施&lt;/p&gt;

&lt;p&gt;改成一样的参数也是可以好使的。。。。&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;root@10-8-19-173 ~]# &lt;span class=&quot;nb&quot;&gt;cat &lt;/span&gt;jenkins.yaml
apiVersion: v1
kind: Pod
metadata:
  name: jenkins-demo
spec:
  volumes:
  - name: shared-data
    emptyDir: &lt;span class=&quot;o&quot;&gt;{}&lt;/span&gt;
  containers:
  - name: agent
    image: jenkins/inbound-agent
    &lt;span class=&quot;nb&quot;&gt;env&lt;/span&gt;:
    - name:  JENKINS_SECRET
      value: fe2e12708ad3b3daa74f5c7e253ab1e8620901255927238ad7444aba650a3e3e
    - name:  JENKINS_AGENT_NAME
      value: tidb2-13-dn3zw-tsdqp-ms1ls
    - name:  JENKINS_NAME
      value: tidb2-13-dn3zw-tsdqp-ms1ls
    - name:  JENKINS_AGENT_WORKDIR
      value: /home/jenkins/agent
    - name:  JENKINS_URL
      value: http://152.32.240.177:8877/
  hostNetwork: &lt;span class=&quot;nb&quot;&gt;true
  &lt;/span&gt;dnsPolicy: Default
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;img src=&quot;/assets/img/jenkins_and_kubernetes/screenshot_2021-01-20_07-23-51.png&quot; alt=&quot;jenkins network&quot; /&gt;&lt;/p&gt;

&lt;p&gt;这个是好用的。我人傻了。。。&lt;/p&gt;

&lt;p&gt;对比环境变量，完全一致&lt;/p&gt;

&lt;p&gt;&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;kubectl describe pods/jenkins-demo&lt;/code&gt;&lt;/p&gt;

&lt;p&gt;&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;kubectl describe pods/tidb2-13-dn3zw-tsdqp-ms1l&lt;/code&gt;&lt;/p&gt;

&lt;h2 id=&quot;然后我该怎么处理没思路了&quot;&gt;&lt;strong&gt;然后我该怎么处理。。。。没思路了&lt;/strong&gt;&lt;/h2&gt;

&lt;p&gt;我好菜啊，还剩最后一步，不知道该怎么解决了。。。&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;搭建 Kubernetes 花了四个小时&lt;/li&gt;
  &lt;li&gt;在 Jenkins 那个接口上花了尽五个小时&lt;/li&gt;
  &lt;li&gt;加上剩下的总计花费了十二个小时&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;此时已经是早上八点了，不搞了，去睡觉&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/img/jenkins_and_kubernetes/screenshot_2021-01-20_07-52-08.png&quot; alt=&quot;current&quot; /&gt;&lt;/p&gt;

&lt;hr /&gt;

&lt;p&gt;睡了一觉，一觉醒来&lt;/p&gt;

&lt;p&gt;仔细看了配置，发现&lt;/p&gt;

&lt;div class=&quot;language-yaml highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;na&quot;&gt;hostNetwork&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;true&lt;/span&gt;
&lt;span class=&quot;na&quot;&gt;dnsPolicy&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;Default&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Jenkins 的 manifest 和我拉下来测试的 manifest 网络部分有不一样的地方&lt;/p&gt;

&lt;p&gt;经过测试是 &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;hostNetwork: true&lt;/code&gt; 的影响&lt;/p&gt;

&lt;p&gt;&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;hostNetwork&lt;/code&gt; 这个参数是 &lt;a href=&quot;https://kubernetes.io/docs/concepts/policy/pod-security-policy/#host-namespaces&quot;&gt;使用本机的网络&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;这说明我 Kubernetes 目前是没法联网的&lt;/p&gt;

&lt;h3 id=&quot;写构建过程&quot;&gt;写构建过程&lt;/h3&gt;

&lt;div class=&quot;language-groovy highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;n&quot;&gt;podTemplate&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nl&quot;&gt;yaml:&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'''
apiVersion: v1
kind: Pod
spec:
  containers:
  - name: golang
    image: golang:1.13.0
    command:
    - sleep
    args:
    - infinity
  hostNetwork: true
  dnsPolicy: Default
'''&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;node&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;POD_LABEL&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;stage&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'Build TiDB'&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
            &lt;span class=&quot;n&quot;&gt;git&lt;/span&gt; &lt;span class=&quot;nl&quot;&gt;url:&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'https://github.com/pingcap/tidb.git'&lt;/span&gt;
            &lt;span class=&quot;n&quot;&gt;container&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'golang'&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
                &lt;span class=&quot;n&quot;&gt;stage&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'Build a TiDB'&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
                    &lt;span class=&quot;n&quot;&gt;sh&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&quot;&quot;
                    make server

                    cd bin
                    sha1sum tidb-server &amp;gt; tidb-server.sha1sum
                    sha512sum tidb-server &amp;gt; tidb-server.sha512sum
                    &quot;&quot;&quot;&lt;/span&gt;
                &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
            &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
            &lt;span class=&quot;n&quot;&gt;archiveArtifacts&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'bin/*'&lt;/span&gt;
        &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;

    &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;img src=&quot;/assets/img/jenkins_and_kubernetes/screenshot_2021-01-20_13-51-20.png&quot; alt=&quot;Jenkins&quot; /&gt;&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/img/jenkins_and_kubernetes/screenshot_2021-01-20_13-48-15.png&quot; alt=&quot;Kubernetes&quot; /&gt;&lt;/p&gt;

&lt;p&gt;如果重点是：&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;k8s 作为 Jenkins 的 Work Node 自动调度&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;我觉得我已经完成了（作为一个 demo 来说），虽然 Jenkins 还需要手动点 build （重点不在这吧），构建结果只提供了 linux x86_64 的 bin 包&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/img/jenkins_and_kubernetes/sticker_power.png&quot; alt=&quot;power&quot; /&gt;&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;预计花费时间 12h&lt;/li&gt;
  &lt;li&gt;总计花费时间 14h&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;完成时间 &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;Wed Jan 20 13:49:15 CST 2021&lt;/code&gt;&lt;/p&gt;

&lt;h1 id=&quot;之后的思考&quot;&gt;之后的思考&lt;/h1&gt;

&lt;h3 id=&quot;尝试在自己笔记本上远程控制&quot;&gt;尝试在自己笔记本上远程控制&lt;/h3&gt;

&lt;p&gt;启动时要指定连接 ip 。vps 是 basic nat 转换的，拿到的 ip  是私有地址&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c&quot;&gt;# 在自己的笔记本安装 kubectl&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;mkdir&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-p&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$HOME&lt;/span&gt;/.kube
scp root@152.32.240.177:/etc/kubernetes/admin.conf &lt;span class=&quot;nv&quot;&gt;$HOME&lt;/span&gt;/.kube/config

kubectl get nodes
Unable to connect to the server: x509: certificate is valid &lt;span class=&quot;k&quot;&gt;for &lt;/span&gt;10.96.0.1, 10.8.19.173, not 152.32.240.177

&lt;span class=&quot;c&quot;&gt;# 可以跳过证书。（逃&lt;/span&gt;
kubectl &lt;span class=&quot;nt&quot;&gt;--insecure-skip-tls-verify&lt;/span&gt; get nodes
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;发动技能，“人生重来“，&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;reset&lt;/code&gt; 之后再 &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;init&lt;/code&gt; 加上这个参数&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;kubeadm init &lt;span class=&quot;nt&quot;&gt;--apiserver-advertise-address&lt;/span&gt; 152.32.240.177 &lt;span class=&quot;nt&quot;&gt;--pod-network-cidr&lt;/span&gt; 192.168.0.0/16
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;a href=&quot;https://kubernetes.io/docs/reference/setup-tools/kubeadm/kubeadm-init/#options&quot;&gt;kubeadm init&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;问题来了。。。我能不能不 &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;reset&lt;/code&gt; 再 &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;init&lt;/code&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://stackoverflow.com/questions/52915110/unable-to-connect-to-the-server-x509-certificate-is-valid-for&quot;&gt;Unable to connect to the server: x509: certificate is valid for&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;不过大体思路是有的：自己生成一个 tls 证书，把公共的 ip 写进去&lt;/p&gt;

&lt;p&gt;这个地方是由 &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/etc/kubernetes/manifests/kube-apiserver.yaml&lt;/code&gt; 文件起的 pod&lt;/p&gt;

&lt;p&gt;修改这个，然后再 apply ，应该可行&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;kubectl apply &lt;span class=&quot;nt&quot;&gt;-f&lt;/span&gt; /etc/kubernetes/manifests/kube-apiserver.yaml
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;a href=&quot;https://kubernetes.io/docs/reference/command-line-tools-reference/kube-apiserver/&quot;&gt;不过 &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;apiserver&lt;/code&gt; 似乎并不生成证书&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;后来又翻到了这篇：&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://stackoverflow.com/questions/46360361/invalid-x509-certificate-for-kubernetes-master&quot;&gt;Invalid x509 certificate for kubernetes master&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;直接两行解决&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nb&quot;&gt;rm&lt;/span&gt; /etc/kubernetes/pki/apiserver.&lt;span class=&quot;k&quot;&gt;*&lt;/span&gt;
kubeadm init phase certs all &lt;span class=&quot;nt&quot;&gt;--apiserver-advertise-address&lt;/span&gt; 152.32.240.177
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;肯定会有人有疑问。。。&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/etc/kubernetes/admin.conf&lt;/code&gt; 更新了吗？&lt;/p&gt;

&lt;p&gt;没有，那里面写的是根证书&lt;/p&gt;

&lt;p&gt;根证书在这里：&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/etc/kubernetes/pki/ca.crt&lt;/code&gt;&lt;/p&gt;

&lt;p&gt;&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/etc/kubernetes/admin.conf&lt;/code&gt; 里的 clusters &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;certificate-authority-data&lt;/code&gt; 可以通过这条命令生成&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c&quot;&gt;# certificate-authority-data&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;cat&lt;/span&gt; /etc/kubernetes/pki/ca.crt | &lt;span class=&quot;nb&quot;&gt;base64&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-w&lt;/span&gt; 0
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;当然，用 &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;openssl x509&lt;/code&gt; 去生成一个证书应该也是可行的&lt;/p&gt;

&lt;h2 id=&quot;面试&quot;&gt;面试&lt;/h2&gt;

&lt;p&gt;之后就是和面试官聊了&lt;/p&gt;

&lt;p&gt;我专门找 HR 确认了，面试官不是出题人，应该不会谈面试题&lt;/p&gt;

&lt;p&gt;我很慌，万一考了 &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;动态规划&lt;/code&gt; 和 &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;图论&lt;/code&gt; 我估计就挂了&lt;/p&gt;

&lt;p&gt;然后，倒是没聊什么技术，就聊了聊产品和原来做的东西。。。。&lt;/p&gt;

&lt;p&gt;然后我就挂了&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;面试官内心 OS：这家伙说话声音难听，语速又贼快，随便编个理由把它挂了吧&lt;/p&gt;

  &lt;p&gt;理由就叫：就叫没讲清楚你干了啥吧&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;我：？？？？？？？&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/img/jenkins_and_kubernetes/sticker_think.jpg&quot; alt=&quot;太奇怪了，准备用脑子想&quot; /&gt;&lt;/p&gt;

&lt;p&gt;等着，这就去学伪声（x&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;这就和面试进门先迈哪只脚一样，反正看你不爽，你先迈哪只脚都不对（&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h2 id=&quot;总结&quot;&gt;总结&lt;/h2&gt;

&lt;p&gt;我觉得我被莫名其妙拉过去面试，然后又莫名其妙挂掉了&lt;/p&gt;

&lt;p&gt;可能是我不够 Match 。我也觉得我不 Match，毕竟我原来做的东西和 PingCAP 做的东西基本上没啥相关性&lt;/p&gt;

&lt;p&gt;不过，没啥相关性别拉我过去做题啊。（我每天忙的要死&lt;/p&gt;

&lt;p&gt;啊，对了。我还不知道我面的是啥岗位那（&lt;/p&gt;

&lt;p&gt;挂掉这一面没有问技术是我最出乎意料掉一点，昨天晚上我还在研究会问什么题那（x&lt;/p&gt;

&lt;p&gt;还有就是所属行业不同，我没有交代清楚背景，和为什么要这么做。&lt;/p&gt;

&lt;p&gt;&lt;del&gt;最后的总结就是：&lt;strong&gt;PingCAP 这家不按套路出牌&lt;/strong&gt; 和 &lt;strong&gt;我的吹牛技术还不够资深&lt;/strong&gt;&lt;/del&gt;&lt;/p&gt;

&lt;p&gt;面试题我和 HR 确认过了，是可以发 blog 的&lt;/p&gt;

&lt;h2 id=&quot;反省&quot;&gt;反省&lt;/h2&gt;

&lt;p&gt;我挂掉是我的问题，我不应该假定别人有相应的基础知识。&lt;/p&gt;

&lt;p&gt;上次去分享 WebRTC 的时候也是，我假定大家都懂 NAT （我不该这么假定）&lt;/p&gt;

&lt;p&gt;一上来就讲原理，大家甚至都不知道这个东西是什么，也不知这东西有什么用&lt;/p&gt;

&lt;p&gt;讲的内容又过于硬核，语速又超快
（之后被朋友批评了一顿，又在同一个地方栽跟头了）&lt;/p&gt;

&lt;p&gt;还有这篇文章，我又双叒叕的假定了大家都知道 &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/etc/motd&lt;/code&gt; 是干什么用的&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/etc/motd&lt;/code&gt; 内容的会在用户成功登录后由 Unix 登录命令显示，&lt;/p&gt;

  &lt;p&gt;整个过程发生在 shell 登录之前。&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;立个 Flag 吧：我要让你们都知道，我这几年干了啥！&lt;/p&gt;</content><author><name>Metal A-wing</name></author><category term="kubernetes" /><summary type="html">看我给你表演一个绝活，12 个小时之内完成</summary><media:thumbnail xmlns:media="http://search.yahoo.com/mrss/" url="https://a-wing.top/assets/img/jenkins_and_kubernetes/sticker_think.jpg" /><media:content medium="image" url="https://a-wing.top/assets/img/jenkins_and_kubernetes/sticker_think.jpg" xmlns:media="http://search.yahoo.com/mrss/" /></entry><entry><title type="html">MQTT 踩坑指南</title><link href="https://a-wing.top/iot/2020/12/05/mqtt.html" rel="alternate" type="text/html" title="MQTT 踩坑指南" /><published>2020-12-05T09:00:00+00:00</published><updated>2020-12-05T09:00:00+00:00</updated><id>https://a-wing.top/iot/2020/12/05/mqtt</id><content type="html" xml:base="https://a-wing.top/iot/2020/12/05/mqtt.html">&lt;p&gt;MQTT（Message Queuing Telemetry Transport 消息队列遥测传输协议）
是一种基于发布/订阅（publish/subscribe）模式的 “轻量级” 通讯协议，该协议构建于 TCP/IP 协议上，最早由 IBM 在 1999 年发布。
目前由 OASIS 维护 &lt;a href=&quot;https://mqtt.org&quot;&gt;MQTT&lt;/a&gt; 标准&lt;/p&gt;

&lt;blockquote&gt;
  &lt;h3 id=&quot;oasis-这个组织维护的标准大部分人应该都没听说过&quot;&gt;OASIS 这个组织维护的标准大部分人应该都没听说过&lt;/h3&gt;

  &lt;p&gt;不过 AMQP — Advanced Message Queuing Protocol 大概不用多说 。。。大名鼎鼎的 RabbitMQ 就是实现的这个协议&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;MQTT 最大优点在于，可以以极少的代码和有限的带宽，为连接远程设备提供实时可靠的消息服务。作为一种低开销、低带宽占用的即时通讯协议，使其在物联网、小型设备、移动应用等方面有较广泛的应用。&lt;/p&gt;

&lt;p&gt;实现MQTT协议需要客户端和服务器端通讯完成，在通讯过程中，MQTT协议中有三种身份：发布者（Publish）、代理（Broker）（服务器）、订阅者（Subscribe）。其中，消息的发布者和订阅者都是客户端，消息代理是服务器，消息发布者可以同时是订阅者。&lt;/p&gt;

&lt;p&gt;MQTT传输的消息分为：主题（Topic）和负载（payload）两部分&lt;/p&gt;

&lt;p&gt;由于物联网的环境是非常特别的，所以MQTT遵循以下设计原则：&lt;/p&gt;

&lt;ol&gt;
  &lt;li&gt;精简，不添加可有可无的功能；&lt;/li&gt;
  &lt;li&gt;发布/订阅（Pub/Sub）模式，方便消息在传感器之间传递；&lt;/li&gt;
  &lt;li&gt;允许用户动态创建主题，零运维成本；&lt;/li&gt;
  &lt;li&gt;把传输量降到最低以提高传输效率；&lt;/li&gt;
  &lt;li&gt;把低带宽、高延迟、不稳定的网络等因素考虑在内；&lt;/li&gt;
  &lt;li&gt;支持连续的会话控制；&lt;/li&gt;
  &lt;li&gt;理解客户端计算能力可能很低；&lt;/li&gt;
  &lt;li&gt;提供服务质量管理；&lt;/li&gt;
  &lt;li&gt;假设数据不可知，不强求传输数据的类型与格式，保持灵活性。&lt;/li&gt;
&lt;/ol&gt;

&lt;h3 id=&quot;clientid&quot;&gt;ClientID&lt;/h3&gt;

&lt;p&gt;这个必须是唯一的。如果没有设置就会随机生成一个&lt;/p&gt;

&lt;p&gt;如果有 &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;ClientID&lt;/code&gt; 相同的就会把之前的挤掉&lt;/p&gt;

&lt;h3 id=&quot;last-will-遗愿消息&quot;&gt;Last Will （遗愿消息）&lt;/h3&gt;

&lt;p&gt;MQTT 客户端向服务器端 &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;CONNECT&lt;/code&gt; 请求时，可以设置是否发送遗愿消息(Will Message)标志，和遗愿消息主题(Topic)与内容(Payload)。&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;注：&lt;/p&gt;

  &lt;p&gt;遗愿消息只有 &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;CONNECT&lt;/code&gt; 才能设置&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;MQTT 客户端异常下线时(客户端断开前未向服务器发送 DISCONNECT 消息)，MQTT 消息服务器会发布遗愿消息。&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;如果你想区分连接状态（网络错误和主动关闭）的话
应该自定义一个状态的 topic 配合 Last Will 来使用&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h3 id=&quot;retain驻留&quot;&gt;Retain（驻留）&lt;/h3&gt;

&lt;p&gt;MQTT 客户端向服务器发布(PUBLISH)消息时，可以设置驻留消息(Retained Message)标志。
驻留消息(Retained Message)会驻留在消息服务器，后来的订阅者订阅主题时仍可以接收该消息。&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;同一 Topic 下的 Retain 消息有且只能有一条，后来的驻留消息会取代前一条驻留消息&lt;/strong&gt;&lt;/p&gt;

&lt;h3 id=&quot;qos-质量控制&quot;&gt;QoS （质量控制）&lt;/h3&gt;

&lt;table&gt;
  &lt;thead&gt;
    &lt;tr&gt;
      &lt;th&gt;qos&lt;/th&gt;
      &lt;th&gt;描述&lt;/th&gt;
    &lt;/tr&gt;
  &lt;/thead&gt;
  &lt;tbody&gt;
    &lt;tr&gt;
      &lt;td&gt;&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;0&lt;/code&gt;&lt;/td&gt;
      &lt;td&gt;无任何保证&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;1&lt;/code&gt;&lt;/td&gt;
      &lt;td&gt;一定会到达&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;2&lt;/code&gt;&lt;/td&gt;
      &lt;td&gt;一定会到达并且只会到达一次&lt;/td&gt;
    &lt;/tr&gt;
  &lt;/tbody&gt;
&lt;/table&gt;

&lt;p&gt;MQTT 发布消息 QoS 保证不是全部的，是客户端与 Broker 之间的&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;QOS 是针对与和 Broker 通信，因此 publish 了一条消息并不能保证 subscriber 一定会收到，比如：发消息时订阅还没有完成&lt;/strong&gt;&lt;/p&gt;

&lt;p&gt;mqttv5 新特性：&lt;a href=&quot;https://www.emqx.io/cn/blog/mqtt5-request-response&quot;&gt;请求响应&lt;/a&gt; 可以解决这个问题&lt;/p&gt;

&lt;p&gt;不过 mqttv5 这也有问题。。我有要是多个订阅者那（按照你业务具体需求来实现吧，返回个 &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;${ClientID} ACK&lt;/code&gt; 之类的）&lt;/p&gt;

&lt;h3 id=&quot;topic-主题消息路由&quot;&gt;Topic (主题：消息路由）&lt;/h3&gt;

&lt;p&gt;主题 (Topic) 通过 &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/&lt;/code&gt; 分割层级，支持 &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;+&lt;/code&gt;, &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;#&lt;/code&gt; 通配符:&lt;/p&gt;

&lt;p&gt;&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/a&lt;/code&gt; 和 &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;a&lt;/code&gt; 是两个完全不同的 topic&lt;/p&gt;

&lt;p&gt;&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;+&lt;/code&gt;: 表示通配一个层级，例如 &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;a/+&lt;/code&gt;，匹配 &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;a/x&lt;/code&gt;, &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;a/y&lt;/code&gt;&lt;/p&gt;

&lt;p&gt;&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;#&lt;/code&gt;: 表示通配多个层级，例如 &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;a/#&lt;/code&gt;，匹配 &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;a/x&lt;/code&gt;, &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;a/b/c/d&lt;/code&gt;&lt;/p&gt;

&lt;p&gt;可以这样写：&lt;/p&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;chat/room/1

chat/#

sensor/10/temperature

sensor/+/temperature
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;blockquote&gt;
  &lt;p&gt;注:&lt;/p&gt;

  &lt;p&gt;订阅者可以订阅含通配符主题，但发布者不允许向含通配符主题发布消息。&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;mqtt 5 vs mqtt 3.1.1&lt;/p&gt;

&lt;p&gt;目前有这两个主要的版本。。mqttv5 的改变巨大&lt;/p&gt;

&lt;h2 id=&quot;网络波动引起的丢消息问题&quot;&gt;网络波动引起的丢消息问题&lt;/h2&gt;

&lt;h3 id=&quot;mqttv311-cleansession&quot;&gt;mqttv3.1.1 CleanSession&lt;/h3&gt;

&lt;p&gt;网络波动引起的 Subscribe 状态的丢失&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;RabbitMQ 收到消息回执（Message acknowledgment）&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;这点和 RabbitMQ 不同（抱歉，我没有实际使用过 RabbitMQ。如果这个地方说错了，请务必指出）&lt;/p&gt;

&lt;p&gt;&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;Reconnect&lt;/code&gt; 之后虽然恢复。但 &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;Disconnect&lt;/code&gt; 到 &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;Reconnect&lt;/code&gt; 之间的信息会丢失&lt;/p&gt;

&lt;p&gt;用这个选项是可以解决的 &lt;a href=&quot;https://sourcegraph.com/github.com/eclipse/paho.mqtt.golang/-/blob/options.go#L104:3&quot;&gt;CleanSession 的默认设置是开启的，要关掉这个&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;还应该把检测掉线延时设置大一点，这样对抗网络波动的能力就更好些&lt;/p&gt;

&lt;p&gt;不过这里还有其他问题。。。如果长时间没有恢复（这个看各 broker 是如何实现的）
不过 mqttv5 加入了&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;session-expiry-interval&lt;/code&gt; 这个地方更完善了&lt;/p&gt;

&lt;h3 id=&quot;eclipse-paho-项目&quot;&gt;eclipse Paho 项目&lt;/h3&gt;

&lt;blockquote&gt;
  &lt;p&gt;pāho (verb) to broadcast, make widely known, announce, disseminate, transmit (via the Maori dictionary)&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;&lt;a href=&quot;https://wiki.eclipse.org/Paho&quot;&gt;paho 是毛利语中的广播的意思&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;这个项目里有几乎所有语言的 mqtt 库的实现（有钱真好）&lt;/p&gt;

&lt;h2 id=&quot;broker&quot;&gt;Broker&lt;/h2&gt;

&lt;h3 id=&quot;eclipse-mosquitto&quot;&gt;Eclipse Mosquitto&lt;/h3&gt;

&lt;p&gt;可以把这个当作标准工具来开发，测试，和使用&lt;/p&gt;

&lt;p&gt;Mosquitto 提个了非常好用的命令行工具可以用来开发调试&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;mosquitto_sub&lt;/li&gt;
  &lt;li&gt;mosquitto_pub&lt;/li&gt;
  &lt;li&gt;mosquitto_rr&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;直接用&lt;/p&gt;

&lt;div class=&quot;language-shell highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c&quot;&gt;# 开启起一个 mqtt broker，默认端口为 1883&lt;/span&gt;
mosquitto

&lt;span class=&quot;c&quot;&gt;# 订阅一个名为 test 的 topic&lt;/span&gt;
mosquitto_sub &lt;span class=&quot;nt&quot;&gt;-L&lt;/span&gt; mqtt://localhost:1883/test

&lt;span class=&quot;c&quot;&gt;# 推送一条内容为 `233` 的消息到 test&lt;/span&gt;
mosquitto_pub &lt;span class=&quot;nt&quot;&gt;-L&lt;/span&gt; mqtt://localhost:1883/test &lt;span class=&quot;nt&quot;&gt;-m&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;233&quot;&lt;/span&gt;

&lt;span class=&quot;c&quot;&gt;# 也可以这样订阅 topic 再推送消息&lt;/span&gt;
mosquitto_rr &lt;span class=&quot;nt&quot;&gt;-L&lt;/span&gt; mqtt://localhost:1883/test &lt;span class=&quot;nt&quot;&gt;-e&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;test&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-m&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;233&quot;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h3 id=&quot;volantmq&quot;&gt;volantmq&lt;/h3&gt;

&lt;p&gt;用 golang 写的。看起来还不错，不过我没用过&lt;/p&gt;

&lt;h3 id=&quot;emqx&quot;&gt;emqx&lt;/h3&gt;

&lt;p&gt;这个是国人用 &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;erlang&lt;/code&gt; 写的，还不错&lt;/p&gt;

&lt;h3 id=&quot;mqtt-over-websocket&quot;&gt;MQTT Over Websocket&lt;/h3&gt;

&lt;p&gt;MQTT 协议的 WebSocket 连接，必须采用 binary 模式，并携带子协议 Header:&lt;/p&gt;

&lt;p&gt;&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;Sec-WebSocket-Protocol:&lt;/code&gt; &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;mqttv5&lt;/code&gt; 或 &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;mqttv3.1.1&lt;/code&gt;&lt;/p&gt;

&lt;p&gt;这个是有标准文档的：&lt;a href=&quot;https://docs.oasis-open.org/mqtt/mqtt/v5.0/os/mqtt-v5.0-os.html#_Using_WebSocket_as&quot;&gt;Using WebSocket as a network transport&lt;/a&gt;&lt;/p&gt;

&lt;h3 id=&quot;jsonrpc-20-over-mqtt&quot;&gt;jsonrpc 2.0 Over MQTT&lt;/h3&gt;

&lt;p&gt;这个好像是我原创的。不建议这样用，虽然我们在生产环境里用的这个。&lt;/p&gt;

&lt;p&gt;有些异常情况的处理方案还不够完善。（极端恶劣的现实情况下表现比较骨感）&lt;/p&gt;

&lt;p&gt;这个要把 Last Will 消息 和传输考虑进去。要依赖 &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;qos 2&lt;/code&gt; 和 Disable &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;CleanSession&lt;/code&gt;&lt;/p&gt;

&lt;p&gt;topic 虽然是全双工的可以当 tcp 用。状态用另一个 topic 里提供&lt;/p&gt;

&lt;p&gt;这里判断 rpc 消息是否到达是有问题的。（办法是有，不过我目前没有找到很优雅的方案）&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/eclipse/paho.golang/blob/master/paho/extensions/rpc/rpc.go&quot;&gt;另一种 mqtt rpc 的方案 （这个使用了 mqttv5 的特性）&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;mqtt rpc 这个仅供参考&lt;/p&gt;

&lt;h3 id=&quot;事故和反思&quot;&gt;事故和反思&lt;/h3&gt;

&lt;h4 id=&quot;broker-挂了&quot;&gt;Broker 挂了&lt;/h4&gt;

&lt;p&gt;曾经有同事从硬件里读数据然后就以这个速率发送给 broker 。。。然后整个 Broker 都被拖垮了&lt;/p&gt;

&lt;p&gt;发送速率还是要限制一下。这样高频的数据的意义在哪？（通过云端处理来实时控制不适合使用 mqtt 。。DDS 协议请（这货甚至有 21 种 QoS ））&lt;/p&gt;

&lt;p&gt;发送速率建议不要太高。每秒一条，差不多（频率那么高的意义在那？）&lt;/p&gt;

&lt;h4 id=&quot;为了快速响应设备断网&quot;&gt;为了快速响应设备断网&lt;/h4&gt;

&lt;p&gt;如果要求快速响应有 &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;keep alive&lt;/code&gt; 的（默认 60s ），可以设置很低。&lt;/p&gt;

&lt;p&gt;不过个人建议不要设置在 3s 以下（网络延时和时间差（ntp服务）可能会导致问题）&lt;/p&gt;

&lt;p&gt;快速响应 &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;keep alive&lt;/code&gt; 10-15s 大概可以适配绝大部分情况了。&lt;/p&gt;

&lt;p&gt;主动关闭时最好发送关闭的信息。&lt;/p&gt;

&lt;p&gt;如果有人非要超级快的快速检测网络状态，你可以这样怼过去：你看 ssh 检测网络掉线也不是立刻能检测到&lt;/p&gt;

&lt;h2 id=&quot;关于-mqtt-的客户端库我觉得好多库都有各种各样的问题&quot;&gt;关于 MQTT 的客户端库：我觉得好多库都有各种各样的问题&lt;/h2&gt;

&lt;h3 id=&quot;mqttjs&quot;&gt;MQTT.js&lt;/h3&gt;

&lt;p&gt;我每次都想吐嘈这个地方&lt;/p&gt;

&lt;p&gt;这个库可是支持 &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;alis&lt;/code&gt; 和 &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;wxs&lt;/code&gt; 协议的哟～&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/mqttjs/MQTT.js/blob/master/lib/connect/ali.js&quot;&gt;带你了解 ali 协议&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/mqttjs/MQTT.js/blob/master/lib/connect/wx.js&quot;&gt;带你了解 wx 协议&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/mqttjs/MQTT.js/issues/944&quot;&gt;没看明白？ 可以看这个中文的&lt;/a&gt;&lt;/p&gt;

&lt;h3 id=&quot;eclipsepahomqttgolang&quot;&gt;eclipse/paho.mqtt.golang&lt;/h3&gt;

&lt;p&gt;这个库只支持 mqttv3.1.1 你敢信？&lt;/p&gt;

&lt;p&gt;你在看实现 &lt;a href=&quot;https://godoc.org/github.com/eclipse/paho.mqtt.golang&quot;&gt;API&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;一堆 interface 接口???&lt;/p&gt;

&lt;h3 id=&quot;eclipsepahogolang&quot;&gt;eclipse/paho.golang&lt;/h3&gt;

&lt;p&gt;eclipse 是有 mqttv5 的库的&lt;/p&gt;

&lt;p&gt;大概是 &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;paho.mqtt.golang&lt;/code&gt; 实现过于魔幻。所以作者重新开了一个新坑（只是这个 API 看起来正常多了）&lt;/p&gt;

&lt;h3 id=&quot;ruby-mqtt&quot;&gt;ruby-mqtt&lt;/h3&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/njh/ruby-mqtt&quot;&gt;njh/ruby-mqtt&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;这个不支持 &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;QoS 2&lt;/code&gt;&lt;/p&gt;

&lt;p&gt;类似 mqtt 特性支持不全的库还有很多。。这大概也是一大坑点&lt;/p&gt;

&lt;hr /&gt;

&lt;h2 id=&quot;reference&quot;&gt;Reference:&lt;/h2&gt;

&lt;p&gt;&lt;a href=&quot;https://mqtt.org/&quot;&gt;MQTT: The Standard for IoT Messaging&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://wiki.eclipse.org/Paho&quot;&gt;Paho Wiki&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://www.emqx.io/cn/blog/mqtt5-new-feature-clean-start-and-session-expiry-interval&quot;&gt;Clean Start 与 Session Expiry Interval - MQTT 5.0 新特性&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/emqx/emqx&quot;&gt;EMQ X&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/VolantMQ/volantmq&quot;&gt;volantmq&lt;/a&gt;&lt;/p&gt;</content><author><name>metal A-wing</name></author><category term="iot" /><summary type="html">MQTT（Message Queuing Telemetry Transport 消息队列遥测传输协议） 是一种基于发布/订阅（publish/subscribe）模式的 “轻量级” 通讯协议，该协议构建于 TCP/IP 协议上，最早由 IBM 在 1999 年发布。 目前由 OASIS 维护 MQTT 标准</summary><media:thumbnail xmlns:media="http://search.yahoo.com/mrss/" url="https://a-wing.top/assets/avatar.png" /><media:content medium="image" url="https://a-wing.top/assets/avatar.png" xmlns:media="http://search.yahoo.com/mrss/" /></entry><entry><title type="html">从零开始的学游泳</title><link href="https://a-wing.top/sport/2020/11/07/learn_to_swim.html" rel="alternate" type="text/html" title="从零开始的学游泳" /><published>2020-11-07T10:00:00+00:00</published><updated>2020-11-07T10:00:00+00:00</updated><id>https://a-wing.top/sport/2020/11/07/learn_to_swim</id><content type="html" xml:base="https://a-wing.top/sport/2020/11/07/learn_to_swim.html">&lt;p&gt;这天我参加了我人生中第一场游泳比赛 100M 蛙泳和 100M 自由泳，分别取得了第三名和第五名的成绩（小型比赛缺席的人太多，我运气比较好）。本文就分享一下我从旱鸭子，从头开始学习游泳的过程：
&lt;strong&gt;学习游泳运动这件事和学习一种新的编程语言一样，都只不过是学了一项新技能&lt;/strong&gt;&lt;/p&gt;

&lt;h4 id=&quot;注本人并非游泳教练也不是专业人士这只是业余个人学习游泳的一点心得&quot;&gt;&lt;strong&gt;注：本人并非游泳教练，也不是专业人士，这只是业余个人学习游泳的一点心得&lt;/strong&gt;&lt;/h4&gt;

&lt;p&gt;天赋问题，我可能是完全没有天赋的。蛙泳在深水区游到 25M 我花了差不多有一个月的学习&lt;/p&gt;

&lt;p&gt;我开始学游泳快一年了。哦不，是半年，因为今年疫情关系泳池有半年是没开门的&lt;/p&gt;

&lt;p&gt;只要每天坚持连续总会有提高&lt;/p&gt;

&lt;p&gt;游泳这件事感觉很重要，每个人都要个擅长的泳姿。某种泳姿有人一下子就学会了（天赋吧）。&lt;/p&gt;

&lt;p&gt;剩下的就是经过不断连续。大概没有人四种泳姿都学的非常轻松&lt;/p&gt;

&lt;p&gt;我觉得大概可以分成三个等级吧。。（当然不是运动员的说法）&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;L1 淹不死&lt;/li&gt;
  &lt;li&gt;L2 都会游&lt;/li&gt;
  &lt;li&gt;L3 非人类&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;当然这个是我自己分的级&lt;/p&gt;

&lt;p&gt;推荐视频：&lt;a href=&quot;https://space.bilibili.com/7283282/&quot;&gt;梦觉教游泳&lt;/a&gt; 这个讲的不错&lt;/p&gt;

&lt;h4 id=&quot;喝水这件事呛水-和-耳朵进水&quot;&gt;喝水这件事，呛水 和 耳朵进水&lt;/h4&gt;

&lt;p&gt;多喝一点就习惯了，要学游泳不喝泳池里的水是不可能学会的&lt;/p&gt;

&lt;p&gt;我觉得我鼻孔比较大，应该会很容易呛水。但其实呛水这件事和鼻孔大小没有必然关系&lt;/p&gt;

&lt;p&gt;耳朵进水，一定是你姿势不对。。。&lt;/p&gt;

&lt;h3 id=&quot;游泳三件套泳镜泳裤泳帽&quot;&gt;游泳三件套：泳镜，泳裤，泳帽&lt;/h3&gt;

&lt;p&gt;泳镜时间久起雾是一定的，泳镜表面有一层防雾膜，再贵的泳镜膜寿命都很短。
临时办法，放水里放一下，过一会还会起雾，或者在泳镜下故意留一点水，低一下头泳镜里的水就会自动帮助你把雾擦掉。
舔泳镜也是个经典的办法
最好是买一支防雾笔。定期保养泳镜&lt;/p&gt;

&lt;p&gt;泳裤第一次买可以买个游泳和沙滩通用的哪种，万一游泳学不下去了。去沙滩时还可以用。
？您说阻力大？不，初学者不需要考虑这个问题。等到水平可以参见比赛时，再买条专门比赛的&lt;/p&gt;

&lt;p&gt;泳帽就没什么了，头发短的随意就好了。（泳帽在游泳馆是个很具有标志性的装备，个性的泳帽会给人强烈的印象，当然游到很烂也会让人记住你的泳帽）&lt;/p&gt;

&lt;h2 id=&quot;l1-淹不死&quot;&gt;L1 淹不死&lt;/h2&gt;

&lt;p&gt;这里特指丢进深水区不会被淹死，（被救生员捞上来当然不算）&lt;/p&gt;

&lt;p&gt;这个只要学会蛙泳（或任意一种泳姿）和踩水就淹不死了&lt;/p&gt;

&lt;p&gt;其实会踩水就可以了。只是在没有学会任意一种泳姿之前好像是没有办法先学会踩水的（踩水本质上就是泳姿的变种）&lt;/p&gt;

&lt;p&gt;泳姿通常学习顺序会有 4 种方式：&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;蛙-爬-仰-蝶&lt;/li&gt;
  &lt;li&gt;爬-仰-蛙-蝶&lt;/li&gt;
  &lt;li&gt;爬-仰-蝶-蛙&lt;/li&gt;
  &lt;li&gt;仰-爬-蝶-蛙&lt;/li&gt;
&lt;/ul&gt;

&lt;h3 id=&quot;breaststroke-蛙泳&quot;&gt;Breaststroke 蛙泳&lt;/h3&gt;

&lt;blockquote&gt;
  &lt;p&gt;假如你只能选择一门泳姿，那我强烈建议学习蛙泳&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;绝大部分国内的人基本上都是从蛙泳开始的，蛙泳最大的好处大概就是泛用性极高。几乎可以在任何地方游。&lt;/p&gt;

&lt;p&gt;唯一的缺点大概就是 游起来难看，游的慢（大部分非专业人士都游的都不快）&lt;/p&gt;

&lt;p&gt;如果你想把蛙泳游的好，这个是非常难的（入门容易，进阶难）&lt;/p&gt;

&lt;p&gt;手和腿真是没什么可以说的&lt;/p&gt;

&lt;p&gt;照着游就行了，不过要注意换气一定要最后再学&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/img/learn_to_swim/breaststroke_1.gif&quot; alt=&quot;Breaststroke 1&quot; /&gt;&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/img/learn_to_swim/breaststroke_2.gif&quot; alt=&quot;Breaststroke 2&quot; /&gt;&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/img/learn_to_swim/breaststroke_3.gif&quot; alt=&quot;Breaststroke 3&quot; /&gt;&lt;/p&gt;

&lt;p&gt;如果要开始学习蛙泳换气，确保自己的划水效率要满足最基本的要求。。。对于没专门练习过闭气的人来说，时间基本上都是差不多的。只是为了提高划水效率&lt;/p&gt;

&lt;p&gt;一个最简单的测量方法就是：闭气游十米再开始学换气&lt;/p&gt;

&lt;p&gt;因为头要出水面换气，如果划水效率很低的话，是无法支撑换气的时间的&lt;/p&gt;

&lt;h3 id=&quot;蛙式踩水&quot;&gt;蛙式踩水&lt;/h3&gt;

&lt;p&gt;其实就是把蛙泳旋转 90 度来游，手上虽然有变化，但本质都一样&lt;/p&gt;

&lt;p&gt;先站起来，手伸出水面，让自己往下沉，你会发现自己并不会沉底，到了浮力跟重力平衡的时候，你的口鼻大概会在水面附近，憋着气，不要慌，等待一下，看会发生什么。&lt;/p&gt;

&lt;p&gt;什么也不会发生。&lt;/p&gt;

&lt;p&gt;好，蹬一下腿看看会发生什么？随便蹬，不用太用力。&lt;/p&gt;

&lt;p&gt;是不是口鼻出水了？&lt;/p&gt;

&lt;p&gt;那就呼吸，然后再让自己往下沉。
如是循环。
这就是踩水了。&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;泳池的你苦练成功以后，你会惊喜地发现：
除了停在泳道中间挡路尬聊之外，
踩水其实没什么毛用！！&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h3 id=&quot;深水证&quot;&gt;深水证&lt;/h3&gt;

&lt;p&gt;好像很多泳池会要求你要通过深水测试才能去的深水区，这个各个地区的标准不同，我常去的游泳馆，就是 3 分钟非自由泳游 100M&lt;/p&gt;

&lt;p&gt;这个标准差不多就是区分会游泳和不会游泳的标志了&lt;/p&gt;

&lt;h2 id=&quot;l2-都会游&quot;&gt;L2 都会游&lt;/h2&gt;

&lt;p&gt;就是学会常见的四种泳姿（游泳比赛的那四种），我把反蛙式也放在这里（因为很容易）。蛙，仰，蝶，自，再加 反蛙&lt;/p&gt;

&lt;h2 id=&quot;freestyle-自由泳&quot;&gt;Freestyle 自由泳&lt;/h2&gt;

&lt;p&gt;从这个名字可以看出，自由泳叫 Freestyle 。就是不限泳姿完全自由&lt;/p&gt;

&lt;p&gt;自由泳 包括 爬泳&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;自由泳是官方游泳竞赛的项目，其规则是由国际泳联总会制定的。
自由泳严格来说不是一种游泳姿势，自由泳竞赛的规则几乎没有任何限制。
大多数游泳员在自由泳比赛时选择使用爬泳，因其是阻力小、速度均匀、快速的游泳姿势。
外界人士经常把“自由泳”与“爬泳”混淆，自由泳的意思是参赛者可以使用“任何姿势”。&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;&lt;img src=&quot;/assets/img/learn_to_swim/front_crawl_1.gif&quot; alt=&quot;Front crawl 1&quot; /&gt;&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/img/learn_to_swim/front_crawl_2.gif&quot; alt=&quot;Front crawl 2&quot; /&gt;&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/img/learn_to_swim/front_crawl_3.gif&quot; alt=&quot;Front crawl 3&quot; /&gt;&lt;/p&gt;

&lt;p&gt;1W 米自由泳打腿，这是基础，这个很重要，真的很重要。每天都要练习打腿，累计 1W 米就差不多会了&lt;/p&gt;

&lt;p&gt;之后是侧身打腿加换气。。。每天也要练习。最后才是划手。&lt;/p&gt;

&lt;p&gt;这个本来是我第二个学习的泳姿，奈何本人太菜，练了两个多月没有效果，果断跳过这个直接去学仰泳，之后学完蝶泳才学会的自由泳&lt;/p&gt;

&lt;h3 id=&quot;backstroke-仰泳&quot;&gt;Backstroke 仰泳&lt;/h3&gt;

&lt;p&gt;这个我好像很容易。如果仰泳时经常呛水，可以先试试反蛙式仰泳&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/img/learn_to_swim/backstroke_1.gif&quot; alt=&quot;Backstroke 1&quot; /&gt;&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/img/learn_to_swim/backstroke_2.gif&quot; alt=&quot;Backstroke 2&quot; /&gt;&lt;/p&gt;

&lt;h4 id=&quot;反蛙式&quot;&gt;反蛙式&lt;/h4&gt;

&lt;p&gt;顾名思义，就是把蛙泳旋转 180 度来游。其实也算是仰泳的一种
这个有个非常爽的一点，就是空中移臂距离很长，很爽，主要是节约体力
也叫蛙式仰泳、仰漂。通常用于求生。比如从船上掉下去了，用这个来等待救生船正好&lt;/p&gt;

&lt;h2 id=&quot;butterfly-蝶泳&quot;&gt;Butterfly 蝶泳&lt;/h2&gt;

&lt;p&gt;我最喜欢的泳姿，游起来很帅，特别帅。主要是游起来很爽。&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/img/learn_to_swim/butterfly_1.gif&quot; alt=&quot;Butterfly 1&quot; /&gt;&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/img/learn_to_swim/butterfly_2.gif&quot; alt=&quot;Butterfly 2&quot; /&gt;&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/img/learn_to_swim/butterfly_3.gif&quot; alt=&quot;Butterfly 3&quot; /&gt;&lt;/p&gt;

&lt;p&gt;这个我也不知道该怎么学，好像下水之后一下子就学会了蝶泳。。。&lt;/p&gt;

&lt;h2 id=&quot;l3-非人类&quot;&gt;L3 非人类&lt;/h2&gt;

&lt;p&gt;四种泳姿都学会了就是可以向着更高多水平学习&lt;/p&gt;

&lt;p&gt;之后的游法只是对基本的四种泳姿的变种&lt;/p&gt;

&lt;p&gt;我们先来思考一个问题： &lt;strong&gt;追求 为什么游泳？&lt;/strong&gt;&lt;/p&gt;

&lt;p&gt;能耗最优 和 速度最优&lt;/p&gt;

&lt;p&gt;引用一段话：&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;人在水中想要更快地游进有两种方式，一是最大限度地提供动力，比如提升划手和打腿的频率;
二是最大限度地减少阻力，提升效率，比如让身体始终处于流线型，增加每一划的效率。
相对而言，普通自由泳更注重前者，全浸式更注重后者，注意我说的是相对，实际上无论哪种泳姿都需要兼顾频率与效率，只是权重不一样。
从速度来讲，普通自由泳的上限显然更高，因为人可以通过不断地练习，体力不断提升，频率更快提升速度。
对于全浸来讲，因为减阻的优势到一定程度，边际效应递减，对速度的帮助不大，但相对而言更轻松一些。
因此，如果对速度有要求，可以选择普通自由泳，如果想游得更从容漂亮，可以选择全浸。没有高下之分，就看适合不适合。&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;如果是要去参加游泳比赛，向着运动员靠拢，基本上都是从小练体育的。&lt;/p&gt;

&lt;p&gt;大部分在泳池里的人都是当作健身减肥来一种手段&lt;/p&gt;

&lt;p&gt;看我写的东西的人大概都是业余学习游泳或者没游过泳的&lt;/p&gt;

&lt;h3 id=&quot;狗刨&quot;&gt;狗刨&lt;/h3&gt;

&lt;p&gt;这个泳姿我是真的不会，毕竟没有专门学习狗刨的资料。。。。&lt;/p&gt;

&lt;h3 id=&quot;潜泳&quot;&gt;潜泳&lt;/h3&gt;

&lt;p&gt;一般都泳池都是禁止潜泳的。主要是当你 BO（Black Out）之后救生员很难发现（因为看起来和闭气没什么区别）。&lt;/p&gt;

&lt;p&gt;不过潜到池底最好还是要练一下的。&lt;/p&gt;

&lt;p&gt;长划臂的潜水蛙泳。25M 泳池一口气游到头相信对于大部分人来说并不是什么难事
me 就靠着这招在水下一口气游 25M 。。。只要多加连续，我相信未来一定可以一口气游 50M&lt;/p&gt;

&lt;h3 id=&quot;抬头蛙&quot;&gt;抬头蛙&lt;/h3&gt;

&lt;p&gt;顾名思义就是抬着头游，这个在开放水域很有用。还有就是没有带泳镜的时候&lt;/p&gt;

&lt;h3 id=&quot;老年蛙式&quot;&gt;老年蛙式&lt;/h3&gt;

&lt;p&gt;你看泳池里的游蛙泳的基本上都是这种&lt;/p&gt;

&lt;h3 id=&quot;全浸式--箭式自由泳&quot;&gt;全浸式 &amp;amp;&amp;amp; 箭式自由泳&lt;/h3&gt;

&lt;iframe width=&quot;560&quot; height=&quot;315&quot; src=&quot;https://www.youtube.com/embed/LijdyVaaDnY&quot; frameborder=&quot;0&quot; allow=&quot;accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture&quot; allowfullscreen=&quot;&quot;&gt;&lt;/iframe&gt;

&lt;p&gt;总结一下：其实就是 二次腿&lt;/p&gt;

&lt;h3 id=&quot;波蛙式&quot;&gt;波蛙式&lt;/h3&gt;

&lt;p&gt;这个有点像蛙泳和蝶泳的结合，一种极限追去速度的一种泳姿。
游泳比赛是用的都是这种&lt;/p&gt;

&lt;h2 id=&quot;关于下水救人&quot;&gt;关于下水救人&lt;/h2&gt;

&lt;p&gt;如果你在思考这个问题，那其实根本救不用思考，不要去救，下去就是去送死&lt;/p&gt;

&lt;p&gt;如果你有下水救人的能力的话这个问题是不需要思考的&lt;/p&gt;

&lt;h2 id=&quot;海里游泳&quot;&gt;海里游泳&lt;/h2&gt;

&lt;p&gt;在海里游泳和在泳池游泳完全是两回事。海里浪很大，情况复杂。
还有就是海水比泳池的水难喝多了&lt;/p&gt;

&lt;h2 id=&quot;reference&quot;&gt;Reference&lt;/h2&gt;

&lt;p&gt;&lt;a href=&quot;https://en.wikipedia.org/wiki/Swimming_(sport)&quot;&gt;Wikipedia Swimming&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;GIF 来源，我是在没有找到原出处。找了个还不错的版本
&lt;a href=&quot;https://blog.xuite.net/bluetemple/blog/226529700&quot;&gt;轉自：不會遊泳的看了包你學會！有很多人還是不會遊泳的，看了麻煩請分享傳開！謝謝！ | Giga Circle&lt;/a&gt;&lt;/p&gt;</content><author><name>metal A-wing</name></author><category term="sport" /><summary type="html">这天我参加了我人生中第一场游泳比赛 100M 蛙泳和 100M 自由泳，分别取得了第三名和第五名的成绩（小型比赛缺席的人太多，我运气比较好）。本文就分享一下我从旱鸭子，从头开始学习游泳的过程： 学习游泳运动这件事和学习一种新的编程语言一样，都只不过是学了一项新技能</summary><media:thumbnail xmlns:media="http://search.yahoo.com/mrss/" url="https://a-wing.top/assets/avatar.png" /><media:content medium="image" url="https://a-wing.top/assets/avatar.png" xmlns:media="http://search.yahoo.com/mrss/" /></entry><entry><title type="html">modbus 协议初体验</title><link href="https://a-wing.top/mcu/2020/05/23/modbus.html" rel="alternate" type="text/html" title="modbus 协议初体验" /><published>2020-05-23T09:00:00+00:00</published><updated>2020-05-23T09:00:00+00:00</updated><id>https://a-wing.top/mcu/2020/05/23/modbus</id><content type="html" xml:base="https://a-wing.top/mcu/2020/05/23/modbus.html">&lt;p&gt;最近被拉去支援硬件部分，又写了几天对接嵌入式的上位机程序 &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;_(ˊཀˋ」∠)_&lt;/code&gt;&lt;/p&gt;

&lt;p&gt;和下位机通信是用 modbus 协议的。趁机学习了一下这个上古协议。（奇怪的知识又增加了&lt;/p&gt;

&lt;p&gt;modbus 是用 &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;req/res&lt;/code&gt; 的模式来通信的。和 http 是一样的，如果要拿传感器信息只能轮询&lt;/p&gt;

&lt;p&gt;关于 modbus 协议的一大特点，就是支持设备并连，可以通过一个串口控制最多 256 个设备（每次发送请求时要发送目标地址）&lt;/p&gt;

&lt;p&gt;由于 &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;modbus.org&lt;/code&gt; 不支持 https 。所以就不放标准文档的连接了（迫真，上古协议）&lt;/p&gt;

&lt;p&gt;以这个读取状态的请求为例 &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;03 (0x03) Read Holding Registers&lt;/code&gt;&lt;/p&gt;

&lt;table&gt;
  &lt;thead&gt;
    &lt;tr&gt;
      &lt;th&gt;Name&lt;/th&gt;
      &lt;th&gt;Length&lt;/th&gt;
      &lt;th&gt;Value&lt;/th&gt;
    &lt;/tr&gt;
  &lt;/thead&gt;
  &lt;tbody&gt;
    &lt;tr&gt;
      &lt;td&gt;Function code&lt;/td&gt;
      &lt;td&gt;1 Byte&lt;/td&gt;
      &lt;td&gt;0x03&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;Starting Address&lt;/td&gt;
      &lt;td&gt;2 Bytes&lt;/td&gt;
      &lt;td&gt;0x0000 to 0xFFFF&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;Quantity of Registers&lt;/td&gt;
      &lt;td&gt;2 Bytes&lt;/td&gt;
      &lt;td&gt;1 to 125 (0x7D)&lt;/td&gt;
    &lt;/tr&gt;
  &lt;/tbody&gt;
&lt;/table&gt;

&lt;p&gt;每个请求要有 &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;Function code&lt;/code&gt; 字段。用到的 &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;Function code&lt;/code&gt; 是有标准的定义的。（当然是可以不按照标准实现）&lt;/p&gt;

&lt;p&gt;当然不同的 &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;Function code&lt;/code&gt; 对应的参数也不同。&lt;/p&gt;

&lt;p&gt;这个协议的读写是直接写到对应地址里的。&lt;/p&gt;

&lt;p&gt;比如有一个地址为 &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;0x01&lt;/code&gt; 的存温度，地址为 &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;0x02&lt;/code&gt; 存湿度&lt;/p&gt;

&lt;p&gt;由于这两个地址是连续的。可以一口气全部读出来&lt;/p&gt;

&lt;h2 id=&quot;我们先来发送一个-0x03-的请求&quot;&gt;我们先来发送一个 &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;0x03&lt;/code&gt; 的请求&lt;/h2&gt;

&lt;p&gt;当然 &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;Starting Address&lt;/code&gt; 是 &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;0x01&lt;/code&gt;，&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;Quantity of Registers&lt;/code&gt; 是 &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;0x02&lt;/code&gt;（一共读两个: &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;0x01&lt;/code&gt; 和 &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;0x02&lt;/code&gt;）&lt;/p&gt;

&lt;p&gt;然后请求转换成这样一段东西：&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;['0x03', '0x00', '0x01', '0x00', '0x02']&lt;/code&gt; （我应该不用解释这一串是怎么生成的吧。。。）&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;这个叫 &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;pdu&lt;/code&gt; （Protocol Data Unit）也就是 &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;Function code&lt;/code&gt; 加上 &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;Function code&lt;/code&gt; 对应的 &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;Data&lt;/code&gt;&lt;/strong&gt;&lt;/p&gt;

&lt;p&gt;之后把 &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;pdu&lt;/code&gt; emmmmm 。之后分成多种情况。这个和你的传输方式有关。modbus 可以使用&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;RTU&lt;/code&gt;（串口传输）也可以使用 &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;TCP&lt;/code&gt; 来传输。&lt;/p&gt;

&lt;p&gt;如果是 &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;RTU&lt;/code&gt; 传输，加入目标地址，加入 crc 校验字段，然后就可以直接发送出去了&lt;/p&gt;

&lt;table&gt;
  &lt;thead&gt;
    &lt;tr&gt;
      &lt;th&gt;Name&lt;/th&gt;
      &lt;th&gt;Value&lt;/th&gt;
    &lt;/tr&gt;
  &lt;/thead&gt;
  &lt;tbody&gt;
    &lt;tr&gt;
      &lt;td&gt;Slave Address&lt;/td&gt;
      &lt;td&gt;1 byte&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;Function&lt;/td&gt;
      &lt;td&gt;1 byte&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;Data&lt;/td&gt;
      &lt;td&gt;0 up to 252 bytes&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;CRC&lt;/td&gt;
      &lt;td&gt;2 byte&lt;/td&gt;
    &lt;/tr&gt;
  &lt;/tbody&gt;
&lt;/table&gt;

&lt;p&gt;如果使用 &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;TCP&lt;/code&gt; 就多出了很多字段&lt;/p&gt;

&lt;table&gt;
  &lt;thead&gt;
    &lt;tr&gt;
      &lt;th&gt;Name&lt;/th&gt;
      &lt;th&gt;Value&lt;/th&gt;
    &lt;/tr&gt;
  &lt;/thead&gt;
  &lt;tbody&gt;
    &lt;tr&gt;
      &lt;td&gt;Transaction identifier&lt;/td&gt;
      &lt;td&gt;2 bytes&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;Protocol identifier&lt;/td&gt;
      &lt;td&gt;2 bytes&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;Length&lt;/td&gt;
      &lt;td&gt;2 bytes&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;Unit identifier&lt;/td&gt;
      &lt;td&gt;1 byte&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;Function code&lt;/td&gt;
      &lt;td&gt;1 byte&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;Data&lt;/td&gt;
      &lt;td&gt;n bytes&lt;/td&gt;
    &lt;/tr&gt;
  &lt;/tbody&gt;
&lt;/table&gt;

&lt;p&gt;modbus 也就这点东西了，其实没什么。&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/goburrow/modbus&quot;&gt;我使用 golang 的库来使用 modbus&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;modbus 还可以的。就是，如果个厂商能按照 modbus 标准来实现就好了（我写的时候，坑人的硬件厂商没有按照 modbus 标准实现）&lt;/p&gt;

&lt;p&gt;这协议要是支持订阅某个地址的值，然后当数值变化的时候自动推送消息就好了（设置个最小推送时间间隔，这样就可以不用轮询了）&lt;/p&gt;</content><author><name>metal A-wing</name></author><category term="mcu" /><summary type="html">最近被拉去支援硬件部分，又写了几天对接嵌入式的上位机程序 _(ˊཀˋ」∠)_</summary><media:thumbnail xmlns:media="http://search.yahoo.com/mrss/" url="https://a-wing.top/assets/avatar.png" /><media:content medium="image" url="https://a-wing.top/assets/avatar.png" xmlns:media="http://search.yahoo.com/mrss/" /></entry><entry><title type="html">自制旁路网关（三） ——nftables 来做透明代理</title><link href="https://a-wing.top/network/2020/03/07/bypass_gateway-3_nftables.html" rel="alternate" type="text/html" title="自制旁路网关（三） ——nftables 来做透明代理" /><published>2020-03-07T04:00:00+00:00</published><updated>2020-03-07T04:00:00+00:00</updated><id>https://a-wing.top/network/2020/03/07/bypass_gateway-3_nftables</id><content type="html" xml:base="https://a-wing.top/network/2020/03/07/bypass_gateway-3_nftables.html">&lt;p&gt;本以为这篇文章会写的很长，因为笔记上还有好多内容。不过博客不能是笔记，把最核心的地方用最简单的话提炼出来，尽可能让所有人能看懂才算是一篇好文章&lt;/p&gt;

&lt;p&gt;今天或许是个好日子，&lt;a href=&quot;https://zh.wikipedia.org/wiki/%E5%A5%B3%E7%94%9F%E8%8A%82&quot;&gt;三月七号女生节&lt;/a&gt;。我决定今天把这个系列的坑填上，就当作给所有女孩子的礼物了（大雾）&lt;/p&gt;

&lt;p&gt;为什要使用 nftables 来分流而不用，clash 的分流。如果你了解零拷贝实现，你就会了解为什么这样做。不了解也没关系，记住结论 &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;nftables&lt;/code&gt; 分流性能更高一些&lt;/p&gt;

&lt;p&gt;不过那个&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;nftables&lt;/code&gt; 性能高只是理论上的。实际上我并没有做过 &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;benchmarks&lt;/code&gt; 。可能实际情况也刚好相反。（也欢迎那个较真的杠精来做下 &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;benchmarks&lt;/code&gt; 来证明一下）&lt;/p&gt;

&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c&quot;&gt;# 挂上socks 代理下的大概快一点&lt;/span&gt;
curl &lt;span class=&quot;nt&quot;&gt;--socks5&lt;/span&gt; localhost:7891 &lt;span class=&quot;s1&quot;&gt;'http://ftp.apnic.net/apnic/stats/apnic/delegated-apnic-latest'&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; raw


&lt;span class=&quot;c&quot;&gt;# 制作 nftables 的配置文件，先生成个第一行&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;define chnroute_list = {&quot;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; chnroute.nft

&lt;span class=&quot;c&quot;&gt;# 提取国内的地址追加写入配置&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;cat &lt;/span&gt;raw | &lt;span class=&quot;nb&quot;&gt;grep &lt;/span&gt;ipv4 | &lt;span class=&quot;nb&quot;&gt;grep &lt;/span&gt;CN | &lt;span class=&quot;nb&quot;&gt;awk&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-F&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\|&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'{ printf(&quot;%s/%d\n&quot;, $4, 32-log($5)/log(2)) }'&lt;/span&gt; | &lt;span class=&quot;nb&quot;&gt;sed &lt;/span&gt;s/&lt;span class=&quot;nv&quot;&gt;$/&lt;/span&gt;,/g &lt;span class=&quot;o&quot;&gt;&amp;gt;&amp;gt;&lt;/span&gt; chnroute.nft

&lt;span class=&quot;c&quot;&gt;# 写个尾部&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;}&quot;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;&amp;gt;&lt;/span&gt; chnroute.nft

&lt;span class=&quot;c&quot;&gt;# 放到该放的位置&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;cp &lt;/span&gt;chnroute.nft /etc/nftables/chnroute.nft
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;再来修改配置文件 &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/etc/nftables.conf&lt;/code&gt;&lt;/p&gt;

&lt;p&gt;这个地方接上一篇 &lt;a href=&quot;/network/2020/02/22/bypass_gateway-1_clash.html&quot;&gt;自制旁路网关（一） ——使用clash做代理&lt;/a&gt; 的 nftables 部分&lt;/p&gt;

&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c&quot;&gt;#!/usr/sbin/nft -f&lt;/span&gt;
flush ruleset

include &lt;span class=&quot;s2&quot;&gt;&quot;/etc/nftables/private.nft&quot;&lt;/span&gt;
include &lt;span class=&quot;s2&quot;&gt;&quot;/etc/nftables/chnroute.nft&quot;&lt;/span&gt;

table ip nat &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
  chain proxy &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
    ip daddr &lt;span class=&quot;nv&quot;&gt;$private_list&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;return
    &lt;/span&gt;ip daddr &lt;span class=&quot;nv&quot;&gt;$chnroute_list&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;return
    &lt;/span&gt;ip protocol tcp redirect to :7892
  &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
  chain prerouting &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;nb&quot;&gt;type &lt;/span&gt;nat hook prerouting priority 0&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; policy accept&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    goto proxy
  &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;nft flush ruleset&lt;/code&gt; 可以写在文件里，不用担心语法错误会把规则清空（这个我实际测试过）。nftables 的配置是 “事务型规则更新” （了解关系型数据库的人应该知道我在说什么）&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;细心的朋友可能会发现我在上一篇文章中用的是 &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;jump&lt;/code&gt;&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;关于 &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;goto&lt;/code&gt; 和 &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;jump&lt;/code&gt; 指令是有区别的。我觉得这里用 &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;goto&lt;/code&gt; 更好一些 &lt;a href=&quot;https://wiki.nftables.org/wiki-nftables/index.php/Jumping_to_chain&quot;&gt;官方文档讲的很清楚应该不用我再翻译一遍 jump vs goto&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;然后重新载入配置文件 &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;nft -f /etc/nftables.conf&lt;/code&gt;&lt;/p&gt;

&lt;h4 id=&quot;做完这些如果你发现国内网站全上不去了&quot;&gt;做完这些如果你发现国内网站全上不去了&lt;/h4&gt;
&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c&quot;&gt;# 看看这些个显示的是 0 还是 1&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# 默认是 0 不启用 ip_forward&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;cat&lt;/span&gt; /proc/sys/net/ipv4/ip_forward

&lt;span class=&quot;c&quot;&gt;# 手动打开&lt;/span&gt;
sysctl &lt;span class=&quot;nt&quot;&gt;-w&lt;/span&gt; net.ipv4.ip_forward&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;1

&lt;span class=&quot;c&quot;&gt;# 你也可以这样来打开&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;echo &lt;/span&gt;1 &lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; /proc/sys/net/ipv4/ip_forward
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;不过长期的稳定的办法是修改 &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/etc/sysctl.conf&lt;/code&gt; 的 &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;net.ipv4.ip_forward=1&lt;/code&gt;&lt;/p&gt;

&lt;p&gt;然后 &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;sysctl -p&lt;/code&gt; 载入&lt;/p&gt;

&lt;h3 id=&quot;后记&quot;&gt;后记&lt;/h3&gt;
&lt;p&gt;如果国外走 udp 。也是同理，只是要用 tproxy，或者 tun 设备（虚线一个网卡）&lt;/p&gt;

&lt;p&gt;真是没想到，我竟然更完了这个系列&lt;/p&gt;

&lt;h3 id=&quot;本系列文章&quot;&gt;本系列文章：&lt;/h3&gt;
&lt;ol&gt;
  &lt;li&gt;这应该算是第零篇，建议先看这篇 &lt;a href=&quot;/linux/2019/04/01/debian_network.html&quot;&gt;细说 Debian 的网络管理 network/interfaces&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;/network/2020/02/22/bypass_gateway-1_clash.html&quot;&gt;自制旁路网关（一） ——使用clash做代理&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;/network/2020/02/28/bypass_gateway-1-1_subscription.html&quot;&gt;自制旁路网关（一点一） ——增加clash订阅功能&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;/network/2020/03/01/bypass_gateway-2_improve_dns.html&quot;&gt;自制旁路网关（二） ——用unbound和smartdns来优化dns服务&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;自制旁路网关（三） ——nftables 来做透明代理 (本篇)&lt;/li&gt;
&lt;/ol&gt;

&lt;h2 id=&quot;参考文章&quot;&gt;参考文章&lt;/h2&gt;

&lt;p&gt;&lt;a href=&quot;https://typeblog.net/10650/archlinux-shadowsocks-iptables-ipset&quot;&gt;在 ArchLinux 上配置 shadowsocks + iptables + ipset 实现自动分流&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://64mb.org/2018/12/24/linux-on-m8-01/&quot;&gt; Linux on m8 第一篇、网络配置&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://omicron3069.com/post/nftablesfornode/&quot;&gt;nftables 上手小记&lt;/a&gt;&lt;/p&gt;</content><author><name>metal A-wing</name></author><category term="network" /><summary type="html">本以为这篇文章会写的很长，因为笔记上还有好多内容。不过博客不能是笔记，把最核心的地方用最简单的话提炼出来，尽可能让所有人能看懂才算是一篇好文章</summary><media:thumbnail xmlns:media="http://search.yahoo.com/mrss/" url="https://a-wing.top/assets/avatar.png" /><media:content medium="image" url="https://a-wing.top/assets/avatar.png" xmlns:media="http://search.yahoo.com/mrss/" /></entry><entry><title type="html">自制旁路网关（二） ——用unbound和smartdns来优化dns服务</title><link href="https://a-wing.top/network/2020/03/01/bypass_gateway-2_improve_dns.html" rel="alternate" type="text/html" title="自制旁路网关（二） ——用unbound和smartdns来优化dns服务" /><published>2020-03-01T14:00:00+00:00</published><updated>2020-03-01T14:00:00+00:00</updated><id>https://a-wing.top/network/2020/03/01/bypass_gateway-2_improve_dns</id><content type="html" xml:base="https://a-wing.top/network/2020/03/01/bypass_gateway-2_improve_dns.html">&lt;p&gt;今天是三月一日，我应该昨天更新，因为昨天是四年一度的二月二十九日。错过了了个好日子 T_T 。不过没关系，今天还是一年一次的三月一号那（&lt;/p&gt;

&lt;p&gt;先来回顾一下 dns 查询会遇到那些问题&lt;/p&gt;

&lt;ol&gt;
  &lt;li&gt;运营商 dns 基本上是最快的，但可能有污染&lt;/li&gt;
  &lt;li&gt;国内公共 dns ，国内地址准确，但未必最快，国外有污染&lt;/li&gt;
  &lt;li&gt;出口节点运营商 dns ，国外地址准确，速度基本最快&lt;/li&gt;
  &lt;li&gt;国外公共 dns ，国外地址准确，但未必快&lt;/li&gt;
  &lt;li&gt;国外网站可能有国内地址的 cdn ，cdn 最快&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;我们先把国内外分开查询，然后再汇总&lt;/p&gt;

&lt;p&gt;使用 smartdns 来查询国内，只用公共 dns ，（smartdns 可以测速并返回你的位置最快的地址）&lt;/p&gt;

&lt;p&gt;国内外 dns 该如何进行分流？有一个很重要的问题是国外网站有国内 cdn&lt;/p&gt;

&lt;p&gt;基于 geo-ip 来分流查询，查到固定国家或特色网段的地址时，不使用这个结果（大陆白名单就是这种）&lt;/p&gt;

&lt;p&gt;基于域名 GFWlist 是把被墙掉的域名收集起来做成一个数据库&lt;/p&gt;

&lt;h3 id=&quot;究极方案-icplist&quot;&gt;究极方案 ICPlist:&lt;/h3&gt;

&lt;p&gt;我还没见过有这么干的，不过这才是一劳永逸的办法，用于大陆法律的问题 ICP 你懂的，不过这个数据库可以反过来利用（只要在 icp 清单可以认为在大陆一定有服务器）&lt;/p&gt;

&lt;p&gt;不过最大的问题是这个库过于庞大。。。绝大部分你都是永远都不会用的地址&lt;/p&gt;

&lt;p&gt;国外的可以分成两种情况&lt;/p&gt;
&lt;ol&gt;
  &lt;li&gt;出口固定（比如你自建的服务）&lt;/li&gt;
  &lt;li&gt;出口不确定（比如使用机场）&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;出口固定的情况很好解决，这里不做考虑（你自己在出口节点上建一个 dns 服务，然后加密传回来就行了）&lt;/p&gt;

&lt;p&gt;出口不确定，你不知道运营商 dns 只能把查询请求给代理，保佑能给你返回个快的地址&lt;/p&gt;

&lt;h1 id=&quot;目前我用的方案&quot;&gt;目前我用的方案&lt;/h1&gt;

&lt;p&gt;使用 &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;unbound&lt;/code&gt; 来做主 dns 服务（其实用什么都无所谓 coredns 也可以）&lt;/p&gt;

&lt;p&gt;&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;smartdns&lt;/code&gt; 来查询国内的 dns （我设成 5351 端口）&lt;/p&gt;

&lt;p&gt;&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;clash&lt;/code&gt; 来查询国外的 dns （我设成 5352 端口）&lt;/p&gt;

&lt;p&gt;&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;dnsmasq-china-list&lt;/code&gt; 的规则来分流国内外&lt;/p&gt;

&lt;h3 id=&quot;smartdns&quot;&gt;smartdns&lt;/h3&gt;
&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;wget https://github.com/pymumu/smartdns/releases/download/Release28/smartdns.1.2019.12.15-1028.arm-debian-all.deb
dpkg &lt;span class=&quot;nt&quot;&gt;-i&lt;/span&gt; smartdns.1.2019.12.15-1028.arm-debian-all.deb

systemctl start smartdns.service
systemctl &lt;span class=&quot;nb&quot;&gt;enable &lt;/span&gt;smartdns.service
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;这个没啥说的，按官方文档的说法，就多些几个上游 dns 地址 &lt;a href=&quot;https://dns.iui.im/&quot;&gt;从这里挑几个看着顺眼的写上就行&lt;/a&gt;&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;smartdns有测速机制，在配置上游服务器时，建议配置多个上游DNS服务器，包含多个不同区域的服务器，但总数建议在10个左右&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h3 id=&quot;unbound&quot;&gt;unbound&lt;/h3&gt;
&lt;p&gt;这个直接从源里安装就行 &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;apt install unbound&lt;/code&gt;&lt;/p&gt;

&lt;p&gt;不过这个源里的 &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;unbound&lt;/code&gt;， DD (Debian Developer) 定制了一点东西&lt;/p&gt;
&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nb&quot;&gt;sudo &lt;/span&gt;systemctl &lt;span class=&quot;nb&quot;&gt;cat &lt;/span&gt;unbound
&lt;span class=&quot;c&quot;&gt;# /lib/systemd/system/unbound.service&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;Unit]
&lt;span class=&quot;nv&quot;&gt;Description&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;Unbound DNS server
&lt;span class=&quot;nv&quot;&gt;Documentation&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;man:unbound&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;8&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;After&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;network.target
&lt;span class=&quot;nv&quot;&gt;Before&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;nss-lookup.target
&lt;span class=&quot;nv&quot;&gt;Wants&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;nss-lookup.target

&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;Service]
&lt;span class=&quot;nv&quot;&gt;Type&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;notify
&lt;span class=&quot;nv&quot;&gt;Restart&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;on-failure
&lt;span class=&quot;nv&quot;&gt;EnvironmentFile&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;-/etc/default/unbound
&lt;span class=&quot;nv&quot;&gt;ExecStartPre&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;-/usr/lib/unbound/package-helper chroot_setup
&lt;span class=&quot;nv&quot;&gt;ExecStartPre&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;-/usr/lib/unbound/package-helper root_trust_anchor_update
&lt;span class=&quot;nv&quot;&gt;ExecStart&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;/usr/sbin/unbound &lt;span class=&quot;nt&quot;&gt;-d&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$DAEMON_OPTS&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;ExecReload&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;/usr/sbin/unbound-control reload
&lt;span class=&quot;nv&quot;&gt;PIDFile&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;/run/unbound.pid

&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;Install]
&lt;span class=&quot;nv&quot;&gt;WantedBy&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;multi-user.target
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;这里有两个 hook 的脚本。Debian Developer 对这个定制了点东西，先把他禁用掉&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;&lt;strong&gt;凡是DD (Debian Developer) 打包时自己定制的功能一律禁用掉&lt;/strong&gt;&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;顺着那个 hook 去这个文件里 &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/usr/lib/unbound/package-helper&lt;/code&gt;&lt;/p&gt;

&lt;p&gt;可以找到这样一段&lt;/p&gt;
&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c&quot;&gt;# Override these variables by editing or creating /etc/default/unbound.&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;RESOLVCONF&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;true&quot;&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;ROOT_TRUST_ANCHOR_UPDATE&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;true&quot;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;之后自己建个 &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/etc/default/unbound&lt;/code&gt; 把那个功能关掉&lt;/p&gt;
&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nb&quot;&gt;cat&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; /etc/default/unbound &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;EOF&lt;/span&gt;&lt;span class=&quot;sh&quot;&gt;
# 这个默认会修改 /etc/resolv.conf 文件，设成 false 禁用掉
RESOLVCONF=&quot;false&quot;

# 这个我也不知道具体是干什么的，反正是 DD (Debian Developer) 自己搞出来东西，直接禁用就行 ╮(￣▽￣)╭
ROOT_TRUST_ANCHOR_UPDATE=&quot;false&quot;
&lt;/span&gt;&lt;span class=&quot;no&quot;&gt;EOF
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;然后去修改 &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/etc/unbound/unbound.conf&lt;/code&gt;&lt;/p&gt;
&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;server:
    verbosity: 1
    num-threads: 2
    interface: 0.0.0.0@53
    &lt;span class=&quot;k&quot;&gt;do&lt;/span&gt;&lt;span class=&quot;nt&quot;&gt;-ip4&lt;/span&gt;: &lt;span class=&quot;nb&quot;&gt;yes
    &lt;/span&gt;&lt;span class=&quot;k&quot;&gt;do&lt;/span&gt;&lt;span class=&quot;nt&quot;&gt;-udp&lt;/span&gt;: &lt;span class=&quot;nb&quot;&gt;yes
    &lt;/span&gt;&lt;span class=&quot;k&quot;&gt;do&lt;/span&gt;&lt;span class=&quot;nt&quot;&gt;-tcp&lt;/span&gt;: no
    &lt;span class=&quot;k&quot;&gt;do&lt;/span&gt;&lt;span class=&quot;nt&quot;&gt;-not-query-localhost&lt;/span&gt;: no &lt;span class=&quot;c&quot;&gt;# 这句很关键，不把这个关掉上游 dns 不能用本地的 dns 服务&lt;/span&gt;
    access-control: 0.0.0.0/0 allow
    local-data: &lt;span class=&quot;s2&quot;&gt;&quot;test.com. A 192.168.1.1&quot;&lt;/span&gt;
    include: &lt;span class=&quot;s2&quot;&gt;&quot;/etc/unbound/unbound.conf.d/accelerated-domains.china.unbound.conf&quot;&lt;/span&gt;
    include: &lt;span class=&quot;s2&quot;&gt;&quot;/etc/unbound/unbound.conf.d/apple.china.unbound.conf&quot;&lt;/span&gt;
    include: &lt;span class=&quot;s2&quot;&gt;&quot;/etc/unbound/unbound.conf.d/google.china.unbound.conf&quot;&lt;/span&gt;
    forward-zone:
    	name: &lt;span class=&quot;s2&quot;&gt;&quot;.&quot;&lt;/span&gt;
    	forward-addr: 127.0.0.1@5352
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;之后把 &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;include&lt;/code&gt; 的文件放进去&lt;/p&gt;

&lt;h3 id=&quot;dnsmasq-china-list&quot;&gt;dnsmasq-china-list&lt;/h3&gt;
&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;git clone https://github.com/felixonmars/dnsmasq-china-list.git &lt;span class=&quot;nt&quot;&gt;--depth&lt;/span&gt; 1
&lt;span class=&quot;nb&quot;&gt;cd &lt;/span&gt;dnsmasq-china-list
make &lt;span class=&quot;nv&quot;&gt;SERVER&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;127.0.0.1@5351 unbound
&lt;span class=&quot;nb&quot;&gt;cp&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;*&lt;/span&gt;unbound.conf /etc/unbound/unbound.conf.d/
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;最后&quot;&gt;最后&lt;/h2&gt;
&lt;p&gt;&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;clash&lt;/code&gt; 的配置去看我前几篇文章&lt;/p&gt;

&lt;p&gt;最好别忘了 &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;systemctl restart unbound&lt;/code&gt;&lt;/p&gt;

&lt;p&gt;排查文件直接用 &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;dig&lt;/code&gt;, &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;nslookup&lt;/code&gt; 这个软件 debian 是在 &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;dnsutils&lt;/code&gt; 这个包里&lt;/p&gt;

&lt;h2 id=&quot;参考文章&quot;&gt;参考文章&lt;/h2&gt;

&lt;p&gt;&lt;a href=&quot;https://blog.phoenixlzx.com/2016/04/27/better-dns-with-unbound/&quot;&gt;使用 Unbound 搭建更好用的 DNS 服务器&lt;/a&gt;&lt;/p&gt;</content><author><name>metal A-wing</name></author><category term="network" /><summary type="html">今天是三月一日，我应该昨天更新，因为昨天是四年一度的二月二十九日。错过了了个好日子 T_T 。不过没关系，今天还是一年一次的三月一号那（</summary><media:thumbnail xmlns:media="http://search.yahoo.com/mrss/" url="https://a-wing.top/assets/avatar.png" /><media:content medium="image" url="https://a-wing.top/assets/avatar.png" xmlns:media="http://search.yahoo.com/mrss/" /></entry><entry><title type="html">自制旁路网关（一点一） ——增加clash订阅功能</title><link href="https://a-wing.top/network/2020/02/28/bypass_gateway-1-1_subscription.html" rel="alternate" type="text/html" title="自制旁路网关（一点一） ——增加clash订阅功能" /><published>2020-02-28T14:00:00+00:00</published><updated>2020-02-28T14:00:00+00:00</updated><id>https://a-wing.top/network/2020/02/28/bypass_gateway-1-1_subscription</id><content type="html" xml:base="https://a-wing.top/network/2020/02/28/bypass_gateway-1-1_subscription.html">&lt;p&gt;说起来也惭愧，因为觉得自己维护线路太麻烦，所以买了机场的服务，不过要使用机场，肯定要配合订阅来一起食用&lt;/p&gt;

&lt;p&gt;订阅功能原理：本质上就是访问一个带 token 的 url。所以直接去 &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;curl&lt;/code&gt; 那个地址就可以拿到配置文件&lt;/p&gt;

&lt;p&gt;本文是接上一篇文章&lt;a href=&quot;/network/2020/02/22/bypass_gateway-1_clash.html&quot;&gt;自制旁路网关（一） ——使用clash做代理&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;其实就是定时去获取最新配置，从配置文件中取出自己需要的内容，然后重新加载配置文件（订阅到的配置可能不是你都需要的，只需要提取你需要的字段）&lt;/p&gt;

&lt;p&gt;我用的是 n3ro.host（我并没有收广告费，n3ro 请打钱） 。。是基于 SSPanel 的机场，使用的是 clash 的订阅&lt;/p&gt;

&lt;p&gt;先写一个核心文件用于处理配置文件，去更新关键性的字段。（这一步请自行判断自家使用的机场，订阅的配置文件内容）&lt;/p&gt;

&lt;p&gt;你可以用这种方式来更新配置&lt;/p&gt;
&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nb&quot;&gt;cat &lt;/span&gt;config.yaml | &lt;span class=&quot;nb&quot;&gt;head&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-32&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; result.yaml &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; curl &lt;span class=&quot;s1&quot;&gt;'&amp;lt;Your Subscription Address&amp;gt;'&lt;/span&gt; | &lt;span class=&quot;nb&quot;&gt;grep &lt;/span&gt;Proxy: &lt;span class=&quot;nt&quot;&gt;-A&lt;/span&gt; 1000 &lt;span class=&quot;o&quot;&gt;&amp;gt;&amp;gt;&lt;/span&gt; result.yaml &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;cp &lt;/span&gt;result.yaml config.yaml
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;不过这种方法极为不靠谱，不去理解配置文件语义，只靠行和关键字匹配，自己用好像没什么问题&lt;/p&gt;

&lt;p&gt;我还是觉得理解配置文件并从中提取关键字段来更新的方法更好&lt;/p&gt;

&lt;p&gt;先把这个服务命名为 subladder（不要吐槽命名）&lt;/p&gt;

&lt;p&gt;创建文件&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/etc/clash/subladder.rb&lt;/code&gt;&lt;/p&gt;
&lt;div class=&quot;language-ruby highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c1&quot;&gt;#!/usr/bin/env ruby&lt;/span&gt;
&lt;span class=&quot;c1&quot;&gt;# Author: Metal A-wing&lt;/span&gt;
&lt;span class=&quot;c1&quot;&gt;# E-mail: 1@233.email&lt;/span&gt;
&lt;span class=&quot;c1&quot;&gt;# Create: 2020.02.22&lt;/span&gt;
&lt;span class=&quot;c1&quot;&gt;# Update: 2020.02.22&lt;/span&gt;

&lt;span class=&quot;nb&quot;&gt;require&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'yaml'&lt;/span&gt;

&lt;span class=&quot;n&quot;&gt;raw&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;YAML&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;load_file&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;no&quot;&gt;ENV&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'SOURCE_REMOTE'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;||&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'remote.yaml'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;config&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;YAML&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;load_file&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;no&quot;&gt;ENV&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'SOURCE_CONFIG'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;||&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'config.yaml'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;

&lt;span class=&quot;n&quot;&gt;update_whitelist&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;Proxy&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;Proxy Group&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;Rule&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;

&lt;span class=&quot;n&quot;&gt;update_whitelist&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;each&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;do&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;white&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;|&lt;/span&gt;
	&lt;span class=&quot;n&quot;&gt;config&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;white&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;raw&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;white&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;

&lt;span class=&quot;no&quot;&gt;File&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;open&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;no&quot;&gt;ENV&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'RESULT_CONFIG'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;||&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'result.yaml'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'w'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;|&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;f&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;f&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;write&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;config&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;to_yaml&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;预留里一下可配置的项。&lt;/p&gt;

&lt;h4 id=&quot;肯定会有人有些这样的疑问&quot;&gt;&lt;strong&gt;肯定会有人有些这样的疑问&lt;/strong&gt;&lt;/h4&gt;

&lt;ol&gt;
  &lt;li&gt;为什么要用 ruby 去实现这个功能？
    &lt;blockquote&gt;
      &lt;p&gt;&lt;strong&gt;老子想用什么语言就用什么语言，不服自己来写，我尽可能把这个处理脚本写的简单易懂&lt;/strong&gt;&lt;/p&gt;

      &lt;p&gt;很多语言 yaml 处理是使用第三方库来处理&lt;/p&gt;
    &lt;/blockquote&gt;
  &lt;/li&gt;
  &lt;li&gt;为什么不用 ruby 获取配置文件？
    &lt;blockquote&gt;
      &lt;p&gt;单独的文件处理应该是对整体无害的。只负责处理并生成的新的配置文件就够了&lt;/p&gt;
    &lt;/blockquote&gt;
  &lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;这里我们把配置用的字段统一提取放到一个新文件里 &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/etc/clash/subladder.conf&lt;/code&gt;&lt;/p&gt;
&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c&quot;&gt;# 订阅地址&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;ADDRESS&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;https://nnn3ro.link/link/&amp;lt;Your Token&amp;gt;&quot;&lt;/span&gt;

&lt;span class=&quot;c&quot;&gt;# 订阅的源文件缓存的文件名。被更新的字段来源的文件&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;SOURCE_REMOTE&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;remote.yaml&quot;&lt;/span&gt;

&lt;span class=&quot;c&quot;&gt;# clash 实际加载的配置文件。（以这个文件为基本配置文件，去更新关键的字段）&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;SOURCE_CONFIG&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;config.yaml&quot;&lt;/span&gt;

&lt;span class=&quot;c&quot;&gt;# 处理后的文件，更新了关键字段的结果文件&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;RESULT_CONFIG&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;result.yaml&quot;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;然后添加一个 systemd 单元的配置文件
&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/etc/systemd/system/subladder.service&lt;/code&gt;&lt;/p&gt;

&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;Unit]
&lt;span class=&quot;nv&quot;&gt;Description&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;Subscription Remote Configuration
&lt;span class=&quot;nv&quot;&gt;After&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;network.target

&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;Service]
&lt;span class=&quot;nv&quot;&gt;Type&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;oneshot
&lt;span class=&quot;nv&quot;&gt;WorkingDirectory&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;/etc/clash/
&lt;span class=&quot;nv&quot;&gt;EnvironmentFile&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;/etc/clash/subladder.conf
&lt;span class=&quot;nv&quot;&gt;ExecStartPre&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;/usr/bin/curl &lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;ADDRESS&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-o&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;SOURCE_REMOTE&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;ExecStart&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;/usr/bin/ruby subladder.rb
&lt;span class=&quot;nv&quot;&gt;ExecStartPost&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;/bin/sh &lt;span class=&quot;nt&quot;&gt;-c&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;cp &lt;/span&gt;&lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;SOURCE_REMOTE&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt; backup &amp;amp;&amp;amp; cp &lt;/span&gt;&lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;RESULT_CONFIG&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt; &lt;/span&gt;&lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;SOURCE_CONFIG&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt; &amp;amp;&amp;amp; systemctl restart clash.service&quot;&lt;/span&gt;

&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;Install]
&lt;span class=&quot;nv&quot;&gt;WantedBy&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;multi-user.target
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;这个文件我不想解释了。应该都能读懂&lt;/p&gt;

&lt;p&gt;简单的说就是用 curl 去获取订阅到的配置文件，然后生成自己需要的配置文件，备份原来的配置，更新并重启&lt;/p&gt;

&lt;p&gt;最后使用使用 systemd.timer 来定时执行任务 &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/etc/systemd/system/subladder.timer&lt;/code&gt;&lt;/p&gt;
&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;Unit]
&lt;span class=&quot;nv&quot;&gt;Description&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;Run Subladder Daily

&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;Timer]
&lt;span class=&quot;c&quot;&gt;#OnCalendar=daily&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;OnCalendar&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;*&lt;/span&gt;-&lt;span class=&quot;k&quot;&gt;*&lt;/span&gt;-&lt;span class=&quot;k&quot;&gt;*&lt;/span&gt; 04:00:00
&lt;span class=&quot;nv&quot;&gt;RandomizedDelaySec&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;60m

&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;Install]
&lt;span class=&quot;nv&quot;&gt;WantedBy&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;timers.target
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;为什么不使用 &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;OnCalendar=daily&lt;/code&gt; 。。。这个会在每天零点更新，实际测试的结果是：零点更新会失败，可能机场本身会在零点定时跑什么服务&lt;/p&gt;

&lt;p&gt;然后启用这个定时器 &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;systemctl enable subladder.timer&lt;/code&gt;&lt;/p&gt;

&lt;p&gt;可以用这个来查看定时执行状态 &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;systemctl list-timers&lt;/code&gt;&lt;/p&gt;</content><author><name>metal A-wing</name></author><category term="network" /><summary type="html">说起来也惭愧，因为觉得自己维护线路太麻烦，所以买了机场的服务，不过要使用机场，肯定要配合订阅来一起食用</summary><media:thumbnail xmlns:media="http://search.yahoo.com/mrss/" url="https://a-wing.top/assets/avatar.png" /><media:content medium="image" url="https://a-wing.top/assets/avatar.png" xmlns:media="http://search.yahoo.com/mrss/" /></entry><entry><title type="html">自制旁路网关（一） ——使用clash做代理</title><link href="https://a-wing.top/network/2020/02/22/bypass_gateway-1_clash.html" rel="alternate" type="text/html" title="自制旁路网关（一） ——使用clash做代理" /><published>2020-02-22T14:00:00+00:00</published><updated>2020-02-22T14:00:00+00:00</updated><id>https://a-wing.top/network/2020/02/22/bypass_gateway-1_clash</id><content type="html" xml:base="https://a-wing.top/network/2020/02/22/bypass_gateway-1_clash.html">&lt;p&gt;由于武汉新冠肺炎（&lt;a href=&quot;https://zh.wikipedia.org/wiki/2019%E5%86%A0%E7%8A%B6%E7%97%85%E6%AF%92%E7%97%85&quot;&gt;COVID-19&lt;/a&gt;）的关系，我被困在老家，自从我买了 ac68u 之后基本上就再也没折腾过网。由于长期在家办公，需要好的网络，还好手里有树莓派，还有 nas。只能使用传统技能（时代变化还真实快，一觉醒来工具链全变了）&lt;/p&gt;

&lt;p&gt;这次优化网路的经历我准备写一个系列（预计三篇文章：代理，dns，分流增强）。我也不知道能不能写完，也说不定后面两篇文章会咕掉&lt;/p&gt;

&lt;h4 id=&quot;实际上并没有咕掉而且还多写了一篇本系列文章&quot;&gt;&lt;strong&gt;实际上并没有咕掉，而且还多写了一篇。本系列文章：&lt;/strong&gt;&lt;/h4&gt;
&lt;ol&gt;
  &lt;li&gt;这应该算是第零篇，建议先看这篇 &lt;a href=&quot;/linux/2019/04/01/debian_network.html&quot;&gt;细说 Debian 的网络管理 network/interfaces&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;自制旁路网关（一） ——使用clash做代理 (本篇)&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;/network/2020/02/28/bypass_gateway-1-1_subscription.html&quot;&gt;自制旁路网关（一点一） ——增加clash订阅功能&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;/network/2020/03/01/bypass_gateway-2_improve_dns.html&quot;&gt;自制旁路网关（二） ——用unbound和smartdns来优化dns服务&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;/network/2020/03/07/bypass_gateway-3_nftables.html&quot;&gt;自制旁路网关（三） ——nftables 来做透明代理&lt;/a&gt;&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;&lt;strong&gt;不可否认，我省略了一些过于基础的细节，但本文的确是从我的笔记上摘录的&lt;/strong&gt;&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;本系列用到的代码都在 Raspbian GNU/Linux 10 (buster) 上验证过，请放心食用&lt;/strong&gt;&lt;/p&gt;

&lt;p&gt;代理软件使用 clash ，这个软件的特色就是他的分流功能和自动选择节点&lt;/p&gt;

&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c&quot;&gt;# 我是树莓 pi3b 请根据cpu架构选择合适的二进制包&lt;/span&gt;
wget https://github.com/Dreamacro/clash/releases/download/v0.17.1/clash-linux-armv7-v0.17.1.gz
&lt;span class=&quot;nb&quot;&gt;gzip&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-d&lt;/span&gt; clash-linux-armv7-v0.17.1.gz
&lt;span class=&quot;nb&quot;&gt;install&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-Dm755&lt;/span&gt; clash-linux-armv7-v0.17.1 /usr/local/bin/clash

&lt;span class=&quot;c&quot;&gt;# 把 clash 配置目录放在 /etc 目录下&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;mkdir&lt;/span&gt; /etc/clash/
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;创建一个本地的 systemd 配置&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/etc/systemd/system/clash.service&lt;/code&gt;&lt;/p&gt;

&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;Unit]
&lt;span class=&quot;nv&quot;&gt;Description&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;clash service
&lt;span class=&quot;nv&quot;&gt;After&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;network.target

&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;Service]
&lt;span class=&quot;nv&quot;&gt;Type&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;simple
&lt;span class=&quot;nv&quot;&gt;ExecStart&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;/usr/local/bin/clash &lt;span class=&quot;nt&quot;&gt;-d&lt;/span&gt; /etc/clash/
&lt;span class=&quot;nv&quot;&gt;Restart&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;on-failure

&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;Install]
&lt;span class=&quot;nv&quot;&gt;WantedBy&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;multi-user.target
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;systemctl start clash.service
systemctl &lt;span class=&quot;nb&quot;&gt;enable &lt;/span&gt;clash.service

&lt;span class=&quot;c&quot;&gt;# 然后测试下 socks 代理是否可用&lt;/span&gt;
curl &lt;span class=&quot;nt&quot;&gt;--socks5&lt;/span&gt; localhost:7891 google.com
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;clash 里面其实内置了 dns 服务器的，这个默认是关闭的（clash 配置文件的官方文档写的够细了，只是藏的比较隐蔽）&lt;/p&gt;

&lt;div class=&quot;language-yaml highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;na&quot;&gt;dns&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
  &lt;span class=&quot;na&quot;&gt;enable&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;true&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;# set true to enable dns (default is false)&lt;/span&gt;
  &lt;span class=&quot;na&quot;&gt;ipv6&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;false&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;# default is false&lt;/span&gt;
  &lt;span class=&quot;na&quot;&gt;listen&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;0.0.0.0:53&lt;/span&gt;
  &lt;span class=&quot;c1&quot;&gt;# default-nameserver: # resolve dns nameserver host, should fill pure IP&lt;/span&gt;
  &lt;span class=&quot;c1&quot;&gt;#   - 114.114.114.114&lt;/span&gt;
  &lt;span class=&quot;c1&quot;&gt;#   - 8.8.8.8&lt;/span&gt;
  &lt;span class=&quot;na&quot;&gt;enhanced-mode&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;redir-host&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;# or fake-ip&lt;/span&gt;
  &lt;span class=&quot;c1&quot;&gt;# fake-ip-range: 198.18.0.1/16 # if you don't know what it is, don't change it&lt;/span&gt;
  &lt;span class=&quot;na&quot;&gt;fake-ip-filter&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;*.lan'&lt;/span&gt;
    &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;localhost.ptlogin2.qq.com&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;关于 fake-ip 功能，请出门左转去 &lt;a href=&quot;https://blog.skk.moe/post/alternate-surge-koolclash-as-gateway/&quot;&gt;苏卡卡的 使用 KoolClash 作为代理网关&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;然后我们再给 clash 加个 UI，这个 webUI 没有提供预编译版本，要自行编译&lt;/p&gt;

&lt;p&gt;其实我觉得这个 UI 没啥用&lt;/p&gt;
&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;wget https://github.com/Dreamacro/clash-dashboard/archive/v0.3.0.tar.gz
&lt;span class=&quot;nb&quot;&gt;tar&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-xzf&lt;/span&gt; v0.3.0.tar.gz
&lt;span class=&quot;nb&quot;&gt;cd &lt;/span&gt;clash-dashboard-0.3.0/
npm &lt;span class=&quot;nb&quot;&gt;install
&lt;/span&gt;npm run build

&lt;span class=&quot;c&quot;&gt;# 把编译结果上传到你的 clash 服务端。。。。因为我是在自己电脑上编译的&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;tar&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-cJf&lt;/span&gt; - dist/ | ssh &amp;lt;username&amp;gt;@&amp;lt;&lt;span class=&quot;nb&quot;&gt;hostname&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'tar -xJf -'&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;cp&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-r&lt;/span&gt; dist /etc/clash/dashboard
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;然后来修改 clash 配置，webUI 相关的有这几项&lt;/p&gt;
&lt;div class=&quot;language-yaml highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c1&quot;&gt;# RESTful API for clash&lt;/span&gt;
&lt;span class=&quot;na&quot;&gt;external-controller&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;127.0.0.1:9090&lt;/span&gt;

&lt;span class=&quot;c1&quot;&gt;# 这个地方写编译成静态资源的路径，可以是相对路径或绝对路径 然后用扩展配置的地址 (`external-controller`) + /ui 访问&lt;/span&gt;
&lt;span class=&quot;c1&quot;&gt;# 例如：http://127.0.0.1:9090/ui&lt;/span&gt;
&lt;span class=&quot;na&quot;&gt;external-ui&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;dashboard&lt;/span&gt;

&lt;span class=&quot;c1&quot;&gt;# Secret for RESTful API (Optional)&lt;/span&gt;
&lt;span class=&quot;c1&quot;&gt;# secret: &quot;&quot;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h3 id=&quot;我个人是不推荐旁路网关自身流量也走透明代理&quot;&gt;我个人是不推荐旁路网关自身流量也走透明代理&lt;/h3&gt;

&lt;p&gt;使用 iptable 来转发流量&lt;/p&gt;
&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;iptables &lt;span class=&quot;nt&quot;&gt;-t&lt;/span&gt; nat &lt;span class=&quot;nt&quot;&gt;-N&lt;/span&gt; CLASH

&lt;span class=&quot;c&quot;&gt;# 私有 ip 流量不转发，完整的在下面&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# 设置的 fake-ip 请注意检查这里&lt;/span&gt;
iptables &lt;span class=&quot;nt&quot;&gt;-t&lt;/span&gt; nat &lt;span class=&quot;nt&quot;&gt;-A&lt;/span&gt; CLASH &lt;span class=&quot;nt&quot;&gt;-d&lt;/span&gt; 192.168.0.0/16 &lt;span class=&quot;nt&quot;&gt;-j&lt;/span&gt; RETURN

iptables &lt;span class=&quot;nt&quot;&gt;-t&lt;/span&gt; nat &lt;span class=&quot;nt&quot;&gt;-A&lt;/span&gt; CLASH &lt;span class=&quot;nt&quot;&gt;-p&lt;/span&gt; tcp &lt;span class=&quot;nt&quot;&gt;-j&lt;/span&gt; REDIRECT &lt;span class=&quot;nt&quot;&gt;--to-ports&lt;/span&gt; 7892
iptables &lt;span class=&quot;nt&quot;&gt;-t&lt;/span&gt; nat &lt;span class=&quot;nt&quot;&gt;-A&lt;/span&gt; PREROUTING &lt;span class=&quot;nt&quot;&gt;-p&lt;/span&gt; tcp &lt;span class=&quot;nt&quot;&gt;-j&lt;/span&gt; CLASH
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c&quot;&gt;# 内部流量不转发给 CLASH 直通&lt;/span&gt;
iptables &lt;span class=&quot;nt&quot;&gt;-t&lt;/span&gt; nat &lt;span class=&quot;nt&quot;&gt;-A&lt;/span&gt; CLASH &lt;span class=&quot;nt&quot;&gt;-d&lt;/span&gt; 0.0.0.0/8 &lt;span class=&quot;nt&quot;&gt;-j&lt;/span&gt; RETURN
iptables &lt;span class=&quot;nt&quot;&gt;-t&lt;/span&gt; nat &lt;span class=&quot;nt&quot;&gt;-A&lt;/span&gt; CLASH &lt;span class=&quot;nt&quot;&gt;-d&lt;/span&gt; 10.0.0.0/8 &lt;span class=&quot;nt&quot;&gt;-j&lt;/span&gt; RETURN
iptables &lt;span class=&quot;nt&quot;&gt;-t&lt;/span&gt; nat &lt;span class=&quot;nt&quot;&gt;-A&lt;/span&gt; CLASH &lt;span class=&quot;nt&quot;&gt;-d&lt;/span&gt; 127.0.0.0/8 &lt;span class=&quot;nt&quot;&gt;-j&lt;/span&gt; RETURN
iptables &lt;span class=&quot;nt&quot;&gt;-t&lt;/span&gt; nat &lt;span class=&quot;nt&quot;&gt;-A&lt;/span&gt; CLASH &lt;span class=&quot;nt&quot;&gt;-d&lt;/span&gt; 169.254.0.0/16 &lt;span class=&quot;nt&quot;&gt;-j&lt;/span&gt; RETURN
iptables &lt;span class=&quot;nt&quot;&gt;-t&lt;/span&gt; nat &lt;span class=&quot;nt&quot;&gt;-A&lt;/span&gt; CLASH &lt;span class=&quot;nt&quot;&gt;-d&lt;/span&gt; 172.16.0.0/12 &lt;span class=&quot;nt&quot;&gt;-j&lt;/span&gt; RETURN
iptables &lt;span class=&quot;nt&quot;&gt;-t&lt;/span&gt; nat &lt;span class=&quot;nt&quot;&gt;-A&lt;/span&gt; CLASH &lt;span class=&quot;nt&quot;&gt;-d&lt;/span&gt; 192.168.0.0/16 &lt;span class=&quot;nt&quot;&gt;-j&lt;/span&gt; RETURN
iptables &lt;span class=&quot;nt&quot;&gt;-t&lt;/span&gt; nat &lt;span class=&quot;nt&quot;&gt;-A&lt;/span&gt; CLASH &lt;span class=&quot;nt&quot;&gt;-d&lt;/span&gt; 224.0.0.0/4 &lt;span class=&quot;nt&quot;&gt;-j&lt;/span&gt; RETURN
iptables &lt;span class=&quot;nt&quot;&gt;-t&lt;/span&gt; nat &lt;span class=&quot;nt&quot;&gt;-A&lt;/span&gt; CLASH &lt;span class=&quot;nt&quot;&gt;-d&lt;/span&gt; 240.0.0.0/4 &lt;span class=&quot;nt&quot;&gt;-j&lt;/span&gt; RETURN
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;我觉得只写 iptables 版，我会被人耻笑（这和网上随手一搜的垃圾教程有什么两样。对，其实我写的也是垃圾）&lt;/p&gt;

&lt;p&gt;来个 &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;nftables&lt;/code&gt; 版的 （Raspbian buster 要先安装个 nft 的前端 &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;apt install nftables&lt;/code&gt;）&lt;/p&gt;

&lt;p&gt;先创建一个私有地址的定义文件 &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/etc/nftables/private.nft&lt;/code&gt;&lt;/p&gt;
&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;define private_list &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
	0.0.0.0/8,
	10.0.0.0/8,
	127.0.0.0/8,
	169.254.0.0/16,
	172.16.0.0/12,
	192.168.0.0/16,
	224.0.0.0/4,
	240.0.0.0/4
&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;再来修改主配置文件 &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/etc/nftables.conf&lt;/code&gt;&lt;/p&gt;
&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c&quot;&gt;#!/usr/sbin/nft -f&lt;/span&gt;

include &lt;span class=&quot;s2&quot;&gt;&quot;/etc/nftables/private.nft&quot;&lt;/span&gt;

table ip nat &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
	chain proxy &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
		ip daddr &lt;span class=&quot;nv&quot;&gt;$private_list&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;return
			&lt;/span&gt;ip protocol tcp redirect to :7892
	&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
	chain prerouting &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
		&lt;span class=&quot;nb&quot;&gt;type &lt;/span&gt;nat hook prerouting priority 0&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; policy accept&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
		jump proxy
	&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;然后执行清空设置 &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;nft flush ruleset&lt;/code&gt;，让新的设置生效 &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;nft -f /etc/nftables.conf&lt;/code&gt;&lt;/p&gt;

&lt;p&gt;或者直接这样 &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;sudo sh -c &quot;nft flush ruleset &amp;amp;&amp;amp; nft -f /etc/nftables.conf&quot;&lt;/code&gt;&lt;/p&gt;

&lt;p&gt;然后通过这条命令来看当前 nftables 的状态 &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;sudo nft list ruleset&lt;/code&gt;&lt;/p&gt;

&lt;p&gt;最后再设置一下开机启动&lt;/p&gt;
&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;systemctl &lt;span class=&quot;nb&quot;&gt;enable &lt;/span&gt;nftables.service
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;参考文章&quot;&gt;参考文章&lt;/h2&gt;
&lt;p&gt;&lt;a href=&quot;https://blog.skk.moe/post/alternate-surge-koolclash-as-gateway/&quot;&gt;使用 KoolClash 作为代理网关&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://breakertt.moe/2019/08/20/clash_gateway/index.html&quot;&gt;在 Ubuntu18.04 上使用 clash 部署旁路代理网关（透明代理）&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://toutyrater.github.io/app/transparent_proxy.html&quot;&gt;V2Ray 做透明代理&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://ghost.qinan.co/debian10_iptables_to_nftables/&quot;&gt;debian10 使用 nftables 替换 iptables&lt;/a&gt;&lt;/p&gt;</content><author><name>metal A-wing</name></author><category term="network" /><summary type="html">由于武汉新冠肺炎（COVID-19）的关系，我被困在老家，自从我买了 ac68u 之后基本上就再也没折腾过网。由于长期在家办公，需要好的网络，还好手里有树莓派，还有 nas。只能使用传统技能（时代变化还真实快，一觉醒来工具链全变了）</summary><media:thumbnail xmlns:media="http://search.yahoo.com/mrss/" url="https://a-wing.top/assets/avatar.png" /><media:content medium="image" url="https://a-wing.top/assets/avatar.png" xmlns:media="http://search.yahoo.com/mrss/" /></entry><entry><title type="html">使用 OpenCV 来做单元测试</title><link href="https://a-wing.top/program/2019/11/05/use_opencv_for_unittest.html" rel="alternate" type="text/html" title="使用 OpenCV 来做单元测试" /><published>2019-11-05T09:00:00+00:00</published><updated>2019-11-05T09:00:00+00:00</updated><id>https://a-wing.top/program/2019/11/05/use_opencv_for_unittest</id><content type="html" xml:base="https://a-wing.top/program/2019/11/05/use_opencv_for_unittest.html">&lt;p&gt;最近一直都在搞图像传输，webrtc 可以检测网络状况来调整码率。为了探究图像传输中损失了多少数据，用 opencv 来计算输入视频流和输出视频流的相似性&lt;/p&gt;

&lt;p&gt;不过本人作为一个不懂算法，不懂C++， 不懂openCV 的菜鸡。（我还真把这个东西给做出来了&lt;/p&gt;

&lt;h3 id=&quot;如何检测视频视频的相似性&quot;&gt;如何检测视频视频的相似性&lt;/h3&gt;
&lt;p&gt;先来科普两个概念：&lt;/p&gt;
&lt;ol&gt;
  &lt;li&gt;
    &lt;p&gt;峰值信噪比 PSNR (Peak signal-to-noise ratio)
https://en.wikipedia.org/wiki/Peak_signal-to-noise_ratio&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;结构相似性 SSIM (Structural similarity)
https://en.wikipedia.org/wiki/Structural_similarity&lt;/p&gt;
  &lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;这个处理本身是把视频拆成图像帧，然回分成 RGB 分辨对比&lt;/p&gt;

&lt;p&gt;然回把这个代码直接拿过来用就行（好敷衍。。。&lt;/p&gt;

&lt;p&gt;代码来源：https://docs.opencv.org/master/d5/dc4/tutorial_video_input_psnr_ssim.html&lt;/p&gt;
&lt;div class=&quot;language-cpp highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;cp&quot;&gt;#include &amp;lt;iostream&amp;gt; // for standard I/O
#include &amp;lt;string&amp;gt;   // for strings
#include &amp;lt;iomanip&amp;gt;  // for controlling float print precision
#include &amp;lt;sstream&amp;gt;  // string to number conversion
#include &amp;lt;opencv2/core.hpp&amp;gt;     // Basic OpenCV structures (cv::Mat, Scalar)
#include &amp;lt;opencv2/imgproc.hpp&amp;gt;  // Gaussian Blur
#include &amp;lt;opencv2/videoio.hpp&amp;gt;
#include &amp;lt;opencv2/highgui.hpp&amp;gt;  // OpenCV window I/O
&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;using&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;namespace&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;std&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;using&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;namespace&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;cv&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;kt&quot;&gt;double&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;getPSNR&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Mat&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;I1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Mat&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;I2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;Scalar&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;getMSSIM&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Mat&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;I1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Mat&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;I2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;help&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;cout&lt;/span&gt;
        &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;------------------------------------------------------------------------------&quot;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;endl&lt;/span&gt;
        &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;This program shows how to read a video file with OpenCV. In addition, it &quot;&lt;/span&gt;
        &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;tests the similarity of two input videos first with PSNR, and for the frames &quot;&lt;/span&gt;
        &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;below a PSNR trigger value, also with MSSIM.&quot;&lt;/span&gt;                                   &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;endl&lt;/span&gt;
        &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;Usage:&quot;&lt;/span&gt;                                                                         &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;endl&lt;/span&gt;
        &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;./video-input-psnr-ssim &amp;lt;referenceVideo&amp;gt; &amp;lt;useCaseTestVideo&amp;gt; &amp;lt;PSNR_Trigger_Value&amp;gt; &amp;lt;Wait_Between_Frames&amp;gt; &quot;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;endl&lt;/span&gt;
        &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;--------------------------------------------------------------------------&quot;&lt;/span&gt;     &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;endl&lt;/span&gt;
        &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;endl&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;main&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;argc&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;char&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;argv&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[])&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;help&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;();&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;argc&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;5&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;cout&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;Not enough parameters&quot;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;endl&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;stringstream&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;conv&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;string&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;sourceReference&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;argv&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;sourceCompareWith&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;argv&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;];&lt;/span&gt;
    &lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;psnrTriggerValue&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;delay&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;conv&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;argv&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;endl&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;argv&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;];&lt;/span&gt;       &lt;span class=&quot;c1&quot;&gt;// put in the strings&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;conv&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;psnrTriggerValue&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;delay&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;        &lt;span class=&quot;c1&quot;&gt;// take out the numbers&lt;/span&gt;
    &lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;frameNum&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;          &lt;span class=&quot;c1&quot;&gt;// Frame counter&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;VideoCapture&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;captRefrnc&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;sourceReference&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;captUndTst&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;sourceCompareWith&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;!&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;captRefrnc&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;isOpened&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;())&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;cout&lt;/span&gt;  &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;Could not open reference &quot;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;sourceReference&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;endl&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;!&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;captUndTst&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;isOpened&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;())&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;cout&lt;/span&gt;  &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;Could not open case test &quot;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;sourceCompareWith&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;endl&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;Size&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;refS&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Size&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;((&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;captRefrnc&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;get&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;CAP_PROP_FRAME_WIDTH&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;
                     &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;captRefrnc&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;get&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;CAP_PROP_FRAME_HEIGHT&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)),&lt;/span&gt;
         &lt;span class=&quot;n&quot;&gt;uTSi&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Size&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;((&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;captUndTst&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;get&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;CAP_PROP_FRAME_WIDTH&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;
                     &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;captUndTst&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;get&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;CAP_PROP_FRAME_HEIGHT&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;));&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;refS&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;uTSi&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;cout&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;Inputs have different size!!! Closing.&quot;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;endl&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;char&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;WIN_UT&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;Under Test&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;char&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;WIN_RF&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;Reference&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;// Windows&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;namedWindow&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;WIN_RF&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;WINDOW_AUTOSIZE&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;namedWindow&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;WIN_UT&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;WINDOW_AUTOSIZE&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;moveWindow&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;WIN_RF&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;400&lt;/span&gt;       &lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;         &lt;span class=&quot;c1&quot;&gt;//750,  2 (bernat =0)&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;moveWindow&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;WIN_UT&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;refS&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;width&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;         &lt;span class=&quot;c1&quot;&gt;//1500, 2&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;cout&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;Reference frame resolution: Width=&quot;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;refS&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;width&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;  Height=&quot;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;refS&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;height&lt;/span&gt;
         &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot; of nr#: &quot;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;captRefrnc&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;get&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;CAP_PROP_FRAME_COUNT&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;endl&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;cout&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;PSNR trigger value &quot;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;setiosflags&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ios&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;fixed&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;setprecision&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
         &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;psnrTriggerValue&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;endl&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;Mat&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;frameReference&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;frameUnderTest&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;kt&quot;&gt;double&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;psnrV&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;Scalar&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;mssimV&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;for&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(;;)&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;//Show the image captured in the window and repeat&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;captRefrnc&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;frameReference&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;captUndTst&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;frameUnderTest&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;frameReference&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;empty&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;||&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;frameUnderTest&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;empty&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;())&lt;/span&gt;
        &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
            &lt;span class=&quot;n&quot;&gt;cout&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot; &amp;lt; &amp;lt; &amp;lt;  Game over!  &amp;gt; &amp;gt; &amp;gt; &quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
            &lt;span class=&quot;k&quot;&gt;break&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
        &lt;span class=&quot;o&quot;&gt;++&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;frameNum&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;cout&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;Frame: &quot;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;frameNum&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;# &quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;psnrV&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;getPSNR&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;frameReference&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;frameUnderTest&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;cout&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;setiosflags&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ios&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;fixed&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;setprecision&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;psnrV&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;dB&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;psnrV&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;psnrTriggerValue&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;psnrV&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
        &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
            &lt;span class=&quot;n&quot;&gt;mssimV&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;getMSSIM&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;frameReference&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;frameUnderTest&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
            &lt;span class=&quot;n&quot;&gt;cout&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot; MSSIM: &quot;&lt;/span&gt;
                &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot; R &quot;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;setiosflags&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ios&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;fixed&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;setprecision&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;mssimV&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;val&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;100&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;%&quot;&lt;/span&gt;
                &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot; G &quot;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;setiosflags&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ios&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;fixed&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;setprecision&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;mssimV&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;val&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;100&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;%&quot;&lt;/span&gt;
                &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot; B &quot;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;setiosflags&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ios&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;fixed&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;setprecision&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;mssimV&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;val&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;100&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;%&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;cout&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;endl&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;imshow&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;WIN_RF&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;frameReference&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;imshow&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;WIN_UT&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;frameUnderTest&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
        &lt;span class=&quot;kt&quot;&gt;char&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;c&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;char&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;waitKey&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;delay&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;c&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;27&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;break&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;kt&quot;&gt;double&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;getPSNR&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Mat&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;I1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Mat&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;I2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;Mat&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;s1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;absdiff&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;I1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;I2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;s1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;       &lt;span class=&quot;c1&quot;&gt;// |I1 - I2|&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;s1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;convertTo&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;s1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;CV_32F&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;  &lt;span class=&quot;c1&quot;&gt;// cannot make a square on 8 bits&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;s1&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;s1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;mul&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;s1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;           &lt;span class=&quot;c1&quot;&gt;// |I1 - I2|^2&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;Scalar&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;s&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;sum&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;s1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;        &lt;span class=&quot;c1&quot;&gt;// sum elements per channel&lt;/span&gt;
    &lt;span class=&quot;kt&quot;&gt;double&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;sse&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;s&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;val&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;s&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;val&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;s&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;val&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;];&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;// sum channels&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;sse&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;=&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;1e-10&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;// for small values return zero&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;else&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;kt&quot;&gt;double&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;mse&lt;/span&gt;  &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;sse&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;/&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;double&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;I1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;channels&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;I1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;total&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;());&lt;/span&gt;
        &lt;span class=&quot;kt&quot;&gt;double&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;psnr&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;10.0&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;log10&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;((&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;255&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;255&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;/&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;mse&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;psnr&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;Scalar&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;getMSSIM&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Mat&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;i1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Mat&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;i2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;double&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;C1&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;6.5025&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;C2&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;58.5225&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;cm&quot;&gt;/***************************** INITS **********************************/&lt;/span&gt;
    &lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;d&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;CV_32F&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;Mat&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;I1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;I2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;i1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;convertTo&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;I1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;d&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;            &lt;span class=&quot;c1&quot;&gt;// cannot calculate on one byte large values&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;i2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;convertTo&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;I2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;d&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;Mat&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;I2_2&lt;/span&gt;   &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;I2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;mul&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;I2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;        &lt;span class=&quot;c1&quot;&gt;// I2^2&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;Mat&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;I1_2&lt;/span&gt;   &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;I1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;mul&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;I1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;        &lt;span class=&quot;c1&quot;&gt;// I1^2&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;Mat&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;I1_I2&lt;/span&gt;  &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;I1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;mul&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;I2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;        &lt;span class=&quot;c1&quot;&gt;// I1 * I2&lt;/span&gt;
    &lt;span class=&quot;cm&quot;&gt;/*************************** END INITS **********************************/&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;Mat&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;mu1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;mu2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;                   &lt;span class=&quot;c1&quot;&gt;// PRELIMINARY COMPUTING&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;GaussianBlur&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;I1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;mu1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Size&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;11&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;11&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;1.5&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;GaussianBlur&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;I2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;mu2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Size&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;11&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;11&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;1.5&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;Mat&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;mu1_2&lt;/span&gt;   &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;   &lt;span class=&quot;n&quot;&gt;mu1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;mul&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;mu1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;Mat&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;mu2_2&lt;/span&gt;   &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;   &lt;span class=&quot;n&quot;&gt;mu2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;mul&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;mu2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;Mat&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;mu1_mu2&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;   &lt;span class=&quot;n&quot;&gt;mu1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;mul&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;mu2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;Mat&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;sigma1_2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;sigma2_2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;sigma12&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;GaussianBlur&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;I1_2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;sigma1_2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Size&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;11&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;11&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;1.5&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;sigma1_2&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;mu1_2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;GaussianBlur&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;I2_2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;sigma2_2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Size&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;11&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;11&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;1.5&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;sigma2_2&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;mu2_2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;GaussianBlur&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;I1_I2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;sigma12&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Size&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;11&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;11&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;1.5&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;sigma12&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;mu1_mu2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;Mat&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;t1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;t2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;t3&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;t1&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;mu1_mu2&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;C1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;t2&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;sigma12&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;C2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;t3&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;t1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;mul&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;t2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;                 &lt;span class=&quot;c1&quot;&gt;// t3 = ((2*mu1_mu2 + C1).*(2*sigma12 + C2))&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;t1&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;mu1_2&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;mu2_2&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;C1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;t2&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;sigma1_2&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;sigma2_2&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;C2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;t1&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;t1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;mul&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;t2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;                 &lt;span class=&quot;c1&quot;&gt;// t1 =((mu1_2 + mu2_2 + C1).*(sigma1_2 + sigma2_2 + C2))&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;Mat&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ssim_map&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;divide&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;t3&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;t1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ssim_map&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;        &lt;span class=&quot;c1&quot;&gt;// ssim_map =  t3./t1;&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;Scalar&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;mssim&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;mean&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ssim_map&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;   &lt;span class=&quot;c1&quot;&gt;// mssim = average of ssim map&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;mssim&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;嗯？ 不想看英文。这里有个中文版（不过不建议看这个中文版）https://www.w3cschool.cn/opencv/opencv-v4na2dr6.html&lt;/p&gt;

&lt;p&gt;之后编译源码&lt;/p&gt;
&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c&quot;&gt;# 安装依赖 我在 debian:buster 上测试运行的&lt;/span&gt;
apt-get update &lt;span class=&quot;nt&quot;&gt;-y&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; apt-get &lt;span class=&quot;nb&quot;&gt;install&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-y&lt;/span&gt; libopencv-dev g++ wget

g++ video-input-psnr-ssim.cpp &lt;span class=&quot;nt&quot;&gt;-o&lt;/span&gt; video-input-psnr-ssim &lt;span class=&quot;nt&quot;&gt;-I&lt;/span&gt; /usr/include/opencv4 &lt;span class=&quot;nt&quot;&gt;-L&lt;/span&gt; /usr/lib &lt;span class=&quot;nt&quot;&gt;-lopencv_core&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-lopencv_highgui&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-lopencv_imgproc&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-lopencv_videoio&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;这样来运行：&lt;/p&gt;
&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;wget https://github.com/opencv/opencv/raw/master/samples/data/Megamind.avi
wget https://github.com/opencv/opencv/raw/master/samples/data/Megamind_bugy.avi
./video-input-psnr-ssim Megamind.avi Megamind_bugy.avi 35 10
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h3 id=&quot;之后就是把这个流程自动化&quot;&gt;之后就是把这个流程自动化&lt;/h3&gt;

&lt;p&gt;这个要跑在 ci 里自动输出结果的。显示窗口可不行，还要改造一下。直接去掉窗口。很容易，C++ 的基础&lt;/p&gt;

&lt;p&gt;把结果算平均值已经有人写好了 https://github.com/yeokm1/ssim&lt;/p&gt;

&lt;p&gt;直接把那段代码拿过来就能用&lt;/p&gt;

&lt;p&gt;我们用 gstreamer videotestsrc 来做视频源&lt;/p&gt;

&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;gst-launch-1.0 videotestsrc &lt;span class=&quot;o&quot;&gt;!&lt;/span&gt; videoconvert &lt;span class=&quot;o&quot;&gt;!&lt;/span&gt; autovideosink
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;然回用 webrtc 去发送这段视频&lt;/p&gt;

&lt;p&gt;可以用这个项目来发送视频 https://github.com/pion/webrtc/tree/master/examples/play-from-disk&lt;/p&gt;

&lt;p&gt;当然是可以使用 cgo 的。用go 去调用 gstreamer 。这样可以少一步图像转换
https://github.com/pion/example-webrtc-applications/tree/master/gstreamer-send&lt;/p&gt;

&lt;p&gt;然回另一端接收图像。保存成文件
https://github.com/pion/webrtc/tree/master/examples/save-to-disk&lt;/p&gt;

&lt;p&gt;之后把这个坨都放在 gitlab ci 里&lt;/p&gt;

&lt;p&gt;我最终输出的结果长这样：&lt;/p&gt;
&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&amp;lt; &amp;lt; &amp;lt; === END === &amp;gt; &amp;gt; &amp;gt;
Final Results
R 96.10% G 95.99% B 92.14%
Similarity = 94.74%
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;然回在 &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;Setting&lt;/code&gt; &amp;gt; &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;CI / CD&lt;/code&gt; &amp;gt; &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;General pipelines&lt;/code&gt; &amp;gt; &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;Test coverage parsing&lt;/code&gt; 里这样写：&lt;/p&gt;
&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;Similarity = \d+.\d+%
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;这样就把视频相识度结果输出到代码覆盖率上了（对于这种图像传输算相似度才有意义 （（（大雾&lt;/p&gt;</content><author><name>metal A-wing</name></author><category term="program" /><summary type="html">最近一直都在搞图像传输，webrtc 可以检测网络状况来调整码率。为了探究图像传输中损失了多少数据，用 opencv 来计算输入视频流和输出视频流的相似性</summary><media:thumbnail xmlns:media="http://search.yahoo.com/mrss/" url="https://a-wing.top/assets/avatar.png" /><media:content medium="image" url="https://a-wing.top/assets/avatar.png" xmlns:media="http://search.yahoo.com/mrss/" /></entry><entry><title type="html">MacBook Pro 初体验感想</title><link href="https://a-wing.top/linux/2019/10/01/macbookpro.html" rel="alternate" type="text/html" title="MacBook Pro 初体验感想" /><published>2019-10-01T08:00:00+00:00</published><updated>2019-10-01T08:00:00+00:00</updated><id>https://a-wing.top/linux/2019/10/01/macbookpro</id><content type="html" xml:base="https://a-wing.top/linux/2019/10/01/macbookpro.html">&lt;p&gt;&lt;img src=&quot;/assets/img/macbookpro/mbp.jpg&quot; alt=&quot;mbp&quot; /&gt;&lt;/p&gt;

&lt;p&gt;刚买了一台 2015 款的 macbook pro 。嗯，就是 MF839 的那款。正好来谈谈使用感想&lt;/p&gt;

&lt;h2 id=&quot;入手前准备&quot;&gt;入手前准备&lt;/h2&gt;
&lt;p&gt;最有效的资料是苹果官网的 &lt;a href=&quot;https://support.apple.com/zh-cn/HT201300&quot;&gt;macbook pro 机型&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;我当然是要买二手的机器了，干嘛要买新的（&lt;/p&gt;

&lt;p&gt;先选择买哪一款，然后去某宝的二手苹果商家卖家那里查价钱，多查几家，基本可以得出要买机型的市场价格。没问题的机器价格波动基本上在 5%&lt;/p&gt;

&lt;p&gt;不着急的话，去咸鱼上慢慢找。。。不够我实际观测，咸鱼上的二手苹果水极深&lt;/p&gt;

&lt;p&gt;要注意几点：&lt;/p&gt;
&lt;ol&gt;
  &lt;li&gt;价格波动基本上在 5% 以下，价钱过低都是有问题的&lt;/li&gt;
  &lt;li&gt;Macbook 整体造假成本很高，基本上没有假的。。。最多是防外观，基本上一眼就能看出&lt;/li&gt;
  &lt;li&gt;15 款以前的，硬盘可以更换，要注意机器上是否是原装硬盘&lt;/li&gt;
  &lt;li&gt;如果有条件最好拆后壳验机&lt;/li&gt;
  &lt;li&gt;华强北这方面很强，电池循环次数，序列号都是可以随便改的，电池循环一般都会改成一百多次，要注意测试实际的使用时间&lt;/li&gt;
  &lt;li&gt;如果对个人卖家面交，一定要当场联网测试。确认这个电脑是否是被偷来的&lt;/li&gt;
  &lt;li&gt;市场价格的职业卖家其实还是靠谱的&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;还有买二手电脑的基本操作我还是再啰嗦一遍吧：&lt;/p&gt;
&lt;ol&gt;
  &lt;li&gt;外观，这个不用说&lt;/li&gt;
  &lt;li&gt;检测键盘，每个键都要检查&lt;/li&gt;
  &lt;li&gt;检查屏幕是否有坏点，换壁纸或放图片，RGB 都要测&lt;/li&gt;
  &lt;li&gt;外设接口，USB，HDMI 都要测&lt;/li&gt;
  &lt;li&gt;拆后壳。。。保险起见&lt;/li&gt;
&lt;/ol&gt;

&lt;h2 id=&quot;工业设计&quot;&gt;工业设计&lt;/h2&gt;
&lt;p&gt;外观是无可挑剔的，配重刚刚好，一只手刚好完成开电脑的动作（我的 xps 需要两只手去把他掰开，这点我可以黑几年&lt;/p&gt;

&lt;p&gt;信仰的 apple logo 灯，前后相同的厚度。 我其实比较喜欢等厚度的设计&lt;/p&gt;

&lt;p&gt;首先苹果电脑里有个内置的 2G 的存储，里面装的是苹果的基本系统，用来联网安装 macos 的，其他的地方就和一般的 PC 一样了&lt;/p&gt;

&lt;p&gt;硬件上还有苹果的网卡比较特殊，毕竟要支持一些特殊的功能嘛，airdrop 之类的&lt;/p&gt;

&lt;p&gt;对了，还有这个机器漏电！！！充电的时候用会被电到&lt;/p&gt;

&lt;p&gt;内存是不可拆卸的，硬盘接口特殊，第三方硬盘要转接卡&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;还有就是那块 Retina 屏，看起来真的爽&lt;/strong&gt;&lt;/p&gt;

&lt;h2 id=&quot;macos&quot;&gt;MacOS&lt;/h2&gt;
&lt;p&gt;说到 mbp 最好用的地方，就是那块神奇的触摸板了。这个也太爽了，这块触摸板配合 macos 简直吊打一切其他笔记本的触摸板&lt;/p&gt;

&lt;p&gt;这块触摸板大概就是苹果笔记本的灵魂了&lt;/p&gt;

&lt;p&gt;icloud 联系人，日历的同步，默认做到很好&lt;/p&gt;

&lt;p&gt;还有用电脑直接就可以打 facetime ，这个简直超爽&lt;/p&gt;

&lt;p&gt;我最喜欢的是那个用 &lt;a href=&quot;https://support.apple.com/en-us/HT206995&quot;&gt;apple watch 来解锁的功能&lt;/a&gt;，我吹爆这个功能&lt;/p&gt;

&lt;p&gt;Finder 也很不错，当然最强大的要属 Spotlight 。。类似 kde 下的 krunner&lt;/p&gt;

&lt;p&gt;还想问一下苹果用 mbp 的各位，&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;command + c&lt;/code&gt; 和 &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;command + v&lt;/code&gt; 里那么近，平时应该用那个手指按比较好啊&lt;/p&gt;

&lt;p&gt;官方那个用 iPad 作为扩展屏的功能要 16 款之后的 MBP 才能支持&lt;/p&gt;

&lt;p&gt;MacOS 的 app store 里一堆软件都没有，安装其他来源软件的操作有点令人迷惑&lt;/p&gt;

&lt;p&gt;日常使用 MacOS 的时候内存占用大概为 4G 这里指一些基本应用，开个听歌的，开几个网页，不包括工作用的 。。。说好的优化那（&lt;/p&gt;

&lt;p&gt;iTerm2 还是很强大的，透明、模糊、连字。。。 都支持&lt;/p&gt;

&lt;p&gt;MacOS 的全屏，这个有点接受不了，最糟糕的地方是全屏没有壁纸，如果要全屏的应用设置了透明。。。全屏后背景是黑的。。&lt;/p&gt;

&lt;p&gt;那个邮件应用的图标很反人类。。。&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/img/macbookpro/desktop.jpg&quot; alt=&quot;mbp&quot; /&gt;
你能看出哪个是邮件程序吗？&lt;/p&gt;

&lt;h2 id=&quot;homebrew&quot;&gt;Homebrew&lt;/h2&gt;
&lt;p&gt;Homebrew 我没感觉这个哪里好用，同为包管理，Linux 下的包管理更好用&lt;/p&gt;

&lt;p&gt;我们来看一下 homebrew 的构建脚本 https://github.com/Homebrew/homebrew-core/blob/master/Formula/bat.rb&lt;/p&gt;

&lt;div class=&quot;language-ruby highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c1&quot;&gt;# https://github.com/Homebrew/homebrew-core/blob/master/Formula/bat.rb#L20&lt;/span&gt;

&lt;span class=&quot;nb&quot;&gt;system&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;cargo&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;install&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;--root&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;prefix&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;--path&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;.&quot;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;这里调用了外置命令 cargo 但并没有 makedepend 。。。抱歉不是很懂 homebrew ，也可能是吧 system 的第一个参数作为了 makedepend。。那问题来了。如果这个软件复杂，有拆包，如果有第二个参数控制是哪个扩展包，这个要怎么处理。。。&lt;/p&gt;

&lt;p&gt;homebrew bottle 是预编译分发软件仓库&lt;/p&gt;

&lt;p&gt;我对 Homebrew 包还是有些迷惑，好像所有的包都是静态编译的（&lt;/p&gt;

&lt;p&gt;更新都是绑定 MacOS 的版本进行更新的&lt;/p&gt;

&lt;p&gt;然后所有的版本都放一起，我还是觉得 debian 的 deb 仓库比这个优秀的多&lt;/p&gt;

&lt;h2 id=&quot;总结&quot;&gt;总结&lt;/h2&gt;
&lt;p&gt;&lt;strong&gt;最终总结就是：细节很完美，然而并没有什么卵用&lt;/strong&gt;&lt;/p&gt;

&lt;p&gt;8G 内存真的不够。。。作为主力机，建议直接上 16G&lt;/p&gt;

&lt;p&gt;默认配置很完美，可定制性差一些。。。也就是可以开箱即用&lt;/p&gt;

&lt;p&gt;如果你平时用 iphone , ipad 之类的苹果全家桶，那加上 mbp 还是很不错的。如果只有一个 mbp 就很没必要了。。。如果你正常用 Linux 无压力，Linux 也许是更好的选择&lt;/p&gt;</content><author><name>metal A-wing</name></author><category term="linux" /><summary type="html"></summary><media:thumbnail xmlns:media="http://search.yahoo.com/mrss/" url="https://a-wing.top/assets/avatar.png" /><media:content medium="image" url="https://a-wing.top/assets/avatar.png" xmlns:media="http://search.yahoo.com/mrss/" /></entry></feed>